<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockchain Diary - Share Life's Moments</title>
  <!-- External Resources -->
  <!-- Tailwind CSS - Production Optimized Version -->
  <script>
    // Disable production environment warnings
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            'primary/5': 'rgba(79, 70, 229, 0.05)',
            'primary/10': 'rgba(79, 70, 229, 0.1)',
            'primary/50': 'rgba(79, 70, 229, 0.5)',
            'primary/80': 'rgba(79, 70, 229, 0.8)',
            'primary/90': 'rgba(79, 70, 229, 0.9)'
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  <script>
    // Override production environment warnings
    console.warn = function() {
      if (arguments[0] && arguments[0].includes('cdn.tailwindcss.com should not be used in production')) {
        return;
      }
      console.log.apply(console, arguments);
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- Configure Tailwind Theme -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5', // Deep purple primary color
            secondary: '#ec4899', // Pink secondary color
            neutral: {
              50: '#fafafa',
              100: '#f5f5f5',
              200: '#e5e5e5',
              300: '#d4d4d4',
              600: '#525252',
              700: '#404040',
              800: '#262626',
              900: '#171717'
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Merriweather', 'Georgia', 'serif']
          }
        }
      }
    }
  </script>
  
  <!-- Custom Utility Classes -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .page-transition {
        transition: opacity 0.4s ease, transform 0.4s ease;
      }
      .nav-active {
        @apply text-primary border-primary;
      }
    }
  </style>
  
  <style>
    /* Base Styles */
    body {
      overflow-x: hidden;
      /* Ensure mobile devices can scroll normally */
      -webkit-overflow-scrolling: touch;
    }
    
    /* Mobile Optimization */
    @media (max-width: 768px) {
      /* Prevent modal content from exceeding screen */
      .modal-content,
      .diary-modal-content {
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Ensure mobile menu can scroll */
      #mobile-menu {
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Fix fixed positioning modal issues on mobile */
      .fixed {
        position: fixed;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      /* Ensure content is not covered by keyboard */
      input:focus,
      textarea:focus {
        position: relative;
        z-index: 1;
      }
      
      /* Optimize form container display on mobile */
      .page-container {
        padding-bottom: 80px; /* Leave space at the bottom */
      }
      
      /* Ensure publish button is always visible on mobile */
      #publish-btn {
        position: relative;
        z-index: 10;
      }
      
      /* Optimize padding and margin for mobile */
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      /* Adjust modal position on mobile */
      .diary-modal-content,
      .modal-content {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
      }
      
      /* Prevent horizontal scrolling */
      * {
        max-width: 100vw;
      }
      
      /* Optimize touch experience on mobile */
      button,
      a,
      .clickable {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      /* Ensure diary grid displays properly on mobile */
      #diaries-grid,
      #private-diaries-grid,
      #featured-diaries-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Adjust featured diary display on mobile */
      .featured-diary-card {
        padding: 1rem;
      }
      
      /* Ensure statistics cards stack properly on mobile */
      .grid {
        grid-template-columns: 1fr;
      }
      
      /* Optimize text size for mobile */
      h1 {
        font-size: 1.875rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      h3 {
        font-size: 1.25rem;
      }
      
      /* Ensure sufficient scroll space at bottom */
      main {
        padding-bottom: 2rem;
      }
    }
    
    /* Page Container Styles */
    .page-container {
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }
    
    .page-container.active {
      display: block;
      animation: pageIn 0.5s forwards;
    }
    
    @keyframes pageIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Navigation underline animation */
    .nav-link {
      position: relative;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #4f46e5;
      transition: width 0.3s ease;
    }
    
    .nav-link.nav-active::after {
      width: 100%;
    }
    
    /* Mobile navigation link styles */
    .mobile-nav-link {
      color: #525252;
      transition: all 0.3s ease;
    }
    
    .mobile-nav-link.nav-active {
      background-color: #4f46e510;
      color: #4f46e5;
    }
    
    /* Diary card hover effect */
    .diary-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .diary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    /* Filter button styles */
    .filter-btn {
      transition: all 0.3s ease;
    }
    
    .filter-btn.active {
      background-color: #4f46e5;
      color: white;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* Beautiful wallet connect button */
    .wallet-btn {
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .wallet-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .wallet-btn:hover::before {
      left: 100%;
    }

    .wallet-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .wallet-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Connection status styles */
    .wallet-btn.connected {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .wallet-btn.connected:hover {
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
    }

    .wallet-btn.disconnected {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .wallet-btn.disconnected:hover {
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
    }

    .wallet-btn.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }

    .wallet-btn.error:hover {
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
    }

    /* Wallet icon animation */
    .wallet-btn .wallet-icon {
      transition: transform 0.3s ease;
    }

    .wallet-btn:hover .wallet-icon {
      transform: scale(1.1);
    }

    .wallet-btn.connected .wallet-icon {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Status indicator */
    .wallet-status-indicator {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      transition: all 0.3s ease;
    }

    .wallet-status-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .wallet-status-indicator.disconnected {
      background: #f59e0b;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    .wallet-status-indicator.error {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    /* Loading animation */
    .wallet-btn.loading {
      pointer-events: none;
    }

    .wallet-btn.loading .wallet-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Mobile adaptation */
    @media (max-width: 768px) {
      .wallet-btn {
        padding: 10px 20px;
        font-size: 13px;
        min-width: 120px;
      }
    }

    /* Beautiful tag selection styles */
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .tag-item {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #64748b;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      min-width: 60px;
      justify-content: center;
    }

    .tag-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .tag-item:hover::before {
      left: 100%;
    }

    .tag-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .tag-item input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Tag selected state */
    .tag-item.checked {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      border-color: #4f46e5;
      box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
      transform: translateY(-1px);
    }

    .tag-item.checked::after {
      content: '✓';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      animation: checkmark 0.3s ease forwards;
    }

    @keyframes checkmark {
      0% {
        opacity: 0;
        transform: translateY(-50%) scale(0.5);
      }
      100% {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    }

    /* Different tag color themes */
    .tag-item[data-tag="Life"] {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-color: #fbbf24;
    }

    .tag-item[data-tag="Life"].checked {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: #f59e0b;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
    }

    .tag-item[data-tag="Travel"] {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
      border-color: #3b82f6;
    }

    .tag-item[data-tag="Travel"].checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .tag-item[data-tag="Reflection"] {
      background: linear-gradient(135deg, #e9d5ff 0%, #c084fc 100%);
      color: #7c3aed;
      border-color: #a855f7;
    }

    .tag-item[data-tag="Reflection"].checked {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: white;
      border-color: #a855f7;
      box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3);
    }

    .tag-item[data-tag="Reading"] {
      background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);
      color: #166534;
      border-color: #22c55e;
    }

    .tag-item[data-tag="Reading"].checked {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      border-color: #22c55e;
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
    }

    .tag-item[data-tag="Work"] {
      background: linear-gradient(135deg, #f3e8ff 0%, #c4b5fd 100%);
      color: #6b21a8;
      border-color: #8b5cf6;
    }

    .tag-item[data-tag="Work"].checked {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-color: #8b5cf6;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
    }

    .tag-item[data-tag="Food"] {
      background: linear-gradient(135deg, #fed7d7 0%, #fca5a5 100%);
      color: #991b1b;
      border-color: #ef4444;
    }

    .tag-item[data-tag="Food"].checked {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-color: #ef4444;
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
    }

    /* Tag selector container */
    .tag-selector-container {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }

    .tag-selector-container label {
      color: #475569;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 16px;
      display: block;
    }

    /* Responsive design */
    @media (max-width: 640px) {
      .tag-selector {
        gap: 8px;
      }
      
      .tag-item {
        padding: 6px 12px;
        font-size: 13px;
        min-width: 50px;
      }
    }

    /* Beautiful diary detail modal styles */
    .diary-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    .diary-modal-content {
      animation: modalSlideIn 0.3s ease-out;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      isolation: isolate;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes modalFadeOut {
      from { 
        opacity: 1;
      }
      to { 
        opacity: 0;
      }
    }

    /* Diary card hover effect */
    .diary-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .diary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      border-color: #4f46e5;
    }

    /* Read more button styles */
    .read-more-btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .read-more-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
      transition: left 0.5s;
    }

    .read-more-btn:hover::before {
      left: 100%;
    }

    .read-more-btn:hover {
      transform: translateX(4px);
    }

    /* Modal content styles */
    .diary-content {
      line-height: 1.8;
      font-size: 16px;
      color: #374151;
    }

    .diary-title {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Blockchain information styles */
    .blockchain-info {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #0ea5e9;
      border-radius: 12px;
    }

    .blockchain-info.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-color: #ef4444;
    }

    /* Chat comment styles */
    .chat-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 24px;
    }

    .comments-container {
      scrollbar-width: thin;
      scrollbar-color: #d1d5db #f3f4f6;
      display: flex;
      flex-direction: column;
      position: relative;
      scroll-behavior: smooth;
      overflow-y: auto;
      overflow-x: hidden;
      isolation: isolate;
    }

    .comments-container::-webkit-scrollbar {
      width: 6px;
    }

    .comments-container::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 3px;
    }

    .comments-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .comments-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* WeChat-style chat area */
    .chat-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 24px;
      display: flex;
      flex-direction: column;
      height: 500px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    
    @media (max-width: 768px) {
      .chat-section {
        height: 350px; /* Mobile height adjustment */
        padding-top: 16px;
      }
    }

    .chat-header {
      flex-shrink: 0;
      margin-bottom: 16px;
    }

    .chat-messages {
      flex: 1;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    .chat-input-area {
      flex-shrink: 0;
      margin-top: 16px;
    }



    /* WeChat-style message layout */
    .comments-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .comment-item {
      background: #f0f9ff;
      border: 1px solid #e0f2fe;
      border-radius: 18px;
      padding: 12px 16px;
      margin-bottom: 8px;
      position: relative;
      max-width: 85%;
      align-self: flex-start;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .comment-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 6px solid #f0f9ff;
    }

    .comment-item::after {
      content: '';
      position: absolute;
      left: -7px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 6px solid #e0f2fe;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comment-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      flex-shrink: 0;
    }

    .comment-meta {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .comment-author-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .comment-time {
      font-size: 11px;
      color: #6b7280;
    }

    .comment-content {
      color: #1f2937;
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
      word-break: break-word;
    }

    .comment-input-section textarea {
      transition: all 0.2s ease;
    }

    .comment-input-section textarea:focus {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .send-comment-btn {
      transition: all 0.2s ease;
    }

    .send-comment-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-comment-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* Profile button styles */
    .profile-btn {
      position: relative;
      overflow: hidden;
    }

    .profile-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(79, 70, 229, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .profile-btn:active::before {
      width: 40px;
      height: 40px;
    }

    .profile-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Wallet button disconnect styles */
    .wallet-btn.connected {
      position: relative;
    }

    .wallet-btn.connected::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
      animation: pulse 2s infinite;
    }

    .wallet-btn.connected:hover::after {
      background: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    /* Disconnect menu styles */
    #disconnect-menu {
      animation: menuSlideIn 0.2s ease-out;
    }
    
    @media (max-width: 768px) {
      #disconnect-menu {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: auto;
        top: auto;
        max-width: 90vw;
      }
    }

    @keyframes menuSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Avatar upload styles */
    #avatar-preview {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #avatar-preview.has-image {
      background-image: none;
    }

    #avatar-preview.has-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    /* Profile modal animation */
    #profile-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    #profile-modal .bg-white {
      animation: modalSlideIn 0.3s ease-out;
    }

    /* User profile view modal animation */
    #user-profile-view-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    #user-profile-view-modal .bg-white {
      animation: modalSlideIn 0.3s ease-out;
    }

    /* WeChat-style input area */
    .chat-input-area {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      border-radius: 0 0 12px 12px;
    }

    .chat-input-area textarea {
      border-radius: 20px;
      border: 1px solid #d1d5db;
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      transition: all 0.2s ease;
    }

    .chat-input-area textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .chat-input-area button {
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .chat-input-area button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* Comment loading animation */
    .comment-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #6b7280;
    }

    .comment-loading i {
      animation: spin 1s linear infinite;
    }

    /* Like button styles */
    .like-btn {
      position: relative;
      overflow: hidden;
    }

    .like-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .like-btn:active::before {
      width: 40px;
      height: 40px;
    }

    .like-btn.liked {
      color: #ef4444;
    }

    .like-btn.liked i {
      animation: heartBeat 0.6s ease;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .modal-like-btn {
      position: relative;
      overflow: hidden;
    }

    .modal-like-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .modal-like-btn:active::before {
      width: 60px;
      height: 60px;
    }

    .modal-like-btn.liked {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .modal-like-btn.liked i {
      animation: heartBeat 0.6s ease;
    }

    /* Featured diary styles */
    .featured-diary-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .featured-diary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    }

    .featured-diary-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      border-color: #f59e0b;
    }

    .featured-diary-card.rank-1::before {
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
    }

    .featured-diary-card.rank-2::before {
      background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%);
    }

    .featured-diary-card.rank-3::before {
      background: linear-gradient(90deg, #d97706 0%, #b45309 100%);
    }

    .featured-rank-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
    }

    .featured-rank-badge.rank-1 {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .featured-rank-badge.rank-2 {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }

    .featured-rank-badge.rank-3 {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
    }

    .featured-diary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .featured-diary-content {
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 16px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .featured-diary-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #9ca3af;
    }

    .featured-diary-stats {
      display: flex;
      gap: 16px;
    }

    .featured-diary-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .featured-diary-stat.likes {
      color: #ef4444;
    }

    .featured-diary-stat.comments {
      color: #3b82f6;
    }

    .featured-diary-author {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.75rem;
    }

    .featured-diary-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.875rem;
      overflow: hidden;
    }

    .featured-diary-author-info {
      flex: 1;
    }

    .featured-diary-author-name {
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }

    .featured-diary-time {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.125rem;
    }

    /* Custom radio button styles */
    .custom-radio {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .custom-radio.checked {
      border-color: #4f46e5;
      background-color: #4f46e5;
    }

    .custom-radio.checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background-color: white;
      border-radius: 50%;
    }

    .custom-radio:hover {
      border-color: #4f46e5;
      transform: scale(1.05);
    }
  </style>
</head>

<body class="bg-neutral-50 font-sans text-neutral-800">
  <!-- Navigation Bar -->
  <header class="sticky top-0 z-40 bg-white shadow-sm border-b border-neutral-200">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16 md:h-20">
        <!-- Logo -->
        <a href="#" class="flex items-center space-x-2 page-link" data-page="home">
          <img src="1.png" alt="Logo" class="w-8 h-8 object-contain rounded-full">
          <span class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">Blockchain Diary Time</span>
        </a>
        
        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center space-x-8">
          <a href="#" class="nav-link nav-active text-neutral-800 font-medium transition-colors" data-page="home">Home</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="upload">Write Diary</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="public">Public Diaries</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="private">My Diaries</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="stats">Statistics</a>
        </nav>
        
        <!-- User Area -->
        <div class="flex items-center space-x-4">
          <button id="wallet-btn" class="wallet-btn disconnected hidden md:flex">
            <i class="fa fa-wallet wallet-icon"></i>
            <span id="wallet-text">Connect Wallet</span>
            <div id="wallet-status" class="wallet-status-indicator disconnected"></div>
          </button>
          
          <!-- Profile Settings Button -->
          <button id="profile-btn" class="profile-btn hidden md:flex items-center px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 font-medium transition-all shadow-lg hover:shadow-xl hover:bg-neutral-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <div class="profile-icon mr-2">
              <i class="fa fa-user"></i>
            </div>
            <span>Profile</span>
          </button>
          
          <!-- Mobile Menu Button -->
          <button id="mobile-menu-btn" class="md:hidden text-neutral-700">
            <i class="fa fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Mobile Navigation Menu -->
    <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-neutral-200">
      <div class="container mx-auto px-4 py-3">
        <div class="flex flex-col space-y-4 py-2">
          <a href="#" class="mobile-nav-link nav-active py-2 px-3 rounded-lg" data-page="home">
            <i class="fa fa-home mr-2"></i>Home
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="upload">
            <i class="fa fa-pencil mr-2"></i>Write Diary
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="public">
            <i class="fa fa-book mr-2"></i>Public Diaries
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="private">
            <i class="fa fa-lock mr-2"></i>My Diaries
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="stats">
            <i class="fa fa-bar-chart mr-2"></i>Statistics
          </a>
          <!-- Mobile Profile Button -->
          <button id="mobile-profile-btn" class="w-full py-2 px-3 rounded-lg bg-neutral-100 text-neutral-700 font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed text-left" disabled>
            <i class="fa fa-user mr-2"></i>Profile
          </button>
          <button id="mobile-wallet-btn" class="wallet-btn disconnected flex items-center justify-center mt-2">
            <i class="fa fa-wallet wallet-icon"></i>
            <span id="mobile-wallet-text">Connect Wallet</span>
            <div id="mobile-wallet-status" class="wallet-status-indicator disconnected"></div>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="min-h-[calc(100vh-4rem)] pt-1">
    <!-- Home Page -->
    <section id="home" class="page-container active">
      <!-- Hero Section -->
      <div class="relative bg-gradient-to-br from-primary/5 to-secondary/5 py-20 md:py-32 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10">
          <i class="fa fa-pencil absolute top-20 right-20 text-[150px] text-primary"></i>
          <i class="fa fa-book absolute bottom-10 left-10 text-[120px] text-secondary"></i>
        </div>
        
        <div class="container mx-auto px-4 relative z-10">
          <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-neutral-800 leading-tight mb-6">
              Record your <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">Blockchain Moments</span>
            </h1>
            <p class="text-lg md:text-xl text-neutral-700 mb-10 leading-relaxed max-w-2xl mx-auto">
              A decentralized diary platform based on blockchain technology. Every word you write is permanently stored on-chain. You can share publicly or keep it private—your true digital memory.
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
              <a href="#" class="page-link px-8 py-4 bg-primary text-white rounded-full hover:bg-primary/90 transition-all shadow-lg hover:shadow-xl font-medium text-lg" data-page="upload">
                <i class="fa fa-pencil mr-2"></i>Start Writing
              </a>
              <a href="#" class="page-link px-8 py-4 bg-white text-primary border border-primary rounded-full hover:bg-primary/5 transition-all shadow-md hover:shadow-lg font-medium text-lg" data-page="public">
                <i class="fa fa-eye mr-2"></i>Browse Diaries
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Features -->
      <div class="py-16 bg-white">
        <div class="container mx-auto px-4">
          <div class="text-center mb-16">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 mb-4">Why Choose Us</h2>
            <p class="text-neutral-600 max-w-2xl mx-auto">A simple and elegant diary experience that makes writing a pleasure</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-pencil-square-o text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Easy Writing</h3>
              <p class="text-neutral-600">A clean and intuitive editor lets you focus on your content and capture inspiration anytime, anywhere.</p>
            </div>
            
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-share-alt text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Share & Connect</h3>
              <p class="text-neutral-600">Choose to make your diary public and connect with like-minded people. Discover more perspectives on life.</p>
            </div>
            
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-bar-chart text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Data Insights</h3>
              <p class="text-neutral-600">Understand your writing habits through data, discover your creative patterns, and continuously improve your diary quality.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Featured Diaries -->
      <div class="py-16 bg-neutral-50">
        <div class="container mx-auto px-4">
          <div class="flex justify-between items-end mb-10">
            <div>
              <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 mb-2">Featured Diaries</h2>
              <p class="text-neutral-600">Discover the most popular and exciting content in the community</p>
            </div>
            <a href="#" class="page-link text-primary hover:text-primary/80 font-medium hidden md:block" data-page="public">
              View All <i class="fa fa-arrow-right ml-1"></i>
            </a>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto" id="featured-diaries-grid">
            <!-- Featured diary cards will be generated dynamically by JavaScript -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-spinner fa-spin text-neutral-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-medium text-neutral-600 mb-2">Loading featured diaries...</h3>
              <p class="text-neutral-500">Fetching the most popular diaries</p>
            </div>
          </div>
          
          <div class="text-center mt-8 md:hidden">
            <a href="#" class="page-link inline-block px-5 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors" data-page="public">
              View More Diaries
            </a>
          </div>
        </div>
      </div>
      
      <!-- Call to Action -->
      <div class="py-16 bg-gradient-to-r from-primary to-primary/80 text-white">
        <div class="container mx-auto px-4 text-center">
          <h2 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold mb-6">Start Recording Your Story</h2>
          <p class="max-w-2xl mx-auto mb-8 text-white/90 text-lg">
            Every experience is worth remembering, and every thought is worth recording. Join us, share your daily moments.
          </p>
          <a href="#" class="page-link inline-flex items-center px-8 py-4 bg-white text-primary rounded-full hover:bg-neutral-100 transition-all shadow-lg font-medium text-lg" data-page="upload">
            <i class="fa fa-pencil-square-o mr-2"></i>Write Diary Now
          </a>
        </div>
      </div>
    </section>

    <!-- Write Diary Page -->
    <section id="upload" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-pencil-square-o text-primary mr-2"></i>Write Down Your Diary
            </h1>
            <p class="text-neutral-600">Record your thoughts, reflections, and beautiful moments in life, leaving your unique mark</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8 border border-neutral-200">
            <form id="diary-form" class="space-y-6">
              <!-- Title Input -->
              <div>
                <label for="diary-title" class="block text-sm font-medium text-neutral-700 mb-1">Diary Title</label>
                <input 
                  type="text" 
                  id="diary-title" 
                  class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg"
                  placeholder="Give your diary a title..."
                  required
                >
              </div>
              
              <!-- Tag Selection -->
              <div class="tag-selector-container">
                <label>Select Tags (Multi-select)</label>
                <div class="tag-selector">
                  <label class="tag-item" data-tag="Life">
                    <input type="checkbox" name="tags" value="Life">
                    <span>Life</span>
                  </label>
                  <label class="tag-item" data-tag="Travel">
                    <input type="checkbox" name="tags" value="Travel">
                    <span>Travel</span>
                  </label>
                  <label class="tag-item" data-tag="Reflection">
                    <input type="checkbox" name="tags" value="Reflection">
                    <span>Reflection</span>
                  </label>
                  <label class="tag-item" data-tag="Reading">
                    <input type="checkbox" name="tags" value="Reading">
                    <span>Reading</span>
                  </label>
                  <label class="tag-item" data-tag="Work">
                    <input type="checkbox" name="tags" value="Work">
                    <span>Work</span>
                  </label>
                  <label class="tag-item" data-tag="Food">
                    <input type="checkbox" name="tags" value="Food">
                    <span>Food</span>
                  </label>
                </div>
              </div>
              
              <!-- Diary Content -->
              <div>
                <label for="diary-content" class="block text-sm font-medium text-neutral-700 mb-1">Diary Content</label>
                <textarea 
                  id="diary-content" 
                  rows="10" 
                  class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
                  placeholder="What happened today? What do you want to record?"
                  required
                ></textarea>
                <div class="flex justify-between items-center mt-2 text-sm text-neutral-500">
                  <span id="char-count">0 characters</span>
                  <button type="button" id="clear-content" class="hover:text-primary transition-colors">
                    <i class="fa fa-eraser mr-1"></i>Clear
                  </button>
                </div>
              </div>
              
              <!-- Privacy Settings -->
              <div class="pt-2">
                <label class="block text-sm font-medium text-neutral-700 mb-2">Privacy Settings</label>
                <div class="flex items-center space-x-6">
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="privacy" value="public" class="sr-only" checked>
                    <div class="custom-radio checked mr-2"></div>
                    <span class="font-semibold text-primary">Public - Everyone can see, stored on blockchain</span>
                  </label>
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="privacy" value="private" class="sr-only">
                    <div class="custom-radio mr-2"></div>
                    <span>Private - Only you can see, encrypted storage</span>
                  </label>
                </div>
                <p class="text-xs text-neutral-500 mt-2">
                  <i class="fa fa-info-circle mr-1"></i>
                  All diaries will be stored on the blockchain, private diaries will use your wallet address for encryption
                </p>
              </div>
              
              <!-- Wallet Connection Prompt -->
              <div id="wallet-warning" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <div class="flex items-center">
                  <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                  <span class="text-amber-700">Please connect your wallet to publish to the blockchain</span>
                </div>
              </div>
              
              <!-- Blockchain Option -->
              <div class="pt-2">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="enable-blockchain" class="sr-only peer" checked>
                  <div class="relative w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  <span class="ml-3 text-sm font-medium text-neutral-700">
                    Try storing on blockchain 
                    <span class="text-xs text-neutral-500">(will still save to database if fails)</span>
                  </span>
                </label>
              </div>
              
              <!-- Submit Button -->
              <div class="pt-4 flex flex-col sm:flex-row gap-4">
                <button 
                  type="submit" 
                  id="publish-btn"
                  class="flex-1 px-6 py-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow-md font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fa fa-paper-plane mr-2"></i>
                  <span id="publish-text">Publish Diary</span>
                  <div id="publish-spinner" class="hidden ml-2">
                    <i class="fa fa-spinner fa-spin"></i>
                  </div>
                </button>
                <button 
                  type="button" 
                  id="draft-btn"
                  class="flex-1 px-6 py-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-all font-medium flex items-center justify-center"
                >
                  <i class="fa fa-save mr-2"></i>Save Draft
                </button>
              </div>
            </form>
          </div>
          
          <!-- Writing Tips -->
          <div class="mt-10 bg-neutral-50 rounded-xl p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
              <i class="fa fa-lightbulb-o text-primary mr-2"></i>Writing Tips
            </h3>
            <ul class="space-y-2 text-neutral-700">
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>Use specific details and feelings to describe, making your diary more vivid</span>
              </li>
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>You can record what happened today or write about your thoughts on something</span>
              </li>
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>Choosing the right tags can make your diary more visible to others</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Public Diaries Page -->
    <section id="public" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
                      <div class="flex items-center justify-between mb-2">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800">
            <i class="fa fa-book text-primary mr-2"></i>Public Diaries
          </h1>
            <div class="flex items-center gap-2">
              <div class="flex items-center text-sm text-neutral-500 bg-neutral-100 px-3 py-1 rounded-full">
                <i class="fa fa-heart text-red-500 mr-1"></i>
                Order by Likes
              </div>
              <div id="public-diary-count" class="text-sm text-neutral-500 bg-neutral-100 px-3 py-1 rounded-full">
                <span id="filtered-count">0</span> diaries
              </div>
            </div>
          </div>
            <p class="text-neutral-600">Browse community members' exciting diary entries, experiencing different perspectives and ways of thinking</p>
          </div>
          
          <!-- Filter and Search -->
          <div class="bg-white rounded-xl shadow-sm p-4 mb-8 border border-neutral-200">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm" data-filter="all">
                  All
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Life">
                  Life
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Travel">
                  Travel
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Reflection">
                  Reflection
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Reading">
                  Reading
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Work">
                  Work
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors" data-filter="Food">
                  Food
                </button>
              </div>
              
              <div class="relative w-full md:w-auto">
                <input 
                  type="text" 
                  id="public-search-input"
                  placeholder="Search diary content..." 
                  class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                >
                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400"></i>
                <button id="clear-search-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 hover:text-neutral-600 transition-colors hidden">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Diary List -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- No content prompt -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-book-o text-neutral-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-medium text-neutral-600 mb-2">No public diaries yet</h3>
              <p class="text-neutral-500 mb-4">Be the first to share your diary!</p>
              <a href="#" class="page-link px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" data-page="upload">
                <i class="fa fa-pencil mr-2"></i>Write Your First Diary
              </a>
            </div>
          </div>
          
          <!-- Pagination -->
          <div class="mt-12 flex justify-center hidden">
            <nav class="flex items-center space-x-1">
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa fa-angle-left"></i>
              </button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white">1</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">2</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">3</button>
              <span class="w-10 h-10 flex items-center justify-center">...</span>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">8</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">
                <i class="fa fa-angle-right"></i>
              </button>
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- Private Diaries Page -->
    <section id="private" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-lock text-primary mr-2"></i>My Private Diaries
            </h1>
            <p class="text-neutral-600">View your private diaries, these contents are only visible to you, and the data is encrypted and stored on the blockchain</p>
          </div>
          
          <!-- Wallet Connection Prompt -->
          <div id="private-wallet-warning" class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <i class="fa fa-exclamation-triangle text-amber-500 text-xl mr-3"></i>
                <div>
                  <h3 class="font-medium text-amber-800">Wallet Connection Required</h3>
                  <p class="text-amber-700 text-sm mt-1">Please connect your wallet to view private diaries</p>
                </div>
              </div>
              <button id="private-connect-wallet" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">
                Connect Wallet
              </button>
            </div>
          </div>
          
          <!-- Filter and Search -->
          <div id="private-controls" class="bg-white rounded-xl shadow-sm p-4 mb-8 border border-neutral-200 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm">
                  All
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  Life
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  Reflection
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  Work
                </button>
              </div>
              
              <div class="relative w-full md:w-auto">
                <input 
                  type="text" 
                  placeholder="Search my diaries..." 
                  class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                >
                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400"></i>
              </div>
            </div>
          </div>
          
          <!-- Private Diary List -->
          <div id="private-diary-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- Diary cards will be generated dynamically by JavaScript -->
          </div>
          
          <!-- Empty State -->
          <div id="private-empty-state" class="flex flex-col items-center justify-center py-16 text-center hidden">
            <i class="fa fa-lock text-neutral-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-medium text-neutral-600 mb-2">No private diaries yet</h3>
            <p class="text-neutral-500 mb-4">Write your first private diary</p>
            <a href="#" class="page-link px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" data-page="upload">
              <i class="fa fa-pencil mr-2"></i>Write Diary
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Statistics Page -->
    <section id="stats" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-bar-chart text-primary mr-2"></i>Community Data Statistics
            </h1>
            <p class="text-neutral-600">Explore our community's activity and content distribution, see what everyone is recording and sharing</p>
          </div>
          
          <!-- Overview -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">Total Diaries</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="total-diaries">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-book text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>No data yet</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">Active Users</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="active-users">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-users text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>No data yet</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">Public Diaries</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="public-diaries">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-eye text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>No data yet</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">Total Comments</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="total-comments">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-comments text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>No data yet</span>
              </div>
            </div>
          </div>
          
          <!-- Chart Area -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <!-- Tag Distribution Chart -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 lg:col-span-1">
              <h3 class="text-lg font-semibold mb-6">Popular Tag Distribution</h3>
              <div class="h-80 flex items-center justify-center">
                <div class="text-center">
                  <i class="fa fa-pie-chart text-neutral-300 text-6xl mb-4"></i>
                  <p class="text-neutral-500">No data available for display</p>
              </div>
              </div>
            </div>
            
            <!-- Monthly Activity Chart -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 lg:col-span-2">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">Monthly Activity Trend</h3>
                <div class="flex space-x-2">
                  <button class="px-3 py-1 text-sm rounded-full bg-primary/10 text-primary">Monthly</button>
                  <button class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition-colors">Quarterly</button>
                  <button class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition-colors">Annual</button>
                </div>
              </div>
              <div class="h-80 flex items-center justify-center">
                <div class="text-center">
                  <i class="fa fa-line-chart text-neutral-300 text-6xl mb-4"></i>
                  <p class="text-neutral-500">No data available for display</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Activity Analysis -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 mb-10">
            <h3 class="text-lg font-semibold mb-6">User Activity Time Analysis</h3>
            <div class="h-80 flex items-center justify-center">
              <div class="text-center">
                <i class="fa fa-bar-chart text-neutral-300 text-6xl mb-4"></i>
                <p class="text-neutral-500">No data available for display</p>
            </div>
            </div>
          </div>
          
          <!-- Popular Diaries Ranking -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold mb-6">Popular Diaries Ranking</h3>
            <div class="flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-trophy text-neutral-300 text-6xl mb-4"></i>
              <h4 class="text-xl font-medium text-neutral-600 mb-2">No popular diaries yet</h4>
              <p class="text-neutral-500">Waiting for community members to create exciting content</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Profile Settings Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden flex flex-col max-h-[90vh]">
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">Profile Settings</h2>
          <button id="close-profile-modal" class="text-white hover:text-white/80 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <!-- Modal Content Area (scrollable) -->
      <div class="flex-1 overflow-y-auto px-6 py-4" id="profile-form-scroll">
        <form id="profile-form" class="space-y-6">
          <!-- Avatar Upload -->
          <div class="text-center">
            <div class="relative inline-block">
              <div id="avatar-preview" class="w-24 h-24 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4 cursor-pointer hover:opacity-80 transition-opacity">
                <i class="fa fa-user"></i>
              </div>
              <input type="file" id="avatar-upload" accept="image/*" class="hidden">
              <button type="button" id="upload-avatar-btn" class="absolute bottom-0 right-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary/90 transition-colors">
                <i class="fa fa-camera text-sm"></i>
              </button>
            </div>
            <p class="text-sm text-neutral-500">Click on the avatar to upload a new image</p>
          </div>
          <!-- Username -->
          <div>
            <label for="profile-username" class="block text-sm font-medium text-neutral-700 mb-2">Username</label>
            <input 
              type="text" 
              id="profile-username" 
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
              placeholder="Enter your username"
              maxlength="20"
              required
            >
            <p class="text-xs text-neutral-500 mt-1">Username will be displayed in diaries and comments</p>
          </div>
          <!-- Bio -->
          <div>
            <label for="profile-bio" class="block text-sm font-medium text-neutral-700 mb-2">Bio</label>
            <textarea 
              id="profile-bio" 
              rows="3" 
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
              placeholder="Introduce yourself..."
              maxlength="200"
            ></textarea>
            <div class="flex justify-between items-center mt-1">
              <p class="text-xs text-neutral-500">Bio will be displayed on your personal page</p>
              <span id="bio-char-count" class="text-xs text-neutral-400">0/200</span>
            </div>
          </div>
          <!-- Wallet Address Display -->
          <div class="bg-neutral-50 rounded-lg p-4">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Wallet Address</label>
            <div class="flex items-center justify-between">
              <span id="profile-wallet-address" class="text-sm text-neutral-600 font-mono">Wallet not connected</span>
              <button type="button" id="copy-wallet-btn" class="text-primary hover:text-primary/80 transition-colors">
                <i class="fa fa-copy"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <!-- Button Area sticky -->
      <div class="px-6 py-4 border-t flex-shrink-0 bg-white sticky bottom-0 z-10 flex gap-3">
        <button type="button" id="cancel-profile-btn" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
          Cancel
        </button>
        <button type="submit" form="profile-form" id="save-profile-btn" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
          Save Profile
        </button>
      </div>
    </div>
  </div>

  <!-- User Profile View Modal -->
  <div id="user-profile-view-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">User Profile</h2>
          <button id="close-user-profile-view-modal" class="text-white hover:text-white/80 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <!-- Modal Content -->
      <div class="p-6">
        <div class="space-y-6">
          <!-- Avatar Display -->
          <div class="text-center">
            <div id="view-avatar" class="w-24 h-24 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4">
              <i class="fa fa-user"></i>
            </div>
          </div>
          
          <!-- Username -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Username</label>
            <div id="view-username" class="w-full px-4 py-3 rounded-lg bg-neutral-50 border border-neutral-200 text-neutral-800">
              Loading...
          </div>
        </div>
          
          <!-- Bio -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">Bio</label>
            <div id="view-bio" class="w-full px-4 py-3 rounded-lg bg-neutral-50 border border-neutral-200 text-neutral-800 min-h-[4.5rem]">
              Loading...
      </div>
          </div>
          
          <!-- Wallet Address Display -->
          <div class="bg-neutral-50 rounded-lg p-4">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Wallet Address</label>
            <div class="flex items-center justify-between">
              <span id="view-wallet-address" class="text-sm text-neutral-600 font-mono">Loading...</span>
              <button type="button" id="copy-view-wallet-btn" class="text-primary hover:text-primary/80 transition-colors">
                <i class="fa fa-copy"></i>
              </button>
            </div>
          </div>
          
          <!-- Close Button -->
          <div class="pt-4">
            <button type="button" id="close-user-profile-view-btn" class="w-full px-4 py-3 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors font-medium">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>


  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full transform transition-transform duration-300 scale-95">
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-check text-2xl text-green-500"></i>
        </div>
        <h3 class="text-xl font-bold text-neutral-800 mb-2">Success!</h3>
        <p class="text-neutral-600 mb-6">Your diary has been successfully published to the community!</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
            View My Diary
          </button>
          <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
            Return to Home
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Configuration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, limitToLast, orderByChild, equalTo, get, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
      authDomain: "chat-294cc.firebaseapp.com",
      databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
      projectId: "chat-294cc",
      storageBucket: "chat-294cc.firebasestorage.app",
      messagingSenderId: "913615304269",
      appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
      measurementId: "G-SJR9NDW86B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables
    let currentWallet = '';
    let allDiaries = [];
    let connection;
    let userProfiles = {}; // User profile cache
    let currentUserProfile = null; // Current user profile

    // Solana Connection Configuration - Using stable RPC endpoints
    const rpcEndpoints = [
      'https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/',
      'https://solana-api.projectserum.com',
      'https://rpc.ankr.com/solana',
      'https://api.mainnet-beta.solana.com'
    ];
    
    // Try to connect to an available RPC endpoint
    async function initializeConnection() {
      for (const endpoint of rpcEndpoints) {
        try {
          console.log(`Trying to connect to: ${endpoint}`);
          const testConnection = new solanaWeb3.Connection(endpoint, 'confirmed');
          // Test connection
          await testConnection.getSlot();
          connection = testConnection;
          console.log(`Successfully connected to: ${endpoint}`);
          return true;
        } catch (error) {
          console.log(`Connection failed: ${endpoint}`, error.message);
          continue;
        }
      }
      console.error('All RPC endpoints failed to connect');
      return false;
    }

    // Update wallet UI
    function updateWalletUI(connected) {
      const walletBtn = document.getElementById('wallet-btn');
      const walletText = document.getElementById('wallet-text');
      const walletStatus = document.getElementById('wallet-status');
      const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
      const mobileWalletText = document.getElementById('mobile-wallet-text');
      const mobileWalletStatus = document.getElementById('mobile-wallet-status');
      const profileBtn = document.getElementById('profile-btn');
      
      if (connected && currentWallet) {
        const shortAddr = currentWallet.slice(0, 4) + '...' + currentWallet.slice(-4);
        
        // Update button state
        walletBtn.className = 'wallet-btn connected hidden md:flex';
        mobileWalletBtn.className = 'wallet-btn connected flex items-center justify-center mt-2';
        
        // Update text
        walletText.textContent = shortAddr;
        mobileWalletText.textContent = shortAddr;
        
        // Update status indicator
        walletStatus.className = 'wallet-status-indicator connected';
        mobileWalletStatus.className = 'wallet-status-indicator connected';
        
        // Set status based on network connection
        if (connection) {
          walletStatus.title = '✅ Wallet connected, Solana network is normal';
          mobileWalletStatus.title = '✅ Wallet connected, Solana network is normal';
        } else {
          walletStatus.className = 'wallet-status-indicator error';
          mobileWalletStatus.className = 'wallet-status-indicator error';
          walletStatus.title = '⚠️ Wallet connected, but Solana network is abnormal';
          mobileWalletStatus.title = '⚠️ Wallet connected, but Solana network is abnormal';
        }
        
        // Hide wallet warning
        const walletWarning = document.getElementById('wallet-warning');
        if (walletWarning) {
          walletWarning.classList.add('hidden');
        }

        // Enable profile button
        if (profileBtn) {
          profileBtn.disabled = false;
          profileBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        // Enable mobile profile button
        const mobileProfileBtn = document.getElementById('mobile-profile-btn');
        if (mobileProfileBtn) {
          mobileProfileBtn.disabled = false;
          mobileProfileBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // Load user profile
        loadUserProfile(currentWallet).then(profile => {
          console.log('User profile loaded after wallet connection:', profile);
          
          // Check if user prompt has already been shown
          const hasPrompted = localStorage.getItem(`profile_prompted_${currentWallet}`);
          console.log('Has user prompt been shown:', hasPrompted);
          
          // If user hasn't set up their profile and hasn't been prompted, show prompt
          if ((!profile || !profile.username) && !hasPrompted) {
            console.log('Prompt needed for user profile setup');
            // Delay a bit to let user see wallet connection success
            setTimeout(() => {
              showProfileModal(true); // Pass true for initial setup
            }, 1000);
          } else {
            console.log('User already has profile or has been prompted');
          }
        });

        // Add disconnect functionality
        setupDisconnectWallet();
      } else {
        // Reset to disconnected state
        walletBtn.className = 'wallet-btn disconnected hidden md:flex';
        mobileWalletBtn.className = 'wallet-btn disconnected flex items-center justify-center mt-2';
        
        walletText.textContent = 'Connect Wallet';
        mobileWalletText.textContent = 'Connect Wallet';
        
        walletStatus.className = 'wallet-status-indicator disconnected';
        mobileWalletStatus.className = 'wallet-status-indicator disconnected';
        walletStatus.title = 'Connect to Phantom Wallet';
        mobileWalletStatus.title = 'Connect to Phantom Wallet';

        // Disable profile button
        if (profileBtn) {
          profileBtn.disabled = true;
          profileBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        // Disable mobile profile button
        const mobileProfileBtn = document.getElementById('mobile-profile-btn');
        if (mobileProfileBtn) {
          mobileProfileBtn.disabled = true;
          mobileProfileBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    // Update private page UI
    function updatePrivatePageUI() {
      const privateWarning = document.getElementById('private-wallet-warning');
      const privateControls = document.getElementById('private-controls');
      const privateDiaryList = document.getElementById('private-diary-list');
      const privateEmptyState = document.getElementById('private-empty-state');
      
      if (currentWallet) {
        privateWarning.classList.add('hidden');
        privateControls.classList.remove('hidden');
        privateDiaryList.classList.remove('hidden');
        loadPrivateDiaries();
      } else {
        privateWarning.classList.remove('hidden');
        privateControls.classList.add('hidden');
        privateDiaryList.classList.add('hidden');
        privateEmptyState.classList.add('hidden');
      }
    }

    // Load all diaries
    function loadDiaries() {
      const diaryRef = query(ref(db, 'diaryEntries'), limitToLast(50));
      onValue(diaryRef, async (snapshot) => {
        const val = snapshot.val();
        if (!val) {
          allDiaries = [];
          renderPublicDiaries();
          return;
        }
        
        // Convert to array and sort by likes in descending order, then by timestamp
        allDiaries = Object.entries(val)
          .map(([id, entry]) => ({ 
            id, 
            ...entry,
            likeCount: entry.likedBy ? Object.keys(entry.likedBy).length : 0
          }))
          .sort((a, b) => {
            // First, sort by likes in descending order
            if (b.likeCount !== a.likeCount) {
              return b.likeCount - a.likeCount;
            }
            // If likes are the same, sort by timestamp
            return b.timestamp - a.timestamp;
          });
        
        renderPublicDiaries();
        renderFeaturedDiaries();
        if (currentWallet) {
          loadPrivateDiaries();
        }
        updateStats();
        
        // Load user profiles for all unique wallets
        const uniqueWallets = [...new Set(allDiaries.map(diary => diary.wallet).filter(Boolean))];
        console.log('User profiles needed for wallets:', uniqueWallets);
        
        for (const wallet of uniqueWallets) {
          if (!userProfiles[wallet]) {
            console.log('Loading user profile:', wallet);
            await loadUserProfile(wallet);
          } else {
            console.log('User profile already cached:', wallet);
          }
        }
      });
    }

    // Global variables for filtering and searching
    let currentFilter = 'all';
    let currentSearchTerm = '';

    // Render public diaries with filtering and search
    function renderPublicDiaries() {
      let publicDiaries = allDiaries.filter(d => d.public !== false);
      
      // Apply tag filter
      if (currentFilter !== 'all') {
        publicDiaries = publicDiaries.filter(diary => 
          diary.tags && diary.tags.includes(currentFilter)
        );
      }
      
      // Apply search filter
      if (currentSearchTerm.trim() !== '') {
        const searchLower = currentSearchTerm.toLowerCase();
        publicDiaries = publicDiaries.filter(diary => 
          diary.title && diary.title.toLowerCase().includes(searchLower) ||
          diary.content && diary.content.toLowerCase().includes(searchLower)
        );
      }
      
      const container = document.querySelector('#public .grid');
      const emptyTip = document.querySelector('#public .col-span-full');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      if (publicDiaries.length === 0) {
        if (emptyTip) {
          emptyTip.style.display = 'flex';
          // Update empty state message based on filter/search
          const emptyTitle = emptyTip.querySelector('h3');
          const emptyDesc = emptyTip.querySelector('p');
          if (currentFilter !== 'all' || currentSearchTerm.trim() !== '') {
            emptyTitle.textContent = 'No diaries found';
            emptyDesc.textContent = currentFilter !== 'all' 
              ? `No diaries found with "${currentFilter}" tag`
              : `No diaries found matching "${currentSearchTerm}"`;
          } else {
            emptyTitle.textContent = 'No public diaries yet';
            emptyDesc.textContent = 'Be the first to share your diary!';
          }
        }
        return;
      }
      
      if (emptyTip) {
        emptyTip.style.display = 'none';
      }
      
      publicDiaries.forEach(diary => {
        const diaryCard = createDiaryCard(diary);
        container.appendChild(diaryCard);
      });
      
      // Load comment counts for all diaries
      loadAllCommentCounts(publicDiaries);
      
      // Update filtered count
      const filteredCountElement = document.getElementById('filtered-count');
      if (filteredCountElement) {
        filteredCountElement.textContent = publicDiaries.length;
      }
    }

    // Load private diaries
    function loadPrivateDiaries() {
      if (!currentWallet) return;
      
      const privateDiaries = allDiaries.filter(d => 
        d.public === false && d.wallet === currentWallet
      );
      
      const container = document.getElementById('private-diary-list');
      const emptyState = document.getElementById('private-empty-state');
      
      container.innerHTML = '';
      
      if (privateDiaries.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      privateDiaries.forEach(diary => {
        const diaryCard = createDiaryCard(diary, true);
        container.appendChild(diaryCard);
      });
    }

    // View user profile
    async function viewUserProfile(walletAddress) {
      if (!walletAddress) {
        alert('Invalid user address');
        return;
      }

      const modal = document.getElementById('user-profile-view-modal');
      const viewAvatar = document.getElementById('view-avatar');
      const viewUsername = document.getElementById('view-username');
      const viewBio = document.getElementById('view-bio');
      const viewWalletAddress = document.getElementById('view-wallet-address');

      // Show loading state
      viewUsername.textContent = 'Loading...';
      viewBio.textContent = 'Loading...';
      viewWalletAddress.textContent = 'Loading...';
      viewAvatar.innerHTML = '<i class="fa fa-user"></i>';

      // Show modal
      modal.classList.remove('hidden');
      disablePageScroll();

      try {
        // Load user profile
        let profile = userProfiles[walletAddress];
        if (!profile) {
          profile = await loadUserProfile(walletAddress);
        }

        // Show wallet address
        viewWalletAddress.textContent = walletAddress;

        if (profile) {
          // Show username
          viewUsername.textContent = profile.username || 'No username set';
          
          // Show bio
          viewBio.textContent = profile.bio || 'This user hasn\'t set up a bio yet';
          
          // Show avatar
          if (profile.avatar) {
            viewAvatar.innerHTML = `<img src="${profile.avatar}" alt="Avatar" class="w-full h-full object-cover rounded-full">`;
          } else {
            const displayName = getUserDisplayName(walletAddress);
            viewAvatar.innerHTML = displayName.charAt(0).toUpperCase();
          }
        } else {
          // User has no profile data
          const displayName = getUserDisplayName(walletAddress);
          viewUsername.textContent = displayName;
          viewBio.textContent = 'This user hasn\'t set up their profile yet';
          viewAvatar.innerHTML = displayName.charAt(0).toUpperCase();
        }

        // Set functionality to copy wallet address
        setupViewCopyWallet(walletAddress);

      } catch (error) {
        console.error('Failed to load user profile:', error);
        viewUsername.textContent = 'Load failed';
        viewBio.textContent = 'Unable to load user profile';
        viewWalletAddress.textContent = walletAddress;
      }
    }

    // Set functionality for copying wallet address in the view modal
    function setupViewCopyWallet(walletAddress) {
      const copyBtn = document.getElementById('copy-view-wallet-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(walletAddress).then(() => {
            // Show copy success notification
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fa fa-check"></i>';
            copyBtn.classList.add('text-green-500');
            
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
              copyBtn.classList.remove('text-green-500');
            }, 2000);
          });
        });
      }
    }

    // Hide user profile view modal
    function hideUserProfileViewModal() {
      const modal = document.getElementById('user-profile-view-modal');
      modal.classList.add('hidden');
      restorePageScroll();
    }

    // Create diary card
    function createDiaryCard(diary, isPrivate = false) {
      const card = document.createElement('article');
      card.className = 'diary-card bg-white rounded-xl shadow-sm overflow-hidden border border-neutral-200 cursor-pointer';
      
      const title = diary.title || 'Untitled';
      const content = diary.content || '';
      const preview = content.length > 120 ? content.slice(0, 120) + '...' : content;
      const author = getUserDisplayName(diary.wallet);
      const userAvatar = getUserAvatar(diary.wallet);
      const date = formatDate(diary.timestamp);
      const tags = diary.tags || [];
      
      let tagHtml = '';
      if (tags.length > 0) {
        const tag = tags[0];
        const tagColors = {
          'Life': 'bg-blue-100 text-blue-800',
          'Travel': 'bg-green-100 text-green-800',
          'Reflection': 'bg-purple-100 text-purple-800',
          'Reading': 'bg-yellow-100 text-yellow-800',
          'Work': 'bg-gray-100 text-gray-800',
          'Food': 'bg-red-100 text-red-800'
        };
        const colorClass = tagColors[tag] || 'bg-gray-100 text-gray-800';
        tagHtml = `<span class="px-2.5 py-0.5 ${colorClass} text-xs rounded-full">${tag}</span>`;
      }
      
      card.innerHTML = `
        <div class="p-6">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center flex-1">
              <div class="w-8 h-8 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-sm font-bold mr-3 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">
                ${userAvatar 
                  ? `<img src="${userAvatar}" alt="Avatar" class="w-full h-full object-cover">`
                  : author.charAt(0).toUpperCase()}
              </div>
              <div class="flex-1">
                <h4 class="font-medium text-neutral-800 cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">${author}</h4>
                <p class="text-xs text-neutral-500">${date}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              ${tagHtml}
              ${isPrivate ? '<i class="fa fa-lock text-neutral-400 text-sm"></i>' : ''}
              ${diary.txid ? '<i class="fa fa-link text-primary text-sm" title="On-chain"></i>' : ''}
              ${(diary.wallet === currentWallet) ? `<button class="delete-diary-btn text-red-500 hover:text-red-700 ml-2" title="Delete Diary" data-diary-id="${diary.id}"><i class="fa fa-trash"></i></button>` : ''}
            </div>
          </div>
          
          <h3 class="text-xl font-bold mb-3 text-neutral-800 hover:text-primary transition-colors">${escapeHtml(title)}</h3>
          
          <p class="text-neutral-600 line-clamp-3 mb-4">${escapeHtml(preview)}</p>
          
          <div class="flex justify-between items-center">
            <div class="flex items-center space-x-4 text-neutral-500">
              <button class="like-btn flex items-center transition-all hover:text-red-500" data-diary-id="${diary.id}" data-liked="${diary.likedBy && diary.likedBy[currentWallet] ? 'true' : 'false'}">
                <i class="fa ${diary.likedBy && diary.likedBy[currentWallet] ? 'fa-heart text-red-500' : 'fa-heart-o'} mr-1"></i>
                <span class="like-count-${diary.id}">${diary.likedBy ? Object.keys(diary.likedBy).length : 0}</span>
              </button>
              <div class="flex items-center">
                <i class="fa fa-comment-o mr-1"></i>
                <span class="comment-count-${diary.id}">0</span>
              </div>
            </div>
            <button class="read-more-btn text-primary hover:text-primary/80 text-sm font-medium transition-colors px-3 py-1 rounded-lg hover:bg-primary/5">
              Read Full Text <i class="fa fa-angle-right ml-1"></i>
            </button>
          </div>
        </div>
      `;
      
      // Add click event
      card.addEventListener('click', () => showDiaryModal(diary));
      
      // Delete diary button event
      if (diary.wallet === currentWallet) {
        const delBtn = card.querySelector('.delete-diary-btn');
        if (delBtn) {
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this diary? This action cannot be undone.')) {
              await deleteDiary(diary.id);
            }
          });
        }
      }
      
      return card;
    }

    // Update stats
    function updateStats() {
      const totalDiaries = allDiaries.length;
      const publicDiaries = allDiaries.filter(d => d.public !== false).length;
      const privateDiaries = allDiaries.filter(d => d.public === false && d.wallet === currentWallet).length;
      const activeUsers = new Set(allDiaries.map(d => d.wallet)).size;
      
      // Update display
      const totalElement = document.getElementById('total-diaries');
      const publicElement = document.getElementById('public-diaries');
      const activeElement = document.getElementById('active-users');
      const commentsElement = document.getElementById('total-comments');
      
      if (totalElement) totalElement.textContent = totalDiaries;
      if (publicElement) publicElement.textContent = publicDiaries;
      if (activeElement) activeElement.textContent = activeUsers;
      if (commentsElement) commentsElement.textContent = '0'; // Temporary set to 0
    }

    // Wallet connection functionality
    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          // Show loading state
          setWalletLoadingState(true);
          
          const resp = await window.solana.connect();
          currentWallet = resp.publicKey.toString();
          
          // Initialize Solana network connection immediately after connecting wallet
          console.log('Initializing Solana network connection...');
          const networkConnected = await initializeConnection();
          if (networkConnected) {
            console.log('Solana network connection successful');
          } else {
            console.warn('Solana network connection failed, blockchain functionality may be unavailable');
          }
          
          updateWalletUI(true);
          updatePrivatePageUI();
          loadDiaries();
          return true;
        } catch (error) {
          console.error('Wallet connection failed:', error);
          return false;
        } finally {
          // Hide loading state
          setWalletLoadingState(false);
        }
      } else {
        alert('Please install Phantom Wallet');
        return false;
      }
    }

    // Set wallet loading state
    function setWalletLoadingState(loading) {
      const walletBtn = document.getElementById('wallet-btn');
      const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
      const walletText = document.getElementById('wallet-text');
      const mobileWalletText = document.getElementById('mobile-wallet-text');
      
      if (loading) {
        walletBtn.classList.add('loading');
        mobileWalletBtn.classList.add('loading');
        walletText.textContent = 'Connecting...';
        mobileWalletText.textContent = 'Connecting...';
      } else {
        walletBtn.classList.remove('loading');
        mobileWalletBtn.classList.remove('loading');
        if (!currentWallet) {
          walletText.textContent = 'Connect Wallet';
          mobileWalletText.textContent = 'Connect Wallet';
        }
      }
    }

    // Page switching functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Get all page links and page containers
      const pageLinks = document.querySelectorAll('.page-link, .nav-link, .mobile-nav-link');
      const pageContainers = document.querySelectorAll('.page-container');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      
      // Automatically check wallet connection
      async function checkWalletConnection() {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect({ onlyIfTrusted: true });
            currentWallet = resp.publicKey.toString();
            
            // Initialize Solana network connection when auto-connected
            console.log('Auto-detected wallet, initializing Solana network connection...');
            const networkConnected = await initializeConnection();
            if (networkConnected) {
              console.log('Solana network connection successful');
            }
            
            updateWalletUI(true);
            updatePrivatePageUI();
            loadDiaries();
            
            // Load user profile
            loadUserProfile(currentWallet).then(profile => {
              console.log('User profile loaded after auto-wallet connection:', profile);
              if (profile) {
                console.log('User profile loaded successfully, username:', profile.username);
              }
            });
            
            // Set disconnect functionality
            setupDisconnectWallet();
          } catch (error) {
            // User not authorized, stay in disconnected state
          }
        }
      }

      // Wallet connection event
      document.getElementById('wallet-btn').addEventListener('click', connectWallet);
      document.getElementById('mobile-wallet-btn').addEventListener('click', connectWallet);
      document.getElementById('private-connect-wallet').addEventListener('click', connectWallet);
      
      // Check wallet connection automatically when page loads
      checkWalletConnection();
      
      // Add keyboard shortcut
      document.addEventListener('keydown', (e) => {
        // ESC key disconnects wallet
        if (e.key === 'Escape' && currentWallet) {
          e.preventDefault();
          disconnectWallet();
        }
      });
      
      // Mobile menu toggle
      mobileMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
      });

      // Custom radio button interaction
      function setupCustomRadioButtons() {
        const radioButtons = document.querySelectorAll('input[name="privacy"]');
        const radioLabels = document.querySelectorAll('input[name="privacy"] + .custom-radio');
        const radioTexts = document.querySelectorAll('input[name="privacy"] + .custom-radio + span');

        radioButtons.forEach((radio, index) => {
          radio.addEventListener('change', function() {
            // Reset all button states
            radioLabels.forEach((label, i) => {
              label.classList.remove('checked');
              radioTexts[i].classList.remove('font-semibold', 'text-primary');
            });

            // Set current selected button state
            if (this.checked) {
              radioLabels[index].classList.add('checked');
              radioTexts[index].classList.add('font-semibold', 'text-primary');
            }
          });

          // Initial state
          if (radio.checked) {
            radioLabels[index].classList.add('checked');
            radioTexts[index].classList.add('font-semibold', 'text-primary');
          }
        });
      }

      // Initialize custom radio buttons
      setupCustomRadioButtons();

      // Initialize public diary filtering and search
      function setupPublicDiaryFilters() {
        // Filter button click events
        const filterButtons = document.querySelectorAll('#public .filter-btn');
        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => {
              btn.classList.remove('active', 'bg-primary', 'text-white');
              btn.classList.add('bg-neutral-100', 'text-neutral-700');
            });
            
            // Add active class to clicked button
            this.classList.add('active', 'bg-primary', 'text-white');
            this.classList.remove('bg-neutral-100', 'text-neutral-700');
            
            // Update current filter
            currentFilter = this.getAttribute('data-filter');
            
            // Re-render diaries
            renderPublicDiaries();
          });
        });
        
        // Search input event
        const searchInput = document.getElementById('public-search-input');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        
        if (searchInput) {
          let searchTimeout;
          
          function updateClearButton() {
            if (searchInput.value.trim() !== '') {
              clearSearchBtn.classList.remove('hidden');
            } else {
              clearSearchBtn.classList.add('hidden');
            }
          }
          
          searchInput.addEventListener('input', function() {
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // Update clear button visibility
            updateClearButton();
            
            // Set new timeout for debounced search
            searchTimeout = setTimeout(() => {
              currentSearchTerm = this.value;
              renderPublicDiaries();
            }, 300); // 300ms delay for better performance
          });
          
          // Clear search on escape
          searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              this.value = '';
              currentSearchTerm = '';
              updateClearButton();
              renderPublicDiaries();
            }
          });
          
          // Clear search button click
          if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
              searchInput.value = '';
              currentSearchTerm = '';
              updateClearButton();
              renderPublicDiaries();
              searchInput.focus();
            });
          }
        }
      }

      // Initialize tag selector
      function setupTagSelector() {
        const tagItems = document.querySelectorAll('.tag-item');
        
        tagItems.forEach(tagItem => {
          const checkbox = tagItem.querySelector('input[type="checkbox"]');
          
          // Clicking on a tag toggles its selected state
          tagItem.addEventListener('click', function(e) {
            e.preventDefault();
            checkbox.checked = !checkbox.checked;
            updateTagVisualState(tagItem, checkbox.checked);
          });
          
          // Initial state
          updateTagVisualState(tagItem, checkbox.checked);
        });
      }

      // Update tag visual state
      function updateTagVisualState(tagItem, isChecked) {
        if (isChecked) {
          tagItem.classList.add('checked');
        } else {
          tagItem.classList.remove('checked');
        }
      }

      // Initialize tag selector
      setupTagSelector();
      
      // Initialize public diary filters
      setupPublicDiaryFilters();
      
      // Initialize like button event listeners
      setupDiaryCardLikeButtons();

      // Initialize profile features
      setupProfileFeatures();
      
      // Page switching function
      function switchPage(pageId) {
        // Hide all pages
        pageContainers.forEach(container => {
          container.classList.remove('active');
        });
        
        // Show target page
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
          
          // Scroll to top
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          
          // Special page logic
          if (pageId === 'private') {
            updatePrivatePageUI();
          }
        }
        
        // Update navigation active state
        document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
          link.classList.remove('nav-active');
          if (link.getAttribute('data-page') === pageId) {
            link.classList.add('nav-active');
          }
        });
        
        // Close mobile menu
        mobileMenu.classList.add('hidden');
      }
      
      // Add click event listeners to all page links
      pageLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const pageId = this.getAttribute('data-page');
          if (pageId) {
            switchPage(pageId);
          }
        });
      });
      
      // Diary content character count
      const diaryContent = document.getElementById('diary-content');
      const charCount = document.getElementById('char-count');
      
      if (diaryContent && charCount) {
        diaryContent.addEventListener('input', function() {
          const count = this.value.length;
          charCount.textContent = `${count} characters`;
        });
      }
      
      // Clear content button
      const clearContentBtn = document.getElementById('clear-content');
      if (clearContentBtn && diaryContent) {
        clearContentBtn.addEventListener('click', function() {
          diaryContent.value = '';
          charCount.textContent = '0 characters';
        });
      }
      
      // Update button text when blockchain option changes
      const enableBlockchainToggle = document.getElementById('enable-blockchain');
      const publishText = document.getElementById('publish-text');
      
      if (enableBlockchainToggle && publishText) {
        function updatePublishButtonText() {
          if (enableBlockchainToggle.checked) {
            publishText.textContent = 'Publish and store on blockchain';
          } else {
            publishText.textContent = 'Publish Diary';
          }
        }
        
        enableBlockchainToggle.addEventListener('change', updatePublishButtonText);
        updatePublishButtonText(); // Initialization
      }

      // Check wallet balance
      async function checkWalletBalance(walletPublicKey) {
        try {
          // Ensure connection is initialized
          if (!connection) {
            const connected = await initializeConnection();
            if (!connected) {
              throw new Error('Unable to connect to Solana network');
            }
          }
          
          const publicKey = new solanaWeb3.PublicKey(walletPublicKey);
          const balance = await connection.getBalance(publicKey);
          // Return SOL balance (lamports to SOL)
          return balance / solanaWeb3.LAMPORTS_PER_SOL;
        } catch (error) {
          console.error('Failed to get wallet balance:', error);
          // If it's a network error, try reconnecting
          if (error.message.includes('403') || error.message.includes('fetch')) {
            console.log('Retrying connection...');
            const reconnected = await initializeConnection();
            if (reconnected) {
              try {
                const publicKey = new solanaWeb3.PublicKey(walletPublicKey);
                const balance = await connection.getBalance(publicKey);
                return balance / solanaWeb3.LAMPORTS_PER_SOL;
              } catch (retryError) {
                console.error('Failed to retry getting balance:', retryError);
              }
            }
          }
          return 0;
        }
      }

      // Create Solana transaction on-chain (using Memo program)
      async function createSolanaTransaction(diaryData, walletPublicKey) {
        try {
          // Ensure connection is initialized
          if (!connection) {
            const connected = await initializeConnection();
            if (!connected) {
              throw new Error('Unable to connect to Solana network');
            }
          }

          // Create diary content
          const title = diaryData.title || '';
          const content = diaryData.content || '';
          const message = title ? `[${title}] ${content}` : content;
          
          // Encode message
          const encodedMessage = new TextEncoder().encode(message);
          
          // Check length limit
          if (encodedMessage.length > 566) {
            throw new Error(`Diary content too long, cannot be stored on-chain (max 566 bytes, current ${encodedMessage.length} bytes)`);
          }
          
          // Create memo instruction
          const memoProgramId = new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr');
          const fromPubkey = new solanaWeb3.PublicKey(walletPublicKey);
          
          const memoInstruction = new solanaWeb3.TransactionInstruction({
            keys: [{ pubkey: fromPubkey, isSigner: true, isWritable: false }],
            programId: memoProgramId,
            data: encodedMessage
          });
          
          // Get latest blockhash
          const { blockhash } = await connection.getLatestBlockhash();
          
          // Create transaction
          const transaction = new solanaWeb3.Transaction();
          transaction.recentBlockhash = blockhash;
          transaction.feePayer = fromPubkey;
          transaction.add(memoInstruction);
          
          return transaction;
        } catch (error) {
          console.error('Failed to create Solana transaction:', error);
          throw error;
        }
      }

      // Diary publishing functionality
      async function publishDiary(diaryData) {
        if (!currentWallet) {
          showWalletWarning();
          return false;
        }

        const publishBtn = document.getElementById('publish-btn');
        const publishText = document.getElementById('publish-text');
        const publishSpinner = document.getElementById('publish-spinner');
        
        // Disable button and show loading state
        publishBtn.disabled = true;
        publishText.textContent = 'Creating transaction...';
        publishSpinner.classList.remove('hidden');
        
        let txid = null;
        
        // Check if we want to try storing on blockchain
        const enableBlockchain = document.getElementById('enable-blockchain').checked;
        
        try {
          // First: if blockchain storage is enabled, try creating Solana transaction and storing on blockchain
          if (enableBlockchain && currentWallet) {
            try {
              publishText.textContent = 'Checking wallet balance...';
              
              // Check balance
              const balance = await checkWalletBalance(currentWallet);
              const minBalance = 0.0005; // At least 0.0005 SOL needed for transaction fees (Memo program is cheaper)
              
              if (balance < minBalance) {
                throw new Error(`Insufficient wallet balance. Current balance: ${balance.toFixed(6)} SOL, at least ${minBalance} SOL needed`);
              }
              
              publishText.textContent = 'Storing on blockchain...';
              
              // Create transaction
              const transaction = await createSolanaTransaction(diaryData, currentWallet);
              
              // Sign and send transaction to Solana mainnet
              const signed = await window.solana.signTransaction(transaction);
              const signature = await connection.sendRawTransaction(signed.serialize());
              txid = signature;
              
              publishText.textContent = 'Confirming transaction...';
              
              // Wait for transaction confirmation
              await connection.confirmTransaction(signature, 'confirmed');
              
              console.log('Solana transaction successful:', signature);
              const shortSig = signature.slice(0, 4) + '...' + signature.slice(-6);
              console.log(`✅ Diary stored on blockchain, transaction ID: ${shortSig}`);
              publishText.textContent = 'Saving to database...';
              
            } catch (solanaError) {
              console.error('Failed to store on blockchain:', solanaError);
              // Even if storing on blockchain fails, continue saving to Firebase, but without txid
              publishText.textContent = 'Storing on blockchain failed, saving to database...';
              
              // Show specific error message
              if (solanaError.message.includes('Diary content too long')) {
                console.warn('Content too long, consider shortening diary content');
              } else if (solanaError.message.includes('Insufficient balance')) {
                console.warn('Insufficient wallet balance, please top up and try again');
              }
            }
          } else {
            publishText.textContent = 'Saving to database...';
          }
          
          // Second: save to Firebase database
          const entry = {
            title: diaryData.title,
            content: diaryData.content,
            tags: diaryData.tags,
            public: diaryData.privacy === 'public',
            wallet: currentWallet,
            timestamp: Date.now(),
            txid: txid // If storing on blockchain was successful, include transaction ID
          };
          
          // Save to Firebase
          const diaryRef = ref(db, 'diaryEntries');
          const result = await push(diaryRef, entry);
          
          // Reset form
          document.getElementById('diary-form').reset();
          document.getElementById('char-count').textContent = '0 characters';
          
          // Show success message
          showSuccessModal(txid);
          
          // Reload data
          setTimeout(() => {
            loadDiaries();
          }, 1000);
          
          return true;
        } catch (error) {
          console.error('Failed to publish:', error);
          alert('Failed to publish: ' + error.message);
          return false;
        } finally {
          // Restore button state
          publishBtn.disabled = false;
          const enableBlockchain = document.getElementById('enable-blockchain').checked;
          publishText.textContent = enableBlockchain ? 'Publish and store on blockchain' : 'Publish Diary';
          publishSpinner.classList.add('hidden');
        }
      }

      // Show wallet warning
      function showWalletWarning() {
        const walletWarning = document.getElementById('wallet-warning');
        if (walletWarning) {
          walletWarning.classList.remove('hidden');
          setTimeout(() => {
            walletWarning.classList.add('hidden');
          }, 5000);
        }
      }
          
      // Show success modal
      function showSuccessModal(txid = null) {
        const successModal = document.getElementById('success-modal');
        if (successModal) {
          // Update modal content
          const modalContent = successModal.querySelector('.text-center');
          if (txid) {
            modalContent.innerHTML = `
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-check text-2xl text-green-500"></i>
              </div>
              <h3 class="text-xl font-bold text-neutral-800 mb-2">Success!</h3>
              <p class="text-neutral-600 mb-4">Your diary has been successfully published to Solana blockchain!</p>
              <div class="bg-neutral-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-neutral-600 mb-2">Transaction ID:</p>
                <p class="text-xs text-neutral-800 font-mono break-all">${txid}</p>
                <div class="flex gap-2 mt-2">
                  <a href="https://solscan.io/tx/${txid}" target="_blank" class="inline-block text-primary hover:text-primary/80 text-sm">
                    <i class="fa fa-external-link mr-1"></i>Solscan
                  </a>
                  <a href="https://explorer.solana.com/tx/${txid}?cluster=mainnet-beta" target="_blank" class="inline-block text-primary hover:text-primary/80 text-sm">
                    <i class="fa fa-external-link mr-1"></i>Solana Explorer
                  </a>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row gap-3">
                <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                  View My Diary
                </button>
                <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
                  Return to Home
                </button>
              </div>
            `;
          } else {
            modalContent.innerHTML = `
              <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-exclamation-triangle text-2xl text-amber-500"></i>
              </div>
              <h3 class="text-xl font-bold text-neutral-800 mb-2">Partial Success</h3>
              <p class="text-neutral-600 mb-6">Diary saved, but failed to store on blockchain. You can try resubmitting later.</p>
              <div class="flex flex-col sm:flex-row gap-3">
                <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                  View My Diary
                </button>
                <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
                  Return to Home
                </button>
              </div>
            `;
          }
          
          successModal.classList.remove('hidden');
          setTimeout(() => {
            successModal.classList.add('opacity-100');
            successModal.querySelector('div').classList.remove('scale-95');
            successModal.querySelector('div').classList.add('scale-100');
          }, 10);
        }
      }

      // Diary submission form submission
      const diaryForm = document.getElementById('diary-form');
      const successModal = document.getElementById('success-modal');
      const closeModalBtn = document.getElementById('close-modal');
      const viewDiaryBtn = document.getElementById('view-diary');
      
      if (diaryForm) {
        diaryForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Get form data
          const formData = new FormData(this);
          const title = document.getElementById('diary-title').value;
          const content = document.getElementById('diary-content').value;
          const privacy = formData.get('privacy');
          const tags = Array.from(formData.getAll('tags'));
          
          if (!title.trim() || !content.trim()) {
            alert('Please fill out title and content');
            return;
          }
          
          const diaryData = {
            title: title.trim(),
            content: content.trim(),
            privacy,
            tags
          };
          
          if (typeof publishDiary === 'function') {
            await publishDiary(diaryData);
          } else {
            console.error('publishDiary function is not defined');
            alert('System error, please refresh and try again');
          }
        });
      }
        
      // Use event delegation to handle success modal button clicks
      document.addEventListener('click', function(e) {
        if (e.target.id === 'close-modal') {
          const successModal = document.getElementById('success-modal');
          if (successModal) {
            successModal.classList.remove('opacity-100');
            successModal.querySelector('div').classList.remove('scale-100');
            successModal.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
              successModal.classList.add('hidden');
              switchPage('home');
            }, 300);
          }
        }
        
        if (e.target.id === 'view-diary') {
          const successModal = document.getElementById('success-modal');
          if (successModal) {
            successModal.classList.remove('opacity-100');
            successModal.querySelector('div').classList.remove('scale-100');
            successModal.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
              successModal.classList.add('hidden');
              switchPage('public');
            }, 300);
          }
        }
      });

      // Initialize application
      function initApp() {
        try {
          loadDiaries();
          updateStats();
          
          // Verify that the critical functions are defined
          if (typeof publishDiary !== 'function') {
            console.error('publishDiary function is not available');
          }
          if (typeof connectWallet !== 'function') {
            console.error('connectWallet function is not available');
          }
          if (typeof showDiaryModal !== 'function') {
            console.error('showDiaryModal function is not available');
          }
        } catch (error) {
          console.error('Failed to initialize application:', error);
        }
      }

      // Initialize when page loads
      initApp();
      
      // Expose functions to global scope for debugging
      window.publishDiary = publishDiary;
      window.connectWallet = connectWallet;
      window.toggleLike = toggleLike;
      window.showProfileModal = showProfileModal;
      window.viewUserProfile = viewUserProfile;
      window.hideUserProfileViewModal = hideUserProfileViewModal;
      window.setupViewCopyWallet = setupViewCopyWallet;
      window.disconnectWallet = disconnectWallet;
      window.showWalletWarning = showWalletWarning;
      window.loadDiaries = loadDiaries;
      
      // Expose functions to global scope for debugging
      window.blockchainDiary = {
        connectWallet,
        loadDiaries,
        publishDiary,
        toggleLike,
        showDiaryModal,
        currentWallet: () => currentWallet,
        allDiaries: () => allDiaries
      };
      
      console.log('Critical functions exposed');
    });

    // Show diary details modal
    window.showDiaryModal = function(diary) {
      // Create modal HTML
      const modalHtml = `
        <div id="diary-detail-modal" class="diary-modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div class="diary-modal-content rounded-xl shadow-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div class="p-8">
              <!-- Header Information -->
              <div class="flex justify-between items-start mb-6">
                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white font-bold mr-4 shadow-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" onclick="viewUserProfile('${diary.wallet}')">
                    ${(() => {
                      const userAvatar = getUserAvatar(diary.wallet);
                      const displayName = getUserDisplayName(diary.wallet);
                      return userAvatar 
                        ? `<img src="${userAvatar}" alt="Avatar" class="w-full h-full object-cover">`
                        : displayName.charAt(0).toUpperCase();
                    })()}
                  </div>
                  <div>
                    <h4 class="font-semibold text-neutral-800 text-lg cursor-pointer hover:text-primary transition-colors" onclick="viewUserProfile('${diary.wallet}')">${getUserDisplayName(diary.wallet)}</h4>
                    <p class="text-sm text-neutral-500 flex items-center">
                      <i class="fa fa-clock-o mr-1"></i>
                      ${formatDate(diary.timestamp)}
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  ${diary.txid ? `
                    <a href="https://solscan.io/tx/${diary.txid}" target="_blank" class="flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200 transition-all shadow-sm">
                      <i class="fa fa-link mr-2"></i>
                      On-chain
                    </a>
                  ` : ''}
                  ${(diary.wallet === currentWallet) ? `<button id="modal-delete-diary-btn" class="text-red-500 hover:text-red-700 ml-2" title="Delete Diary"><i class="fa fa-trash"></i></button>` : ''}
                  <button id="close-diary-modal" class="w-10 h-10 flex items-center justify-center rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 hover:text-neutral-800 transition-all">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
              </div>
              
              <!-- Title and Like Area -->
              <div class="flex justify-between items-start mb-6">
                <h1 class="diary-title text-3xl font-bold">${escapeHtml(diary.title || 'Untitled')}</h1>
                <div class="flex items-center space-x-4">
                  <button class="modal-like-btn flex items-center px-4 py-2 rounded-lg border border-neutral-300 hover:border-red-300 hover:bg-red-50 transition-all" data-diary-id="${diary.id}" data-liked="${diary.likedBy && diary.likedBy[currentWallet] ? 'true' : 'false'}">
                    <i class="fa ${diary.likedBy && diary.likedBy[currentWallet] ? 'fa-heart text-red-500' : 'fa-heart-o text-neutral-500'} mr-2"></i>
                    <span class="modal-like-count-${diary.id} font-medium">${diary.likedBy ? Object.keys(diary.likedBy).length : 0}</span>
                  </button>
                </div>
              </div>
              
              <!-- Tags -->
              ${diary.tags && diary.tags.length > 0 ? `
                <div class="flex flex-wrap gap-3 mb-8">
                  ${diary.tags.map(tag => {
                    const tagColors = {
                      'Life': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                      'Travel': 'bg-blue-100 text-blue-800 border-blue-200',
                      'Reflection': 'bg-purple-100 text-purple-800 border-purple-200',
                      'Reading': 'bg-green-100 text-green-800 border-green-200',
                      'Work': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                      'Food': 'bg-red-100 text-red-800 border-red-200'
                    };
                    const colorClass = tagColors[tag] || 'bg-gray-100 text-gray-800 border-gray-200';
                    return `<span class="px-4 py-2 ${colorClass} rounded-full text-sm font-medium border">${tag}</span>`;
                  }).join('')}
                </div>
              ` : ''}
              
              <!-- Content -->
              <div class="diary-content mb-8 bg-white rounded-lg p-6 border border-neutral-200 shadow-sm">
                <p class="text-neutral-700 leading-relaxed whitespace-pre-line text-lg">${escapeHtml(diary.content || '')}</p>
              </div>
              
              <!-- Blockchain Information -->
              ${diary.txid ? `
                <div class="blockchain-info p-6">
                  <div class="flex items-center mb-3">
                    <i class="fa fa-link text-blue-500 mr-2"></i>
                    <h3 class="font-semibold text-blue-800">Blockchain Transaction Information</h3>
                  </div>
                  <p class="text-sm text-blue-700 font-mono break-all mb-3 bg-blue-50 p-3 rounded-lg">${diary.txid}</p>
                  <div class="flex gap-3">
                    <a href="https://solscan.io/tx/${diary.txid}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm font-medium">
                      <i class="fa fa-external-link mr-2"></i>
                      View on Solscan
                    </a>
                    <a href="https://explorer.solana.com/tx/${diary.txid}?cluster=mainnet-beta" target="_blank" class="inline-flex items-center px-4 py-2 bg-neutral-500 text-white rounded-lg hover:bg-neutral-600 transition-all text-sm font-medium">
                      <i class="fa fa-external-link mr-2"></i>
                      View on Solana Explorer
                    </a>
                  </div>
                </div>
              ` : `
                <div class="blockchain-info error p-6">
                  <div class="flex items-center">
                    <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>
                    <p class="text-red-700 font-medium">
                      This diary has not been stored on-chain or failed to store
                    </p>
                  </div>
                </div>
              `}

              <!-- Chat Comment Area -->
              <div class="chat-section mt-8">
                <!-- Chat Header -->
                <div class="chat-header">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-neutral-800 flex items-center">
                      <i class="fa fa-comments text-primary mr-2"></i>
                      Comment Discussion
                    </h3>
                    <span class="text-sm text-neutral-500" id="comment-count">0 comments</span>
                  </div>
                </div>
                
                <!-- Chat Message Area -->
                <div class="chat-messages">
                  <div class="comments-container bg-neutral-50 rounded-lg p-4 h-full overflow-y-auto" id="comments-list-${diary.id}">
                    <div class="text-center text-neutral-500 py-8">
                      <i class="fa fa-comment-o text-2xl mb-2"></i>
                      <p>No comments yet, be the first to leave one!</p>
                    </div>
                  </div>
                </div>
                
                <!-- Chat Input Area -->
                <div class="chat-input-area">
                  ${currentWallet ? `
                    <div class="flex gap-3">
                      <div class="flex-1">
                        <textarea 
                          id="comment-input-${diary.id}" 
                          placeholder="Write your thoughts..." 
                          class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"
                          rows="2"
                        ></textarea>
                      </div>
                      <button 
                        id="send-comment-${diary.id}" 
                        class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all font-medium flex items-center"
                        disabled
                      >
                        <i class="fa fa-paper-plane mr-2"></i>
                        Send
                      </button>
                    </div>
                  ` : `
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 text-center">
                      <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                      <span class="text-amber-700">Please connect wallet to participate in comment discussion</span>
                    </div>
                  `}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add close event
      const modal = document.getElementById('diary-detail-modal');
      const closeBtn = document.getElementById('close-diary-modal');
      
      function closeModal() {
        // Clear comment listeners
        if (commentListeners[diary.id]) {
          commentListeners[diary.id]();
          delete commentListeners[diary.id];
        }
        
        modal.style.animation = 'modalFadeOut 0.2s ease-in forwards';
        setTimeout(() => {
          modal.remove();
          // Restore page scrolling
          restorePageScroll();
        }, 200);
      }
      
      closeBtn.addEventListener('click', closeModal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Keyboard shortcut
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
      
      // Prevent scroll bleed
      disablePageScroll();

      // Initialize comment functionality
      initializeComments(diary.id);
      
      // Initialize like functionality
      initializeLikeButtons(diary.id);

      // 删除按钮事件
      if (diary.wallet === currentWallet) {
        const delBtn = document.getElementById('modal-delete-diary-btn');
        if (delBtn) {
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this diary? This action cannot be undone.')) {
              await deleteDiary(diary.id);
              closeModal();
            }
          });
        }
      }
    }

    // Comment functionality
    let commentListeners = {};
    let originalBodyOverflow = '';

    // Scroll state management
    function disablePageScroll() {
      originalBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      console.log('Page scrolling disabled, original state:', originalBodyOverflow);
    }

    function restorePageScroll() {
      document.body.style.overflow = originalBodyOverflow || '';
      console.log('Page scrolling restored:', document.body.style.overflow);
    }

    // User profile management
    async function loadUserProfile(walletAddress) {
      // Add real-time listener
      if (walletAddress === currentWallet && !window.profileListener) {
        console.log('Setting up real-time user profile listener');
        const profileRef = ref(db, `userProfiles/${walletAddress}`);
        window.profileListener = onValue(profileRef, (snapshot) => {
          const profile = snapshot.val();
          console.log('Real-time listener detected user profile change:', profile);
          if (profile) {
            userProfiles[walletAddress] = profile;
            currentUserProfile = profile;
          }
        });
      }
      
      try {
        console.log('Loading user profile:', walletAddress);
        const profileRef = ref(db, `userProfiles/${walletAddress}`);
        const snapshot = await get(profileRef);
        const profile = snapshot.val();
        
        console.log('User profile retrieved from Firebase:', profile);
        
        if (profile) {
          userProfiles[walletAddress] = profile;
          if (walletAddress === currentWallet) {
            currentUserProfile = profile;
            console.log('Setting current user profile:', profile);
          }
          return profile;
        }
        console.log('User profile does not exist');
        return null;
      } catch (error) {
        console.error('Failed to load user profile:', error);
        return null;
      }
    }

    async function saveUserProfile(profileData) {
      if (!currentWallet) {
        alert('Please connect wallet first');
        return false;
      }

      try {
        console.log('Saving user profile:', currentWallet, profileData);
        
        const profileRef = ref(db, `userProfiles/${currentWallet}`);
        const saveData = {
          ...profileData,
          wallet: currentWallet,
          updatedAt: Date.now()
        };
        
        console.log('Data to be saved to Firebase:', saveData);
        
        await update(profileRef, saveData);
        console.log('Firebase update successful');

        // Update cache
        userProfiles[currentWallet] = profileData;
        currentUserProfile = profileData;

        // Record that user has already set up their profile
        localStorage.setItem(`profile_prompted_${currentWallet}`, 'true');

        console.log('User profile saved successfully, cache updated');
        return true;
      } catch (error) {
        console.error('Failed to save user profile:', error);
        alert('Failed to save, please try again later');
        return false;
      }
    }

    function getUserDisplayName(walletAddress) {
      const profile = userProfiles[walletAddress];
      if (profile && profile.username) {
        return profile.username;
      }
      return walletAddress ? walletAddress.slice(0, 4) + '...' + walletAddress.slice(-4) : 'Anonymous';
    }

    function getUserAvatar(walletAddress) {
      const profile = userProfiles[walletAddress];
      if (profile && profile.avatar) {
        return profile.avatar;
      }
      return null;
    }

    function getUserBio(walletAddress) {
      const profile = userProfiles[walletAddress];
      return profile ? profile.bio || '' : '';
    }

    // Profile modal management
    function showProfileModal(isFirstTime = false) {
      if (!currentWallet) {
        alert('Please connect wallet first');
        return;
      }

      const modal = document.getElementById('profile-modal');
      const usernameInput = document.getElementById('profile-username');
      const bioInput = document.getElementById('profile-bio');
      const walletAddressSpan = document.getElementById('profile-wallet-address');
      const avatarPreview = document.getElementById('avatar-preview');

      // Show wallet address
      walletAddressSpan.textContent = currentWallet;

      // Load current user profile
      if (currentUserProfile) {
        console.log('Using cached user profile for modal:', currentUserProfile);
        usernameInput.value = currentUserProfile.username || '';
        bioInput.value = currentUserProfile.bio || '';
        
        // Show avatar
        if (currentUserProfile.avatar) {
          avatarPreview.innerHTML = `<img src="${currentUserProfile.avatar}" alt="Avatar">`;
          avatarPreview.classList.add('has-image');
        } else {
          avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
          avatarPreview.classList.remove('has-image');
        }
      } else {
        console.log('No cached user profile available, trying to load from Firebase...');
        // Try to load user profile from Firebase
        loadUserProfile(currentWallet).then(profile => {
          if (profile) {
            console.log('User profile loaded from Firebase:', profile);
            usernameInput.value = profile.username || '';
            bioInput.value = profile.bio || '';
            
            // Show avatar
            if (profile.avatar) {
              avatarPreview.innerHTML = `<img src="${profile.avatar}" alt="Avatar">`;
              avatarPreview.classList.add('has-image');
            } else {
              avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
              avatarPreview.classList.remove('has-image');
            }
          } else {
            console.log('No user profile found in Firebase');
            usernameInput.value = '';
            bioInput.value = '';
            avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
            avatarPreview.classList.remove('has-image');
          }
        });
      }

      // Update character count
      updateBioCharCount();

      // Show modal
      modal.classList.remove('hidden');
      disablePageScroll();

      // If this is the first time, show welcome prompt
      if (isFirstTime) {
        const modalTitle = modal.querySelector('.bg-gradient-to-r h2');
        if (modalTitle) {
          modalTitle.textContent = 'Welcome! Please set up your profile';
        }
        
        // Add prompt for first-time setup
        const form = document.getElementById('profile-form');
        if (form && !form.querySelector('.first-time-tip')) {
          const tip = document.createElement('div');
          tip.className = 'first-time-tip bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4';
          tip.innerHTML = `
            <div class="flex items-start">
              <i class="fa fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
              <div>
                <p class="text-blue-800 text-sm font-medium mb-1">Welcome to Blockchain Diary Time!</p>
                <p class="text-blue-700 text-sm">After setting up your profile, your username and avatar will appear in diaries and comments, helping others get to know you better.</p>
              </div>
            </div>
          `;
          form.insertBefore(tip, form.firstChild);
        }
      }
    }

    function hideProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.add('hidden');
      restorePageScroll();
      
      // Restore modal title
      const modalTitle = modal.querySelector('.bg-gradient-to-r h2');
      if (modalTitle) {
        modalTitle.textContent = 'Profile Settings';
      }
      
      // Remove first-time setup prompt
      const firstTimeTip = modal.querySelector('.first-time-tip');
      if (firstTimeTip) {
        firstTimeTip.remove();
      }
    }

    function updateBioCharCount() {
      const bioInput = document.getElementById('profile-bio');
      const charCount = document.getElementById('bio-char-count');
      if (bioInput && charCount) {
        const count = bioInput.value.length;
        charCount.textContent = `${count}/200`;
      }
    }

    // Avatar upload handling
    function setupAvatarUpload() {
      const avatarPreview = document.getElementById('avatar-preview');
      const avatarUpload = document.getElementById('avatar-upload');
      const uploadBtn = document.getElementById('upload-avatar-btn');

      // Clicking on avatar or upload button triggers file selection
      [avatarPreview, uploadBtn].forEach(element => {
        if (element) {
          element.addEventListener('click', () => {
            avatarUpload.click();
          });
        }
      });

      // File selection handling
      if (avatarUpload) {
        avatarUpload.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
              alert('Image size cannot exceed 5MB');
              return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
              avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
              avatarPreview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    // Copy wallet address
    function setupCopyWallet() {
      const copyBtn = document.getElementById('copy-wallet-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          if (currentWallet) {
            navigator.clipboard.writeText(currentWallet).then(() => {
              // Show copy success notification
              const originalText = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fa fa-check"></i>';
              copyBtn.classList.add('text-green-500');
              
              setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('text-green-500');
              }, 2000);
            });
          }
        });
      }
    }



    // Disconnect wallet
    async function disconnectWallet() {
      try {
        // Disconnect Phantom wallet
        if (window.solana && window.solana.disconnect) {
          await window.solana.disconnect();
        }
        
        // Clear current wallet state
        currentWallet = '';
        currentUserProfile = null;
        
        // Clear user profile cache (optional, keep other users' profiles)
        // userProfiles = {};
        
        // Update UI state
        updateWalletUI(false);
        
        // Update private page UI
        updatePrivatePageUI();
        
        // Clear comment listeners
        clearCommentListeners();
        
        // Clear user profile listener
        if (window.profileListener) {
          window.profileListener();
          window.profileListener = null;
        }
        
        console.log('Wallet disconnected');
        
        // Show success message for disconnection
        showDisconnectSuccessMessage();
        
      } catch (error) {
        console.error('Failed to disconnect wallet:', error);
        alert('Failed to disconnect, please try again later');
      }
    }

    // Set disconnect functionality
    function setupDisconnectWallet() {
      const walletBtn = document.getElementById('wallet-btn');
      const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
      
      // Add right-click menu for desktop wallet button
      if (walletBtn) {
        walletBtn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showDisconnectMenu(e, walletBtn);
        });
        
        // Add long press prompt
        walletBtn.title = 'Right-click to disconnect';
      }
      
      // Add long press functionality for mobile wallet button
      if (mobileWalletBtn) {
        let longPressTimer;
        let isLongPress = false;
        
        mobileWalletBtn.addEventListener('touchstart', (e) => {
          longPressTimer = setTimeout(() => {
            isLongPress = true;
            showDisconnectMenu(e, mobileWalletBtn);
          }, 800);
        });
        
        mobileWalletBtn.addEventListener('touchend', () => {
          clearTimeout(longPressTimer);
          setTimeout(() => {
            isLongPress = false;
          }, 100);
        });
        
        mobileWalletBtn.addEventListener('touchmove', () => {
          clearTimeout(longPressTimer);
        });
        
        // Add long press prompt
        mobileWalletBtn.title = 'Long press to disconnect';
      }
    }

    // Show disconnect menu
    function showDisconnectMenu(event, button) {
      // Remove existing menu
      const existingMenu = document.getElementById('disconnect-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      // Create disconnect menu
      const menu = document.createElement('div');
      menu.id = 'disconnect-menu';
      menu.className = 'fixed z-50 bg-white rounded-lg shadow-lg border border-neutral-200 py-2 min-w-[160px]';
      menu.innerHTML = `
        <button class="w-full px-4 py-2 text-left text-red-600 hover:bg-red-50 transition-colors flex items-center">
          <i class="fa fa-sign-out mr-2"></i>
          Disconnect
        </button>
      `;
      
      // Add disconnect event
      const disconnectBtn = menu.querySelector('button');
      disconnectBtn.addEventListener('click', () => {
        disconnectWallet();
        menu.remove();
      });
      
      // Position menu
      const rect = button.getBoundingClientRect();
      menu.style.left = `${rect.left}px`;
      menu.style.top = `${rect.bottom + 5}px`;
      
      // Add to page
      document.body.appendChild(menu);
      
      // Click outside to close menu
      const closeMenu = (e) => {
        if (!menu.contains(e.target) && !button.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      };
      
      // Delay adding event listener to avoid immediate trigger
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
      }, 100);
    }

    // Show disconnect success message
    function showDisconnectSuccessMessage() {
      // Create success notification
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full';
      message.innerHTML = `
        <div class="flex items-center">
          <i class="fa fa-check-circle mr-2"></i>
          <span>Wallet disconnected</span>
        </div>
      `;
      
      document.body.appendChild(message);
      
      // Show animation
      setTimeout(() => {
        message.classList.remove('translate-x-full');
      }, 100);
      
      // Auto hide
      setTimeout(() => {
        message.classList.add('translate-x-full');
        setTimeout(() => {
          message.remove();
        }, 300);
      }, 3000);
    }

    // Clear comment listeners
    function clearCommentListeners() {
      if (window.commentListeners) {
        Object.values(window.commentListeners).forEach(unsubscribe => {
          if (typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
        window.commentListeners = {};
      }
    }

    // Initialize profile features
    function setupProfileFeatures() {
      // Profile button click event
      const profileBtn = document.getElementById('profile-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', () => showProfileModal(false)); // Pass false to indicate not first-time setup
      }
      
      // Mobile profile button click event
      const mobileProfileBtn = document.getElementById('mobile-profile-btn');
      if (mobileProfileBtn) {
        mobileProfileBtn.addEventListener('click', () => {
          showProfileModal(false);
          // Close mobile menu
          const mobileMenu = document.getElementById('mobile-menu');
          if (mobileMenu) {
            mobileMenu.classList.add('hidden');
          }
        });
      }

      // Close profile modal
      const closeProfileModal = document.getElementById('close-profile-modal');
      const cancelProfileBtn = document.getElementById('cancel-profile-btn');
      if (closeProfileModal) {
        closeProfileModal.addEventListener('click', hideProfileModal);
      }
      if (cancelProfileBtn) {
        cancelProfileBtn.addEventListener('click', hideProfileModal);
      }

      // Click outside modal to close
      const profileModal = document.getElementById('profile-modal');
      if (profileModal) {
        profileModal.addEventListener('click', (e) => {
          if (e.target === profileModal) {
            hideProfileModal();
          }
        });
      }

      // Close user profile view modal
      const closeUserProfileViewModal = document.getElementById('close-user-profile-view-modal');
      const closeUserProfileViewBtn = document.getElementById('close-user-profile-view-btn');
      if (closeUserProfileViewModal) {
        closeUserProfileViewModal.addEventListener('click', hideUserProfileViewModal);
      }
      if (closeUserProfileViewBtn) {
        closeUserProfileViewBtn.addEventListener('click', hideUserProfileViewModal);
      }

      // Click outside user profile view modal to close
      const userProfileViewModal = document.getElementById('user-profile-view-modal');
      if (userProfileViewModal) {
        userProfileViewModal.addEventListener('click', (e) => {
          if (e.target === userProfileViewModal) {
            hideUserProfileViewModal();
          }
        });
      }

      // Bio character count
      const bioInput = document.getElementById('profile-bio');
      if (bioInput) {
        bioInput.addEventListener('input', updateBioCharCount);
      }

      // Avatar upload
      setupAvatarUpload();

      // Copy wallet address
      setupCopyWallet();

      // Profile form submission
      const profileForm = document.getElementById('profile-form');
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('profile-username').value.trim();
          const bio = document.getElementById('profile-bio').value.trim();
          const avatarPreview = document.getElementById('avatar-preview');
          
          if (!username) {
            alert('Please enter a username');
            return;
          }

          // Get avatar data
          let avatar = null;
          const avatarImg = avatarPreview.querySelector('img');
          if (avatarImg) {
            avatar = avatarImg.src;
          }

          const profileData = {
            username,
            bio,
            avatar
          };

          const success = await saveUserProfile(profileData);
          if (success) {
            hideProfileModal();
            alert('Profile saved successfully!');
            
            // Re-render diaries and comments to show new username and avatar
            renderPublicDiaries();
            renderFeaturedDiaries();
            if (currentWallet) {
              loadPrivateDiaries();
            }
          }
        });
      }
    }

    // Initialize comment functionality
    function initializeComments(diaryId) {
      // Load existing comments
      loadComments(diaryId);
      
      // Setup comment input listeners
      setupCommentInput(diaryId);
      
      // Listen for new comments
      listenToComments(diaryId);
      
      // Prevent chat area scroll event bubbling
      const commentsContainer = document.getElementById(`comments-list-${diaryId}`);
      if (commentsContainer) {
        commentsContainer.addEventListener('wheel', (e) => {
          e.stopPropagation();
        });
        
        commentsContainer.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        });
      }
    }

    // Load comments
    async function loadComments(diaryId) {
      const commentsList = document.getElementById(`comments-list-${diaryId}`);
      const commentCount = document.getElementById('comment-count');
      
      if (!commentsList) return;
      
      try {
        // Show loading state
        commentsList.innerHTML = `
          <div class="comment-loading">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            Loading comments...
          </div>
        `;
        
        // Get comments from Firebase
        const commentsRef = ref(db, `comments/${diaryId}`);
        const snapshot = await get(commentsRef);
        const comments = snapshot.val() || {};
        
        // Render comments
        renderComments(diaryId, comments);
        
        // Update comment count
        const commentCountNum = Object.keys(comments).length;
        if (commentCount) {
          commentCount.textContent = `${commentCountNum} comments`;
        }
      } catch (error) {
        console.error('Failed to load comments:', error);
        commentsList.innerHTML = `
          <div class="text-center text-red-500 py-8">
            <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Failed to load comments, please try again later</p>
          </div>
        `;
      }
    }

    // Render comment list
    function renderComments(diaryId, comments) {
      const commentsList = document.getElementById(`comments-list-${diaryId}`);
      const commentCount = document.getElementById('comment-count');
      
      if (!commentsList) return;
      
      const commentEntries = Object.entries(comments);
      
      if (commentEntries.length === 0) {
        commentsList.innerHTML = `
          <div class="text-center text-neutral-500 py-8">
            <i class="fa fa-comment-o text-2xl mb-2"></i>
            <p>No comments yet, be the first to leave one!</p>
          </div>
        `;
        if (commentCount) commentCount.textContent = '0 comments';
        return;
      }
      
      // Sort by time
      const sortedComments = commentEntries
        .map(([id, comment]) => ({ id, ...comment }))
        .sort((a, b) => a.timestamp - b.timestamp);
      
      const commentsHtml = sortedComments.map(comment => {
        const userAvatar = getUserAvatar(comment.authorWallet);
        const avatarHtml = userAvatar 
          ? `<img src="${userAvatar}" alt="Avatar" class="w-full h-full object-cover rounded-full">`
          : comment.author.charAt(0).toUpperCase();
        
        return `
          <div class="comment-item">
            <div class="comment-header">
              <div class="comment-author">
                <div class="comment-avatar cursor-pointer hover:opacity-80 transition-opacity" onclick="viewUserProfile('${comment.authorWallet}')">
                  ${avatarHtml}
                </div>
                <div class="comment-meta">
                  <div class="comment-author-name cursor-pointer hover:text-primary transition-colors" onclick="viewUserProfile('${comment.authorWallet}')">${comment.author}</div>
                  <div class="comment-time">${formatDate(comment.timestamp)}</div>
                </div>
              </div>
            </div>
            <div class="comment-content">${escapeHtml(comment.content)}</div>
          </div>
        `;
      }).join('');
      
      commentsList.innerHTML = commentsHtml;
      
      // Update comment count
      if (commentCount) {
        commentCount.textContent = `${commentEntries.length} comments`;
      }
      
      // Scroll to bottom
      setTimeout(() => {
        commentsList.scrollTop = commentsList.scrollHeight;
      }, 100);
    }

    // Setup comment input listeners
    function setupCommentInput(diaryId) {
      const commentInput = document.getElementById(`comment-input-${diaryId}`);
      const sendButton = document.getElementById(`send-comment-${diaryId}`);
      
      if (!commentInput || !sendButton) return;
      
      // Input listener
      commentInput.addEventListener('input', function() {
        const hasContent = this.value.trim().length > 0;
        sendButton.disabled = !hasContent;
      });
      
      // Send button click
      sendButton.addEventListener('click', () => {
        sendComment(diaryId);
      });
      
      // Enter to send
      commentInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendButton.disabled) {
            sendComment(diaryId);
          }
        }
      });
    }

    // Send comment
    async function sendComment(diaryId) {
      const commentInput = document.getElementById(`comment-input-${diaryId}`);
      const sendButton = document.getElementById(`send-comment-${diaryId}`);
      
      if (!commentInput || !sendButton || !currentWallet) return;
      
      const content = commentInput.value.trim();
      if (!content) return;
      
      try {
        // Disable input
        commentInput.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Sending...';
        
        // Create comment data
        const comment = {
          content: content,
          author: getUserDisplayName(currentWallet),
          authorWallet: currentWallet,
          timestamp: Date.now()
        };
        
        // Save to Firebase
        const commentsRef = ref(db, `comments/${diaryId}`);
        await push(commentsRef, comment);
        
        // Clear input
        commentInput.value = '';
        commentInput.disabled = false;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>Send';
        
        // Focus input
        commentInput.focus();
        
      } catch (error) {
        console.error('Failed to send comment:', error);
        alert('Failed to send comment, please try again later');
        
        // Restore input state
        commentInput.disabled = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>Send';
      }
    }

    // Listen for comment changes
    function listenToComments(diaryId) {
      // Remove previous listener
      if (commentListeners[diaryId]) {
        commentListeners[diaryId]();
        delete commentListeners[diaryId];
      }
      
      // Set up new listener
      const commentsRef = ref(db, `comments/${diaryId}`);
      const unsubscribe = onValue(commentsRef, (snapshot) => {
        const comments = snapshot.val() || {};
        renderComments(diaryId, comments);
        
        // Update comment count on diary card
        updateDiaryCardCommentCount(diaryId, Object.keys(comments).length);
      });
      
      commentListeners[diaryId] = unsubscribe;
    }

    // Update comment count on diary card
    function updateDiaryCardCommentCount(diaryId, count) {
      const commentCountElement = document.querySelector(`.comment-count-${diaryId}`);
      if (commentCountElement) {
        commentCountElement.textContent = count;
      }
    }

    // Load comment counts for all diaries
    async function loadAllCommentCounts(diaries) {
      for (const diary of diaries) {
        try {
          const commentsRef = ref(db, `comments/${diary.id}`);
          const snapshot = await get(commentsRef);
          const comments = snapshot.val() || {};
          const count = Object.keys(comments).length;
          updateDiaryCardCommentCount(diary.id, count);
        } catch (error) {
          console.error(`Failed to load comment count for diary ${diary.id}:`, error);
          updateDiaryCardCommentCount(diary.id, 0);
        }
      }
    }

    // Like functionality
    async function toggleLike(diaryId) {
      if (!currentWallet) {
        alert('Please connect wallet first');
        return;
      }

      try {
        const diaryRef = ref(db, `diaryEntries/${diaryId}`);
        const snapshot = await get(diaryRef);
        const diary = snapshot.val();
        
        if (!diary) {
          console.error('Diary does not exist');
          return;
        }

        // Initialize likedBy object
        if (!diary.likedBy) {
          diary.likedBy = {};
        }

        const isLiked = diary.likedBy[currentWallet];
        
        if (isLiked) {
          // Unlike
          delete diary.likedBy[currentWallet];
        } else {
          // Like
          diary.likedBy[currentWallet] = Date.now();
        }

        // Update database
        await update(ref(db, `diaryEntries/${diaryId}`), {
          likedBy: diary.likedBy
        });

        // Update UI
        updateLikeUI(diaryId, diary.likedBy);
        
        // Reorder diary list
        await reorderDiariesByLikes(diaryId);

      } catch (error) {
        console.error('Like operation failed:', error);
        alert('Like failed, please try again later');
      }
    }

    // Update like UI
    function updateLikeUI(diaryId, likedBy) {
      const likeCount = likedBy ? Object.keys(likedBy).length : 0;
      const isLiked = likedBy && likedBy[currentWallet];

      // Update like button on diary card
      const likeBtn = document.querySelector(`.like-btn[data-diary-id="${diaryId}"]`);
      if (likeBtn) {
        const icon = likeBtn.querySelector('i');
        const countSpan = likeBtn.querySelector(`.like-count-${diaryId}`);
        
        icon.className = `fa ${isLiked ? 'fa-heart text-red-500' : 'fa-heart-o'} mr-1`;
        if (countSpan) countSpan.textContent = likeCount;
        
        likeBtn.setAttribute('data-liked', isLiked.toString());
        likeBtn.classList.toggle('liked', isLiked);
      }

      // Update like button in modal
      const modalLikeBtn = document.querySelector(`.modal-like-btn[data-diary-id="${diaryId}"]`);
      if (modalLikeBtn) {
        const icon = modalLikeBtn.querySelector('i');
        const countSpan = modalLikeBtn.querySelector(`.modal-like-count-${diaryId}`);
        
        icon.className = `fa ${isLiked ? 'fa-heart text-red-500' : 'fa-heart-o text-neutral-500'} mr-2`;
        if (countSpan) countSpan.textContent = likeCount;
        
        modalLikeBtn.setAttribute('data-liked', isLiked.toString());
        modalLikeBtn.classList.toggle('liked', isLiked);
      }
    }

    // Reorder diaries by likes
    async function reorderDiariesByLikes(diaryId) {
      try {
        // Update current diary's like count
        const currentDiary = allDiaries.find(d => d.id === diaryId);
        if (currentDiary) {
          currentDiary.likeCount = currentDiary.likedBy ? Object.keys(currentDiary.likedBy).length : 0;
        }

        // Reorder allDiaries array
        allDiaries.sort((a, b) => {
          // First sort by likes in descending order
          if (b.likeCount !== a.likeCount) {
            return b.likeCount - a.likeCount;
          }
          // If likes are the same, sort by timestamp in descending order
          return b.timestamp - a.timestamp;
        });
        
        // Re-render public diaries
        renderPublicDiaries();
        
        // Re-render featured diaries
        renderFeaturedDiaries();
        
      } catch (error) {
        console.error('Failed to reorder diaries:', error);
      }
    }

    // Initialize like buttons
    function initializeLikeButtons(diaryId) {
      // Add event listener for like button in modal
      const modalLikeBtn = document.querySelector(`.modal-like-btn[data-diary-id="${diaryId}"]`);
      if (modalLikeBtn) {
        modalLikeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleLike(diaryId);
        });
      }
    }

    // Add like event listeners to diary cards
    function setupDiaryCardLikeButtons() {
      document.addEventListener('click', (e) => {
        if (e.target.closest('.like-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const likeBtn = e.target.closest('.like-btn');
          const diaryId = likeBtn.getAttribute('data-diary-id');
          if (diaryId) {
            toggleLike(diaryId);
          }
        }
        
        // Featured diary card click event
        if (e.target.closest('.featured-diary-card')) {
          e.preventDefault();
          e.stopPropagation();
          const featuredCard = e.target.closest('.featured-diary-card');
          const diaryId = featuredCard.getAttribute('data-diary-id');
          if (diaryId) {
            const diary = allDiaries.find(d => d.id === diaryId);
            if (diary) {
              showDiaryModal(diary);
            }
          }
        }
      });
    }

    // Featured diaries functionality
    function renderFeaturedDiaries() {
      const container = document.getElementById('featured-diaries-grid');
      if (!container) return;

      // Get top 3 public diaries by likes
      const publicDiaries = allDiaries.filter(d => d.public !== false);
      const topDiaries = publicDiaries
        .sort((a, b) => {
          const aLikes = a.likedBy ? Object.keys(a.likedBy).length : 0;
          const bLikes = b.likedBy ? Object.keys(b.likedBy).length : 0;
          return bLikes - aLikes;
        })
        .slice(0, 3);

      if (topDiaries.length === 0) {
        container.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
            <i class="fa fa-book-o text-neutral-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-medium text-neutral-600 mb-2">No featured diaries yet</h3>
            <p class="text-neutral-500">Waiting for community members to share exciting content</p>
          </div>
        `;
        return;
      }

      const featuredHtml = topDiaries.map((diary, index) => {
        const rank = index + 1;
        const likeCount = diary.likedBy ? Object.keys(diary.likedBy).length : 0;
        const preview = diary.content.length > 100 ? diary.content.substring(0, 100) + '...' : diary.content;
        const author = getUserDisplayName(diary.wallet);
        
        return `
          <div class="featured-diary-card rank-${rank}" data-diary-id="${diary.id}">
            <div class="featured-rank-badge rank-${rank}">
              ${rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉'}
            </div>
            
            <div class="featured-diary-author">
              <div class="featured-diary-avatar cursor-pointer hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">
                ${(() => {
                  const userAvatar = getUserAvatar(diary.wallet);
                  return userAvatar 
                    ? `<img src="${userAvatar}" alt="Avatar" class="w-full h-full object-cover rounded-full">`
                    : author.charAt(0).toUpperCase();
                })()}
              </div>
              <div class="featured-diary-author-info">
                <div class="featured-diary-author-name cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">${author}</div>
                <div class="featured-diary-time">${formatDate(diary.timestamp)}</div>
              </div>
            </div>
            
            <h3 class="featured-diary-title">${escapeHtml(diary.title || 'Untitled')}</h3>
            <p class="featured-diary-content">${escapeHtml(preview)}</p>
            
            <div class="featured-diary-meta">
              <div class="featured-diary-stats">
                <div class="featured-diary-stat likes">
                  <i class="fa fa-heart"></i>
                  <span>${likeCount}</span>
                </div>
                <div class="featured-diary-stat comments">
                  <i class="fa fa-comment"></i>
                  <span class="comment-count-${diary.id}">0</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = featuredHtml;
      
      // Load comment counts
      loadFeaturedCommentCounts(topDiaries);
    }

    // Load comment counts for featured diaries
    async function loadFeaturedCommentCounts(diaries) {
      for (const diary of diaries) {
        try {
          const commentsRef = ref(db, `comments/${diary.id}`);
          const snapshot = await get(commentsRef);
          const comments = snapshot.val() || {};
          const count = Object.keys(comments).length;
          
          const commentCountElement = document.querySelector(`#featured-diaries-grid .comment-count-${diary.id}`);
          if (commentCountElement) {
            commentCountElement.textContent = count;
          }
        } catch (error) {
          console.error(`Failed to load comment count for featured diary ${diary.id}:`, error);
        }
      }
    }

    // Utility functions
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const utcDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
      return utcDate.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'UTC'
      }) + ' UTC';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }


    
    // Debug functions
    window.debugUserProfiles = function() {
      console.log('=== User Profile Debug Info ===');
      console.log('Current wallet address:', currentWallet);
      console.log('Current user profile:', currentUserProfile);
      console.log('All user profile cache:', userProfiles);
      console.log('localStorage prompt status:', Object.keys(localStorage).filter(key => key.startsWith('profile_prompted_')));
      
      if (currentWallet) {
        console.log('Checking user profile in Firebase...');
        loadUserProfile(currentWallet).then(profile => {
          console.log('User profile in Firebase:', profile);
        });
      }
    };

    // 删除日记及其评论
    async function deleteDiary(diaryId) {
      try {
        // 删除日记本身
        await remove(ref(db, `diaryEntries/${diaryId}`));
        // 删除评论
        await remove(ref(db, `comments/${diaryId}`));
        // 刷新数据
        if (typeof loadDiaries === 'function') {
          loadDiaries();
        }
        // 可选：显示提示
        alert('Diary deleted successfully.');
      } catch (error) {
        console.error('Failed to delete diary:', error);
        alert('Failed to delete diary. Please try again.');
      }
    }
  </script>
</body>
</html>
    
