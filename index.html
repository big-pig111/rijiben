<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>链上日记时光 - 分享生活的点滴</title>
  <!-- 引入外部资源 -->
  <!-- Tailwind CSS - 生产环境优化版本 -->
  <script>
    // 禁用生产环境警告
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            'primary/5': 'rgba(79, 70, 229, 0.05)',
            'primary/10': 'rgba(79, 70, 229, 0.1)',
            'primary/50': 'rgba(79, 70, 229, 0.5)',
            'primary/80': 'rgba(79, 70, 229, 0.8)',
            'primary/90': 'rgba(79, 70, 229, 0.9)'
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  <script>
    // 覆盖生产环境警告
    console.warn = function() {
      if (arguments[0] && arguments[0].includes('cdn.tailwindcss.com should not be used in production')) {
        return;
      }
      console.log.apply(console, arguments);
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- 配置Tailwind主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5', // 深紫色主色调
            secondary: '#ec4899', // 粉色辅助色
            neutral: {
              50: '#fafafa',
              100: '#f5f5f5',
              200: '#e5e5e5',
              300: '#d4d4d4',
              600: '#525252',
              700: '#404040',
              800: '#262626',
              900: '#171717'
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Merriweather', 'Georgia', 'serif']
          }
        }
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .page-transition {
        transition: opacity 0.4s ease, transform 0.4s ease;
      }
      .nav-active {
        @apply text-primary border-primary;
      }
    }
  </style>
  
  <style>
    /* 基础样式 */
    body {
      overflow-x: hidden;
      /* 确保手机端可以正常滚动 */
      -webkit-overflow-scrolling: touch;
    }
    
    /* 手机端优化 */
    @media (max-width: 768px) {
      /* 防止模态框内容超出屏幕 */
      .modal-content,
      .diary-modal-content {
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* 确保手机端菜单可以滚动 */
      #mobile-menu {
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* 修复固定定位的模态框在手机端的问题 */
      .fixed {
        position: fixed;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      /* 确保内容不会被键盘遮挡 */
      input:focus,
      textarea:focus {
        position: relative;
        z-index: 1;
      }
      
      /* 优化表单容器在手机端的显示 */
      .page-container {
        padding-bottom: 80px; /* 为底部留出空间 */
      }
      
      /* 确保发布按钮在手机端始终可见 */
      #publish-btn {
        position: relative;
        z-index: 10;
      }
      
      /* 优化手机端的padding和margin */
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      /* 调整手机端模态框的位置 */
      .diary-modal-content,
      .modal-content {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
      }
      
      /* 防止横向滚动 */
      * {
        max-width: 100vw;
      }
      
      /* 优化手机端的触摸体验 */
      button,
      a,
      .clickable {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      /* 确保日记网格在手机端正常显示 */
      #diaries-grid,
      #private-diaries-grid,
      #featured-diaries-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* 调整精选日记在手机端的显示 */
      .featured-diary-card {
        padding: 1rem;
      }
      
      /* 确保统计卡片在手机端正常堆叠 */
      .grid {
        grid-template-columns: 1fr;
      }
      
      /* 优化手机端的文字大小 */
      h1 {
        font-size: 1.875rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      h3 {
        font-size: 1.25rem;
      }
      
      /* 确保底部有足够的滚动空间 */
      main {
        padding-bottom: 2rem;
      }
    }
    
    /* 页面容器样式 */
    .page-container {
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }
    
    .page-container.active {
      display: block;
      animation: pageIn 0.5s forwards;
    }
    
    @keyframes pageIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* 导航下划线动画 */
    .nav-link {
      position: relative;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #4f46e5;
      transition: width 0.3s ease;
    }
    
    .nav-link.nav-active::after {
      width: 100%;
    }
    
    /* 移动端导航链接样式 */
    .mobile-nav-link {
      color: #525252;
      transition: all 0.3s ease;
    }
    
    .mobile-nav-link.nav-active {
      background-color: #4f46e510;
      color: #4f46e5;
    }
    
    /* 日记卡片悬停效果 */
    .diary-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .diary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    /* 筛选按钮样式 */
    .filter-btn {
      transition: all 0.3s ease;
    }
    
    .filter-btn.active {
      background-color: #4f46e5;
      color: white;
    }
    
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* 精美钱包连接按钮 */
    .wallet-btn {
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .wallet-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .wallet-btn:hover::before {
      left: 100%;
    }

    .wallet-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .wallet-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* 连接状态样式 */
    .wallet-btn.connected {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .wallet-btn.connected:hover {
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
    }

    .wallet-btn.disconnected {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .wallet-btn.disconnected:hover {
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
    }

    .wallet-btn.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }

    .wallet-btn.error:hover {
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
    }

    /* 钱包图标动画 */
    .wallet-btn .wallet-icon {
      transition: transform 0.3s ease;
    }

    .wallet-btn:hover .wallet-icon {
      transform: scale(1.1);
    }

    .wallet-btn.connected .wallet-icon {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* 状态指示器 */
    .wallet-status-indicator {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      transition: all 0.3s ease;
    }

    .wallet-status-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .wallet-status-indicator.disconnected {
      background: #f59e0b;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    .wallet-status-indicator.error {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    /* 加载动画 */
    .wallet-btn.loading {
      pointer-events: none;
    }

    .wallet-btn.loading .wallet-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
      .wallet-btn {
        padding: 10px 20px;
        font-size: 13px;
        min-width: 120px;
      }
    }

    /* 精美标签选择样式 */
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .tag-item {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #64748b;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      min-width: 60px;
      justify-content: center;
    }

    .tag-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .tag-item:hover::before {
      left: 100%;
    }

    .tag-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .tag-item input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* 标签选中状态 */
    .tag-item.checked {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      border-color: #4f46e5;
      box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
      transform: translateY(-1px);
    }

    .tag-item.checked::after {
      content: '✓';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      animation: checkmark 0.3s ease forwards;
    }

    @keyframes checkmark {
      0% {
        opacity: 0;
        transform: translateY(-50%) scale(0.5);
      }
      100% {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    }

    /* 不同标签的颜色主题 */
    .tag-item[data-tag="生活"] {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-color: #fbbf24;
    }

    .tag-item[data-tag="生活"].checked {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: #f59e0b;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
    }

    .tag-item[data-tag="旅行"] {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
      border-color: #3b82f6;
    }

    .tag-item[data-tag="旅行"].checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .tag-item[data-tag="感悟"] {
      background: linear-gradient(135deg, #e9d5ff 0%, #c084fc 100%);
      color: #7c3aed;
      border-color: #a855f7;
    }

    .tag-item[data-tag="感悟"].checked {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: white;
      border-color: #a855f7;
      box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3);
    }

    .tag-item[data-tag="读书"] {
      background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);
      color: #166534;
      border-color: #22c55e;
    }

    .tag-item[data-tag="读书"].checked {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      border-color: #22c55e;
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
    }

    .tag-item[data-tag="工作"] {
      background: linear-gradient(135deg, #f3e8ff 0%, #c4b5fd 100%);
      color: #6b21a8;
      border-color: #8b5cf6;
    }

    .tag-item[data-tag="工作"].checked {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-color: #8b5cf6;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
    }

    .tag-item[data-tag="美食"] {
      background: linear-gradient(135deg, #fed7d7 0%, #fca5a5 100%);
      color: #991b1b;
      border-color: #ef4444;
    }

    .tag-item[data-tag="美食"].checked {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-color: #ef4444;
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
    }

    /* 标签选择器容器 */
    .tag-selector-container {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }

    .tag-selector-container label {
      color: #475569;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 16px;
      display: block;
    }

    /* 响应式设计 */
    @media (max-width: 640px) {
      .tag-selector {
        gap: 8px;
      }
      
      .tag-item {
        padding: 6px 12px;
        font-size: 13px;
        min-width: 50px;
      }
    }

    /* 精美日记详情弹窗样式 */
    .diary-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    .diary-modal-content {
      animation: modalSlideIn 0.3s ease-out;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      isolation: isolate;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes modalFadeOut {
      from { 
        opacity: 1;
      }
      to { 
        opacity: 0;
      }
    }

    /* 日记卡片悬停效果 */
    .diary-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .diary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      border-color: #4f46e5;
    }

    /* 阅读全文按钮样式 */
    .read-more-btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .read-more-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
      transition: left 0.5s;
    }

    .read-more-btn:hover::before {
      left: 100%;
    }

    .read-more-btn:hover {
      transform: translateX(4px);
    }

    /* 弹窗内容样式 */
    .diary-content {
      line-height: 1.8;
      font-size: 16px;
      color: #374151;
    }

    .diary-title {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* 区块链信息样式 */
    .blockchain-info {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #0ea5e9;
      border-radius: 12px;
    }

    .blockchain-info.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-color: #ef4444;
    }

    /* 聊天留言样式 */
    .chat-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 24px;
    }

    .comments-container {
      scrollbar-width: thin;
      scrollbar-color: #d1d5db #f3f4f6;
      display: flex;
      flex-direction: column;
      position: relative;
      scroll-behavior: smooth;
      overflow-y: auto;
      overflow-x: hidden;
      isolation: isolate;
    }

    .comments-container::-webkit-scrollbar {
      width: 6px;
    }

    .comments-container::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 3px;
    }

    .comments-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .comments-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* 微信风格的聊天区域 */
    .chat-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 24px;
      display: flex;
      flex-direction: column;
      height: 500px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    
    @media (max-width: 768px) {
      .chat-section {
        height: 350px; /* 手机端调整高度 */
        padding-top: 16px;
      }
    }

    .chat-header {
      flex-shrink: 0;
      margin-bottom: 16px;
    }

    .chat-messages {
      flex: 1;
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    .chat-input-area {
      flex-shrink: 0;
      margin-top: 16px;
    }



    /* 微信风格的消息布局 */
    .comments-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .comment-item {
      background: #f0f9ff;
      border: 1px solid #e0f2fe;
      border-radius: 18px;
      padding: 12px 16px;
      margin-bottom: 8px;
      position: relative;
      max-width: 85%;
      align-self: flex-start;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .comment-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 6px solid #f0f9ff;
    }

    .comment-item::after {
      content: '';
      position: absolute;
      left: -7px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 6px solid #e0f2fe;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comment-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      flex-shrink: 0;
    }

    .comment-meta {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .comment-author-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .comment-time {
      font-size: 11px;
      color: #6b7280;
    }

    .comment-content {
      color: #1f2937;
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
      word-break: break-word;
    }

    .comment-input-section textarea {
      transition: all 0.2s ease;
    }

    .comment-input-section textarea:focus {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .send-comment-btn {
      transition: all 0.2s ease;
    }

    .send-comment-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-comment-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* 个人资料按钮样式 */
    .profile-btn {
      position: relative;
      overflow: hidden;
    }

    .profile-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(79, 70, 229, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .profile-btn:active::before {
      width: 40px;
      height: 40px;
    }

    .profile-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* 钱包按钮断开连接样式 */
    .wallet-btn.connected {
      position: relative;
    }

    .wallet-btn.connected::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
      animation: pulse 2s infinite;
    }

    .wallet-btn.connected:hover::after {
      background: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    /* 断开连接菜单样式 */
    #disconnect-menu {
      animation: menuSlideIn 0.2s ease-out;
    }
    
    @media (max-width: 768px) {
      #disconnect-menu {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: auto;
        top: auto;
        max-width: 90vw;
      }
    }

    @keyframes menuSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* 头像上传样式 */
    #avatar-preview {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #avatar-preview.has-image {
      background-image: none;
    }

    #avatar-preview.has-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    /* 个人资料弹窗动画 */
    #profile-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    #profile-modal .bg-white {
      animation: modalSlideIn 0.3s ease-out;
    }

    /* 用户资料查看弹窗动画 */
    #user-profile-view-modal {
      animation: modalFadeIn 0.3s ease-out;
    }

    #user-profile-view-modal .bg-white {
      animation: modalSlideIn 0.3s ease-out;
    }

    /* 微信风格的输入区域 */
    .chat-input-area {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      border-radius: 0 0 12px 12px;
    }

    .chat-input-area textarea {
      border-radius: 20px;
      border: 1px solid #d1d5db;
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.4;
      resize: none;
      transition: all 0.2s ease;
    }

    .chat-input-area textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .chat-input-area button {
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .chat-input-area button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* 留言加载动画 */
    .comment-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #6b7280;
    }

    .comment-loading i {
      animation: spin 1s linear infinite;
    }

    /* 点赞按钮样式 */
    .like-btn {
      position: relative;
      overflow: hidden;
    }

    .like-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .like-btn:active::before {
      width: 40px;
      height: 40px;
    }

    .like-btn.liked {
      color: #ef4444;
    }

    .like-btn.liked i {
      animation: heartBeat 0.6s ease;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .modal-like-btn {
      position: relative;
      overflow: hidden;
    }

    .modal-like-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .modal-like-btn:active::before {
      width: 60px;
      height: 60px;
    }

    .modal-like-btn.liked {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .modal-like-btn.liked i {
      animation: heartBeat 0.6s ease;
    }

    /* 精选日记样式 */
    .featured-diary-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .featured-diary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    }

    .featured-diary-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      border-color: #f59e0b;
    }

    .featured-diary-card.rank-1::before {
      background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
    }

    .featured-diary-card.rank-2::before {
      background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%);
    }

    .featured-diary-card.rank-3::before {
      background: linear-gradient(90deg, #d97706 0%, #b45309 100%);
    }

    .featured-rank-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
    }

    .featured-rank-badge.rank-1 {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .featured-rank-badge.rank-2 {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }

    .featured-rank-badge.rank-3 {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
    }

    .featured-diary-title {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .featured-diary-content {
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 16px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .featured-diary-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #9ca3af;
    }

    .featured-diary-stats {
      display: flex;
      gap: 16px;
    }

    .featured-diary-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .featured-diary-stat.likes {
      color: #ef4444;
    }

    .featured-diary-stat.comments {
      color: #3b82f6;
    }

    .featured-diary-author {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.75rem;
    }

    .featured-diary-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.875rem;
      overflow: hidden;
    }

    .featured-diary-author-info {
      flex: 1;
    }

    .featured-diary-author-name {
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }

    .featured-diary-time {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.125rem;
    }

    /* 自定义单选按钮样式 */
    .custom-radio {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .custom-radio.checked {
      border-color: #4f46e5;
      background-color: #4f46e5;
    }

    .custom-radio.checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background-color: white;
      border-radius: 50%;
    }

    .custom-radio:hover {
      border-color: #4f46e5;
      transform: scale(1.05);
    }
  </style>
</head>

<body class="bg-neutral-50 font-sans text-neutral-800">
  <!-- 导航栏 -->
  <header class="sticky top-0 z-40 bg-white shadow-sm border-b border-neutral-200">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16 md:h-20">
        <!-- Logo -->
        <a href="#" class="flex items-center space-x-2 page-link" data-page="home">
          <i class="fa fa-link text-primary text-2xl"></i>
          <span class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">链上日记时光</span>
        </a>
        
        <!-- 桌面导航 -->
        <nav class="hidden md:flex items-center space-x-8">
          <a href="#" class="nav-link nav-active text-neutral-800 font-medium transition-colors" data-page="home">首页</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="upload">写日记</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="public">公共日记</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="private">我的日记</a>
          <a href="#" class="nav-link text-neutral-600 font-medium transition-colors" data-page="stats">数据统计</a>
        </nav>
        
        <!-- 用户区域 -->
        <div class="flex items-center space-x-4">
          <button id="wallet-btn" class="wallet-btn disconnected hidden md:flex">
            <i class="fa fa-wallet wallet-icon"></i>
            <span id="wallet-text">连接钱包</span>
            <div id="wallet-status" class="wallet-status-indicator disconnected"></div>
          </button>
          
          <!-- 个人资料设置按钮 -->
          <button id="profile-btn" class="profile-btn hidden md:flex items-center px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 font-medium transition-all shadow-lg hover:shadow-xl hover:bg-neutral-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <div class="profile-icon mr-2">
              <i class="fa fa-user"></i>
            </div>
            <span>个人资料</span>
          </button>
          
          <!-- 移动端菜单按钮 -->
          <button id="mobile-menu-btn" class="md:hidden text-neutral-700">
            <i class="fa fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 移动端导航菜单 -->
    <div id="mobile-menu" class="md:hidden hidden bg-white border-t border-neutral-200">
      <div class="container mx-auto px-4 py-3">
        <div class="flex flex-col space-y-4 py-2">
          <a href="#" class="mobile-nav-link nav-active py-2 px-3 rounded-lg" data-page="home">
            <i class="fa fa-home mr-2"></i>首页
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="upload">
            <i class="fa fa-pencil mr-2"></i>写日记
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="public">
            <i class="fa fa-book mr-2"></i>公共日记
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="private">
            <i class="fa fa-lock mr-2"></i>我的日记
          </a>
          <a href="#" class="mobile-nav-link py-2 px-3 rounded-lg" data-page="stats">
            <i class="fa fa-bar-chart mr-2"></i>数据统计
          </a>
          <!-- 手机端个人资料按钮 -->
          <button id="mobile-profile-btn" class="w-full py-2 px-3 rounded-lg bg-neutral-100 text-neutral-700 font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed text-left" disabled>
            <i class="fa fa-user mr-2"></i>个人资料
          </button>
          <button id="mobile-wallet-btn" class="wallet-btn disconnected flex items-center justify-center mt-2">
            <i class="fa fa-wallet wallet-icon"></i>
            <span id="mobile-wallet-text">连接钱包</span>
            <div id="mobile-wallet-status" class="wallet-status-indicator disconnected"></div>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="min-h-[calc(100vh-4rem)] pt-1">
    <!-- 首页 -->
    <section id="home" class="page-container active">
      <!-- 英雄区域 -->
      <div class="relative bg-gradient-to-br from-primary/5 to-secondary/5 py-20 md:py-32 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10">
          <i class="fa fa-pencil absolute top-20 right-20 text-[150px] text-primary"></i>
          <i class="fa fa-book absolute bottom-10 left-10 text-[120px] text-secondary"></i>
        </div>
        
        <div class="container mx-auto px-4 relative z-10">
          <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-neutral-800 leading-tight mb-6">
              记录生活的<span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">链上时光</span>
            </h1>
            <p class="text-lg md:text-xl text-neutral-700 mb-10 leading-relaxed max-w-2xl mx-auto">
              基于区块链技术的去中心化日记平台，让你的每一段文字都永久保存在链上，
              既可以公开分享，也可以私密收藏，真正属于你的数字记忆。
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
              <a href="#" class="page-link px-8 py-4 bg-primary text-white rounded-full hover:bg-primary/90 transition-all shadow-lg hover:shadow-xl font-medium text-lg" data-page="upload">
                <i class="fa fa-pencil mr-2"></i>开始记录
              </a>
              <a href="#" class="page-link px-8 py-4 bg-white text-primary border border-primary rounded-full hover:bg-primary/5 transition-all shadow-md hover:shadow-lg font-medium text-lg" data-page="public">
                <i class="fa fa-eye mr-2"></i>浏览日记
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 功能介绍 -->
      <div class="py-16 bg-white">
        <div class="container mx-auto px-4">
          <div class="text-center mb-16">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 mb-4">为什么选择我们</h2>
            <p class="text-neutral-600 max-w-2xl mx-auto">简单、优雅的日记体验，让记录成为一种享受</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-pencil-square-o text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">轻松记录</h3>
              <p class="text-neutral-600">简洁直观的编辑器，让你专注于内容创作，随时随地记录灵感与感悟。</p>
            </div>
            
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-share-alt text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">分享交流</h3>
              <p class="text-neutral-600">选择公开你的日记，与志同道合的人交流想法，发现更多生活视角。</p>
            </div>
            
            <div class="bg-neutral-50 rounded-xl p-8 shadow-sm hover:shadow-md transition-all border border-neutral-100">
              <div class="w-14 h-14 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                <i class="fa fa-bar-chart text-primary text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">数据洞察</h3>
              <p class="text-neutral-600">通过数据了解自己的记录习惯，发现创作规律，持续提升记录质量。</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 精选日记 -->
      <div class="py-16 bg-neutral-50">
        <div class="container mx-auto px-4">
          <div class="flex justify-between items-end mb-10">
            <div>
              <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 mb-2">精选日记</h2>
              <p class="text-neutral-600">发现社区中最受欢迎的精彩内容</p>
            </div>
            <a href="#" class="page-link text-primary hover:text-primary/80 font-medium hidden md:block" data-page="public">
              查看全部 <i class="fa fa-arrow-right ml-1"></i>
            </a>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto" id="featured-diaries-grid">
            <!-- 精选日记卡片将通过JavaScript动态生成 -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-spinner fa-spin text-neutral-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-medium text-neutral-600 mb-2">加载精选日记中...</h3>
              <p class="text-neutral-500">正在获取最受欢迎的日记</p>
                    </div>
          </div>
          
          <div class="text-center mt-8 md:hidden">
            <a href="#" class="page-link inline-block px-5 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors" data-page="public">
              查看更多日记
            </a>
          </div>
        </div>
      </div>
      
      <!-- 行动召唤 -->
      <div class="py-16 bg-gradient-to-r from-primary to-primary/80 text-white">
        <div class="container mx-auto px-4 text-center">
          <h2 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold mb-6">开始记录你的故事</h2>
          <p class="max-w-2xl mx-auto mb-8 text-white/90 text-lg">
            每一段经历都值得被铭记，每一个想法都值得被记录。加入我们，分享你的生活点滴。
          </p>
          <a href="#" class="page-link inline-flex items-center px-8 py-4 bg-white text-primary rounded-full hover:bg-neutral-100 transition-all shadow-lg font-medium text-lg" data-page="upload">
            <i class="fa fa-pencil-square-o mr-2"></i>立即写日记
          </a>
        </div>
      </div>
    </section>

    <!-- 写日记页面 -->
    <section id="upload" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-pencil-square-o text-primary mr-2"></i>写下你的日记
            </h1>
            <p class="text-neutral-600">记录生活中的思考、感悟与美好，留下属于自己的独特印记</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8 border border-neutral-200">
            <form id="diary-form" class="space-y-6">
              <!-- 标题输入 -->
              <div>
                <label for="diary-title" class="block text-sm font-medium text-neutral-700 mb-1">日记标题</label>
                <input 
                  type="text" 
                  id="diary-title" 
                  class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg"
                  placeholder="给你的日记起个标题吧..."
                  required
                >
              </div>
              
              <!-- 标签选择 -->
              <div class="tag-selector-container">
                <label>选择标签（可多选）</label>
                <div class="tag-selector">
                  <label class="tag-item" data-tag="生活">
                    <input type="checkbox" name="tags" value="生活">
                    <span>生活</span>
                  </label>
                  <label class="tag-item" data-tag="旅行">
                    <input type="checkbox" name="tags" value="旅行">
                    <span>旅行</span>
                  </label>
                  <label class="tag-item" data-tag="感悟">
                    <input type="checkbox" name="tags" value="感悟">
                    <span>感悟</span>
                  </label>
                  <label class="tag-item" data-tag="读书">
                    <input type="checkbox" name="tags" value="读书">
                    <span>读书</span>
                  </label>
                  <label class="tag-item" data-tag="工作">
                    <input type="checkbox" name="tags" value="工作">
                    <span>工作</span>
                  </label>
                  <label class="tag-item" data-tag="美食">
                    <input type="checkbox" name="tags" value="美食">
                    <span>美食</span>
                  </label>
                </div>
              </div>
              
              <!-- 日记内容 -->
              <div>
                <label for="diary-content" class="block text-sm font-medium text-neutral-700 mb-1">日记内容</label>
                <textarea 
                  id="diary-content" 
                  rows="10" 
                  class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
                  placeholder="今天发生了什么事？有什么想记录的呢..."
                  required
                ></textarea>
                <div class="flex justify-between items-center mt-2 text-sm text-neutral-500">
                  <span id="char-count">0 个字</span>
                  <button type="button" id="clear-content" class="hover:text-primary transition-colors">
                    <i class="fa fa-eraser mr-1"></i>清空
                  </button>
                </div>
              </div>
              
              <!-- 隐私设置 -->
              <div class="pt-2">
                <label class="block text-sm font-medium text-neutral-700 mb-2">隐私设置</label>
                <div class="flex items-center space-x-6">
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="privacy" value="public" class="sr-only" checked>
                    <div class="custom-radio checked mr-2"></div>
                    <span class="font-semibold text-primary">公开 - 所有人可见，上链存储</span>
                  </label>
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="privacy" value="private" class="sr-only">
                    <div class="custom-radio mr-2"></div>
                    <span>私密 - 仅自己可见，加密存储</span>
                  </label>
                </div>
                <p class="text-xs text-neutral-500 mt-2">
                  <i class="fa fa-info-circle mr-1"></i>
                  所有日记都会存储在区块链上，私密日记将使用你的钱包地址加密
                </p>
              </div>
              
              <!-- 钱包连接提示 -->
              <div id="wallet-warning" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <div class="flex items-center">
                  <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                  <span class="text-amber-700">请先连接钱包以发布日记到区块链</span>
                </div>
              </div>
              
              <!-- 上链选项 -->
              <div class="pt-2">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="enable-blockchain" class="sr-only peer" checked>
                  <div class="relative w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  <span class="ml-3 text-sm font-medium text-neutral-700">
                    尝试上链存储 
                    <span class="text-xs text-neutral-500">(失败时仍会保存到数据库)</span>
                  </span>
                </label>
              </div>
              
              <!-- 提交按钮 -->
              <div class="pt-4 flex flex-col sm:flex-row gap-4">
                <button 
                  type="submit" 
                  id="publish-btn"
                  class="flex-1 px-6 py-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow-md font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fa fa-paper-plane mr-2"></i>
                  <span id="publish-text">发布日记</span>
                  <div id="publish-spinner" class="hidden ml-2">
                    <i class="fa fa-spinner fa-spin"></i>
                  </div>
                </button>
                <button 
                  type="button" 
                  id="draft-btn"
                  class="flex-1 px-6 py-4 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-all font-medium flex items-center justify-center"
                >
                  <i class="fa fa-save mr-2"></i>保存草稿
                </button>
              </div>
            </form>
          </div>
          
          <!-- 写作提示 -->
          <div class="mt-10 bg-neutral-50 rounded-xl p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
              <i class="fa fa-lightbulb-o text-primary mr-2"></i>写作提示
            </h3>
            <ul class="space-y-2 text-neutral-700">
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>尽量使用具体的细节和感受来描述，让日记更生动</span>
              </li>
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>可以记录当天发生的事情，也可以写下对某件事的思考</span>
              </li>
              <li class="flex items-start">
                <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                <span>选择合适的标签可以让更多人看到你的日记</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- 公共日记页面 -->
    <section id="public" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
            <div class="flex items-center justify-between mb-2">
              <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800">
              <i class="fa fa-book text-primary mr-2"></i>公共日记
            </h1>
              <div class="flex items-center text-sm text-neutral-500 bg-neutral-100 px-3 py-1 rounded-full">
                <i class="fa fa-heart text-red-500 mr-1"></i>
                按点赞数排序
              </div>
            </div>
            <p class="text-neutral-600">浏览社区成员分享的精彩日记，感受不同的生活视角和思考方式</p>
          </div>
          
          <!-- 筛选和搜索 -->
          <div class="bg-white rounded-xl shadow-sm p-4 mb-8 border border-neutral-200">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm">
                  全部
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  生活
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  旅行
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  感悟
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  读书
                </button>
              </div>
              
              <div class="relative w-full md:w-auto">
                <input 
                  type="text" 
                  placeholder="搜索日记内容..." 
                  class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                >
                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400"></i>
              </div>
            </div>
          </div>
          
          <!-- 日记列表 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 暂无内容提示 -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-book-o text-neutral-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-medium text-neutral-600 mb-2">暂无公共日记</h3>
              <p class="text-neutral-500 mb-4">成为第一个分享日记的人吧！</p>
              <a href="#" class="page-link px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" data-page="upload">
                <i class="fa fa-pencil mr-2"></i>写第一篇日记
              </a>
                    </div>
                </div>
                
          <!-- 分页 -->
          <div class="mt-12 flex justify-center hidden">
            <nav class="flex items-center space-x-1">
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa fa-angle-left"></i>
                    </button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white">1</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">2</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">3</button>
              <span class="w-10 h-10 flex items-center justify-center">...</span>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">8</button>
              <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-neutral-300 text-neutral-600 hover:border-primary hover:text-primary transition-colors">
                <i class="fa fa-angle-right"></i>
                    </button>
            </nav>
                  </div>
                </div>
              </div>
    </section>

    <!-- 私人日记页面 -->
    <section id="private" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-lock text-primary mr-2"></i>我的私人日记
            </h1>
            <p class="text-neutral-600">查看你的私人日记，这些内容只有你能看到，数据已加密存储在区块链上</p>
                </div>
                
          <!-- 钱包连接提示 -->
          <div id="private-wallet-warning" class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                  <div class="flex items-center">
                <i class="fa fa-exclamation-triangle text-amber-500 text-xl mr-3"></i>
                    <div>
                  <h3 class="font-medium text-amber-800">需要连接钱包</h3>
                  <p class="text-amber-700 text-sm mt-1">请先连接你的钱包以查看私人日记</p>
                    </div>
                  </div>
              <button id="private-connect-wallet" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors">
                连接钱包
                    </button>
                  </div>
                </div>
          
          <!-- 筛选和搜索 -->
          <div id="private-controls" class="bg-white rounded-xl shadow-sm p-4 mb-8 border border-neutral-200 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm">
                  全部
                    </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  生活
                    </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  感悟
                  </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm hover:bg-neutral-200 transition-colors">
                  工作
                    </button>
                  </div>
              
              <div class="relative w-full md:w-auto">
                <input 
                  type="text" 
                  placeholder="搜索我的日记..." 
                  class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                >
                <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400"></i>
                    </div>
                  </div>
                </div>
                
          <!-- 私人日记列表 -->
          <div id="private-diary-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- 日记卡片将通过JavaScript动态生成 -->
          </div>
          
          <!-- 空状态 -->
          <div id="private-empty-state" class="flex flex-col items-center justify-center py-16 text-center hidden">
            <i class="fa fa-lock text-neutral-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-medium text-neutral-600 mb-2">还没有私人日记</h3>
            <p class="text-neutral-500 mb-4">写下你的第一篇私人日记吧</p>
            <a href="#" class="page-link px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" data-page="upload">
              <i class="fa fa-pencil mr-2"></i>写日记
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- 数据统计页面 -->
    <section id="stats" class="page-container py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-neutral-800 mb-2">
              <i class="fa fa-bar-chart text-primary mr-2"></i>社区数据统计
            </h1>
            <p class="text-neutral-600">探索我们社区的活跃度和内容分布，看看大家都在记录和分享什么</p>
          </div>
          
          <!-- 统计概览 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">总日记数</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="total-diaries">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-book text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>暂无数据</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">活跃用户</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="active-users">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-users text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>暂无数据</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">公开日记</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="public-diaries">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-eye text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>暂无数据</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-neutral-200">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-neutral-500 text-sm">总评论数</p>
                  <h3 class="text-3xl font-bold text-neutral-800 mt-1" id="total-comments">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <i class="fa fa-comments text-primary"></i>
                </div>
              </div>
              <div class="flex items-center text-neutral-400 text-sm">
                <i class="fa fa-minus mr-1"></i>
                <span>暂无数据</span>
              </div>
            </div>
          </div>
          
          <!-- 图表区域 -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <!-- 标签分布图表 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 lg:col-span-1">
              <h3 class="text-lg font-semibold mb-6">热门标签分布</h3>
              <div class="h-80 flex items-center justify-center">
                <div class="text-center">
                  <i class="fa fa-pie-chart text-neutral-300 text-6xl mb-4"></i>
                  <p class="text-neutral-500">暂无数据可展示</p>
              </div>
              </div>
            </div>
            
            <!-- 月度活跃度图表 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 lg:col-span-2">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">月度活跃度趋势</h3>
                <div class="flex space-x-2">
                  <button class="px-3 py-1 text-sm rounded-full bg-primary/10 text-primary">月度</button>
                  <button class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition-colors">季度</button>
                  <button class="px-3 py-1 text-sm rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 transition-colors">年度</button>
                </div>
              </div>
              <div class="h-80 flex items-center justify-center">
                <div class="text-center">
                  <i class="fa fa-line-chart text-neutral-300 text-6xl mb-4"></i>
                  <p class="text-neutral-500">暂无数据可展示</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 活跃度分析 -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200 mb-10">
            <h3 class="text-lg font-semibold mb-6">用户活跃时段分析</h3>
            <div class="h-80 flex items-center justify-center">
              <div class="text-center">
                <i class="fa fa-bar-chart text-neutral-300 text-6xl mb-4"></i>
                <p class="text-neutral-500">暂无数据可展示</p>
            </div>
            </div>
          </div>
          
          <!-- 热门日记排行 -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold mb-6">热门日记排行</h3>
            <div class="flex flex-col items-center justify-center py-16 text-center">
              <i class="fa fa-trophy text-neutral-300 text-6xl mb-4"></i>
              <h4 class="text-xl font-medium text-neutral-600 mb-2">暂无热门日记</h4>
              <p class="text-neutral-500">等待社区成员创建精彩内容</p>
                </div>
                </div>
              </div>
      </div>
    </section>
  </main>

  <!-- 个人资料设置弹窗 -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
      <!-- 弹窗头部 -->
      <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">个人资料设置</h2>
          <button id="close-profile-modal" class="text-white hover:text-white/80 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
                </div>
                </div>
      
      <!-- 弹窗内容 -->
      <div class="p-6">
        <form id="profile-form" class="space-y-6">
          <!-- 头像上传 -->
          <div class="text-center">
            <div class="relative inline-block">
              <div id="avatar-preview" class="w-24 h-24 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4 cursor-pointer hover:opacity-80 transition-opacity">
                <i class="fa fa-user"></i>
              </div>
              <input type="file" id="avatar-upload" accept="image/*" class="hidden">
              <button type="button" id="upload-avatar-btn" class="absolute bottom-0 right-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center hover:bg-primary/90 transition-colors">
                <i class="fa fa-camera text-sm"></i>
              </button>
            </div>
            <p class="text-sm text-neutral-500">点击头像上传新图片</p>
              </div>
              
          <!-- 用户名 -->
          <div>
            <label for="profile-username" class="block text-sm font-medium text-neutral-700 mb-2">用户名</label>
            <input 
              type="text" 
              id="profile-username" 
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
              placeholder="输入你的用户名"
              maxlength="20"
              required
            >
            <p class="text-xs text-neutral-500 mt-1">用户名将显示在日记和评论中</p>
                </div>
          
          <!-- 个人简介 -->
          <div>
            <label for="profile-bio" class="block text-sm font-medium text-neutral-700 mb-2">个人简介</label>
            <textarea 
              id="profile-bio" 
              rows="3" 
              class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none"
              placeholder="介绍一下自己..."
              maxlength="200"
            ></textarea>
            <div class="flex justify-between items-center mt-1">
              <p class="text-xs text-neutral-500">个人简介将显示在你的个人页面</p>
              <span id="bio-char-count" class="text-xs text-neutral-400">0/200</span>
                </div>
              </div>
              
          <!-- 钱包地址显示 -->
          <div class="bg-neutral-50 rounded-lg p-4">
            <label class="block text-sm font-medium text-neutral-700 mb-2">钱包地址</label>
            <div class="flex items-center justify-between">
              <span id="profile-wallet-address" class="text-sm text-neutral-600 font-mono">未连接钱包</span>
              <button type="button" id="copy-wallet-btn" class="text-primary hover:text-primary/80 transition-colors">
                <i class="fa fa-copy"></i>
              </button>
                </div>
          </div>
          
          <!-- 保存按钮 -->
          <div class="flex gap-3 pt-4">
            <button type="button" id="cancel-profile-btn" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
              取消
            </button>
            <button type="submit" id="save-profile-btn" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
              保存资料
            </button>
          </div>
        </form>
      </div>
                </div>
              </div>
              
  <!-- 用户资料查看弹窗 -->
  <div id="user-profile-view-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
      <!-- 弹窗头部 -->
      <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">用户资料</h2>
          <button id="close-user-profile-view-modal" class="text-white hover:text-white/80 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
                </div>
                </div>
      
      <!-- 弹窗内容 -->
      <div class="p-6">
        <div class="space-y-6">
          <!-- 头像显示 -->
          <div class="text-center">
            <div id="view-avatar" class="w-24 h-24 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4">
              <i class="fa fa-user"></i>
              </div>
            </div>
          
          <!-- 用户名 -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">用户名</label>
            <div id="view-username" class="w-full px-4 py-3 rounded-lg bg-neutral-50 border border-neutral-200 text-neutral-800">
              加载中...
          </div>
        </div>
          
          <!-- 个人简介 -->
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2">个人简介</label>
            <div id="view-bio" class="w-full px-4 py-3 rounded-lg bg-neutral-50 border border-neutral-200 text-neutral-800 min-h-[4.5rem]">
              加载中...
      </div>
          </div>
          
          <!-- 钱包地址显示 -->
          <div class="bg-neutral-50 rounded-lg p-4">
            <label class="block text-sm font-medium text-neutral-700 mb-2">钱包地址</label>
            <div class="flex items-center justify-between">
              <span id="view-wallet-address" class="text-sm text-neutral-600 font-mono">加载中...</span>
              <button type="button" id="copy-view-wallet-btn" class="text-primary hover:text-primary/80 transition-colors">
                <i class="fa fa-copy"></i>
              </button>
            </div>
          </div>
          
          <!-- 关闭按钮 -->
          <div class="pt-4">
            <button type="button" id="close-user-profile-view-btn" class="w-full px-4 py-3 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors font-medium">
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>


  <!-- 发布成功弹窗 -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full transform transition-transform duration-300 scale-95">
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-check text-2xl text-green-500"></i>
        </div>
        <h3 class="text-xl font-bold text-neutral-800 mb-2">发布成功！</h3>
        <p class="text-neutral-600 mb-6">你的日记已经成功发布到社区啦！</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
            查看我的日记
          </button>
          <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
            返回首页
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase 配置 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, limitToLast, orderByChild, equalTo, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
      authDomain: "chat-294cc.firebaseapp.com",
      databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
      projectId: "chat-294cc",
      storageBucket: "chat-294cc.firebasestorage.app",
      messagingSenderId: "913615304269",
      appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
      measurementId: "G-SJR9NDW86B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

              // 全局变量
    let currentWallet = '';
    let allDiaries = [];
    let connection;
    let userProfiles = {}; // 用户资料缓存
    let currentUserProfile = null; // 当前用户资料

      // Solana 连接配置 - 使用稳定的RPC端点
      const rpcEndpoints = [
        'https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/',
        'https://solana-api.projectserum.com',
        'https://rpc.ankr.com/solana',
        'https://api.mainnet-beta.solana.com'
      ];
      
      // 尝试连接到可用的RPC端点
      async function initializeConnection() {
        for (const endpoint of rpcEndpoints) {
          try {
            console.log(`尝试连接到: ${endpoint}`);
            const testConnection = new solanaWeb3.Connection(endpoint, 'confirmed');
            // 测试连接
            await testConnection.getSlot();
            connection = testConnection;
            console.log(`成功连接到: ${endpoint}`);
            return true;
          } catch (error) {
            console.log(`连接失败: ${endpoint}`, error.message);
            continue;
          }
        }
        console.error('所有RPC端点连接失败');
        return false;
      }

      // 更新钱包UI
      function updateWalletUI(connected) {
        const walletBtn = document.getElementById('wallet-btn');
        const walletText = document.getElementById('wallet-text');
        const walletStatus = document.getElementById('wallet-status');
        const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
        const mobileWalletText = document.getElementById('mobile-wallet-text');
        const mobileWalletStatus = document.getElementById('mobile-wallet-status');
        const profileBtn = document.getElementById('profile-btn');
        
        if (connected && currentWallet) {
          const shortAddr = currentWallet.slice(0, 4) + '...' + currentWallet.slice(-4);
          
          // 更新按钮状态
          walletBtn.className = 'wallet-btn connected hidden md:flex';
          mobileWalletBtn.className = 'wallet-btn connected flex items-center justify-center mt-2';
          
          // 更新文本
          walletText.textContent = shortAddr;
          mobileWalletText.textContent = shortAddr;
          
          // 更新状态指示器
          walletStatus.className = 'wallet-status-indicator connected';
          mobileWalletStatus.className = 'wallet-status-indicator connected';
          
          // 根据网络连接状态设置不同的状态
          if (connection) {
            walletStatus.title = '✅ 钱包已连接，Solana网络正常';
            mobileWalletStatus.title = '✅ 钱包已连接，Solana网络正常';
          } else {
            walletStatus.className = 'wallet-status-indicator error';
            mobileWalletStatus.className = 'wallet-status-indicator error';
            walletStatus.title = '⚠️ 钱包已连接，但Solana网络异常';
            mobileWalletStatus.title = '⚠️ 钱包已连接，但Solana网络异常';
          }
          
          // 隐藏钱包警告
          const walletWarning = document.getElementById('wallet-warning');
          if (walletWarning) {
            walletWarning.classList.add('hidden');
          }

          // 启用个人资料按钮
          if (profileBtn) {
            profileBtn.disabled = false;
            profileBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          
          // 启用手机端个人资料按钮
          const mobileProfileBtn = document.getElementById('mobile-profile-btn');
          if (mobileProfileBtn) {
            mobileProfileBtn.disabled = false;
            mobileProfileBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }

          // 加载用户资料
          loadUserProfile(currentWallet).then(profile => {
            console.log('钱包连接后加载用户资料结果:', profile);
            
            // 检查是否已经提示过用户设置个人资料
            const hasPrompted = localStorage.getItem(`profile_prompted_${currentWallet}`);
            console.log('是否已提示过设置个人资料:', hasPrompted);
            
            // 如果用户没有设置过个人资料且没有提示过，自动弹出设置弹窗
            if ((!profile || !profile.username) && !hasPrompted) {
              console.log('需要弹出个人资料设置弹窗');
              // 延迟一点时间，让用户看到钱包连接成功的状态
              setTimeout(() => {
                showProfileModal(true); // 传递true表示首次设置
              }, 1000);
            } else {
              console.log('用户已有个人资料或已提示过');
            }
          });

          // 添加断开连接功能
          setupDisconnectWallet();
        } else {
          // 重置为未连接状态
          walletBtn.className = 'wallet-btn disconnected hidden md:flex';
          mobileWalletBtn.className = 'wallet-btn disconnected flex items-center justify-center mt-2';
          
          walletText.textContent = '连接钱包';
          mobileWalletText.textContent = '连接钱包';
          
          walletStatus.className = 'wallet-status-indicator disconnected';
          mobileWalletStatus.className = 'wallet-status-indicator disconnected';
          walletStatus.title = '点击连接Phantom钱包';
          mobileWalletStatus.title = '点击连接Phantom钱包';

          // 禁用个人资料按钮
          if (profileBtn) {
            profileBtn.disabled = true;
            profileBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
          
          // 禁用手机端个人资料按钮
          const mobileProfileBtn = document.getElementById('mobile-profile-btn');
          if (mobileProfileBtn) {
            mobileProfileBtn.disabled = true;
            mobileProfileBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      }

      // 更新私人页面UI
      function updatePrivatePageUI() {
        const privateWarning = document.getElementById('private-wallet-warning');
        const privateControls = document.getElementById('private-controls');
        const privateDiaryList = document.getElementById('private-diary-list');
        const privateEmptyState = document.getElementById('private-empty-state');
        
        if (currentWallet) {
          privateWarning.classList.add('hidden');
          privateControls.classList.remove('hidden');
          privateDiaryList.classList.remove('hidden');
          loadPrivateDiaries();
        } else {
          privateWarning.classList.remove('hidden');
          privateControls.classList.add('hidden');
          privateDiaryList.classList.add('hidden');
          privateEmptyState.classList.add('hidden');
        }
      }

      // 加载所有日记
      function loadDiaries() {
        const diaryRef = query(ref(db, 'diaryEntries'), limitToLast(50));
        onValue(diaryRef, async (snapshot) => {
          const val = snapshot.val();
          if (!val) {
            allDiaries = [];
            renderPublicDiaries();
            return;
          }
          
          // 转为数组并按点赞数降序，然后按时间倒序
          allDiaries = Object.entries(val)
            .map(([id, entry]) => ({ 
              id, 
              ...entry,
              likeCount: entry.likedBy ? Object.keys(entry.likedBy).length : 0
            }))
            .sort((a, b) => {
              // 首先按点赞数降序排序
              if (b.likeCount !== a.likeCount) {
                return b.likeCount - a.likeCount;
              }
              // 点赞数相同时按时间倒序排序
              return b.timestamp - a.timestamp;
            });
          
          renderPublicDiaries();
          renderFeaturedDiaries();
          if (currentWallet) {
            loadPrivateDiaries();
          }
          updateStats();
          
          // 加载所有日记作者的用户资料
          const uniqueWallets = [...new Set(allDiaries.map(diary => diary.wallet).filter(Boolean))];
          console.log('需要加载用户资料的钱包地址:', uniqueWallets);
          
          for (const wallet of uniqueWallets) {
            if (!userProfiles[wallet]) {
              console.log('加载用户资料:', wallet);
              await loadUserProfile(wallet);
            } else {
              console.log('用户资料已缓存:', wallet);
            }
          }
        });
      }

      // 渲染公共日记
      function renderPublicDiaries() {
        const publicDiaries = allDiaries.filter(d => d.public !== false);
        const container = document.querySelector('#public .grid');
        const emptyTip = document.querySelector('#public .col-span-full');
        
        if (!container) return;
        
        container.innerHTML = '';
        
        if (publicDiaries.length === 0) {
          if (emptyTip) {
            emptyTip.style.display = 'flex';
          }
          return;
        }
        
        if (emptyTip) {
          emptyTip.style.display = 'none';
        }
        
        publicDiaries.forEach(diary => {
          const diaryCard = createDiaryCard(diary);
          container.appendChild(diaryCard);
        });
        
        // 加载所有日记的评论数量
        loadAllCommentCounts(publicDiaries);
      }

      // 加载私人日记
      function loadPrivateDiaries() {
        if (!currentWallet) return;
        
        const privateDiaries = allDiaries.filter(d => 
          d.public === false && d.wallet === currentWallet
        );
        
        const container = document.getElementById('private-diary-list');
        const emptyState = document.getElementById('private-empty-state');
        
        container.innerHTML = '';
        
        if (privateDiaries.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }
        
        emptyState.classList.add('hidden');
        
        privateDiaries.forEach(diary => {
          const diaryCard = createDiaryCard(diary, true);
          container.appendChild(diaryCard);
        });
      }

      // 查看用户资料
      async function viewUserProfile(walletAddress) {
        if (!walletAddress) {
          alert('无效的用户地址');
          return;
        }

        const modal = document.getElementById('user-profile-view-modal');
        const viewAvatar = document.getElementById('view-avatar');
        const viewUsername = document.getElementById('view-username');
        const viewBio = document.getElementById('view-bio');
        const viewWalletAddress = document.getElementById('view-wallet-address');

        // 显示加载状态
        viewUsername.textContent = '加载中...';
        viewBio.textContent = '加载中...';
        viewWalletAddress.textContent = '加载中...';
        viewAvatar.innerHTML = '<i class="fa fa-user"></i>';

        // 显示弹窗
        modal.classList.remove('hidden');
        disablePageScroll();

        try {
          // 加载用户资料
          let profile = userProfiles[walletAddress];
          if (!profile) {
            profile = await loadUserProfile(walletAddress);
          }

          // 显示钱包地址
          viewWalletAddress.textContent = walletAddress;

          if (profile) {
            // 显示用户名
            viewUsername.textContent = profile.username || '未设置用户名';
            
            // 显示个人简介
            viewBio.textContent = profile.bio || '该用户还没有设置个人简介';
            
            // 显示头像
            if (profile.avatar) {
              viewAvatar.innerHTML = `<img src="${profile.avatar}" alt="头像" class="w-full h-full object-cover rounded-full">`;
            } else {
              const displayName = getUserDisplayName(walletAddress);
              viewAvatar.innerHTML = displayName.charAt(0).toUpperCase();
            }
          } else {
            // 用户没有设置资料
            const displayName = getUserDisplayName(walletAddress);
            viewUsername.textContent = displayName;
            viewBio.textContent = '该用户还没有设置个人资料';
            viewAvatar.innerHTML = displayName.charAt(0).toUpperCase();
          }

          // 设置复制钱包地址功能
          setupViewCopyWallet(walletAddress);

        } catch (error) {
          console.error('加载用户资料失败:', error);
          viewUsername.textContent = '加载失败';
          viewBio.textContent = '无法加载用户资料';
          viewWalletAddress.textContent = walletAddress;
        }
      }

      // 设置查看弹窗的复制钱包地址功能
      function setupViewCopyWallet(walletAddress) {
        const copyBtn = document.getElementById('copy-view-wallet-btn');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(walletAddress).then(() => {
              // 显示复制成功提示
              const originalText = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fa fa-check"></i>';
              copyBtn.classList.add('text-green-500');
              
              setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('text-green-500');
              }, 2000);
            });
          });
        }
      }

      // 隐藏用户资料查看弹窗
      function hideUserProfileViewModal() {
        const modal = document.getElementById('user-profile-view-modal');
        modal.classList.add('hidden');
        restorePageScroll();
      }

      // 创建日记卡片
      function createDiaryCard(diary, isPrivate = false) {
        const card = document.createElement('article');
        card.className = 'diary-card bg-white rounded-xl shadow-sm overflow-hidden border border-neutral-200 cursor-pointer';
        
        const title = diary.title || '无标题';
        const content = diary.content || '';
        const preview = content.length > 120 ? content.slice(0, 120) + '...' : content;
        const author = getUserDisplayName(diary.wallet);
        const date = formatDate(diary.timestamp);
        const tags = diary.tags || [];
        
        let tagHtml = '';
        if (tags.length > 0) {
          const tag = tags[0];
          const tagColors = {
            '生活': 'bg-blue-100 text-blue-800',
            '旅行': 'bg-green-100 text-green-800',
            '感悟': 'bg-purple-100 text-purple-800',
            '读书': 'bg-yellow-100 text-yellow-800',
            '工作': 'bg-gray-100 text-gray-800',
            '美食': 'bg-red-100 text-red-800'
          };
          const colorClass = tagColors[tag] || 'bg-gray-100 text-gray-800';
          tagHtml = `<span class="px-2.5 py-0.5 ${colorClass} text-xs rounded-full">${tag}</span>`;
        }
        
        card.innerHTML = `
          <div class="p-6">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center flex-1">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-sm font-bold mr-3 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">
                  ${(() => {
                    const userAvatar = getUserAvatar(diary.wallet);
                    return userAvatar 
                      ? `<img src="${userAvatar}" alt="头像" class="w-full h-full object-cover">`
                      : author.charAt(0).toUpperCase();
                  })()}
                </div>
                <div class="flex-1">
                  <h4 class="font-medium text-neutral-800 cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">${author}</h4>
                  <p class="text-xs text-neutral-500">${date}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                ${tagHtml}
                ${isPrivate ? '<i class="fa fa-lock text-neutral-400 text-sm"></i>' : ''}
                ${diary.txid ? '<i class="fa fa-link text-primary text-sm" title="已上链"></i>' : ''}
              </div>
            </div>
            
            <h3 class="text-xl font-bold mb-3 text-neutral-800 hover:text-primary transition-colors">${escapeHtml(title)}</h3>
            
            <p class="text-neutral-600 line-clamp-3 mb-4">${escapeHtml(preview)}</p>
            
                          <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4 text-neutral-500">
                  <button class="like-btn flex items-center transition-all hover:text-red-500" data-diary-id="${diary.id}" data-liked="${diary.likedBy && diary.likedBy[currentWallet] ? 'true' : 'false'}">
                    <i class="fa ${diary.likedBy && diary.likedBy[currentWallet] ? 'fa-heart text-red-500' : 'fa-heart-o'} mr-1"></i>
                    <span class="like-count-${diary.id}">${diary.likedBy ? Object.keys(diary.likedBy).length : 0}</span>
                  </button>
                  <div class="flex items-center">
                    <i class="fa fa-comment-o mr-1"></i>
                    <span class="comment-count-${diary.id}">0</span>
                  </div>
                </div>
                <button class="read-more-btn text-primary hover:text-primary/80 text-sm font-medium transition-colors px-3 py-1 rounded-lg hover:bg-primary/5">
                  阅读全文 <i class="fa fa-angle-right ml-1"></i>
                </button>
              </div>
          </div>
        `;
        
        // 添加点击事件
        card.addEventListener('click', () => showDiaryModal(diary));
        
        return card;
      }

      // 更新统计数据
      function updateStats() {
        const totalDiaries = allDiaries.length;
        const publicDiaries = allDiaries.filter(d => d.public !== false).length;
        const privateDiaries = allDiaries.filter(d => d.public === false && d.wallet === currentWallet).length;
        const activeUsers = new Set(allDiaries.map(d => d.wallet)).size;
        
        // 更新统计显示
        const totalElement = document.getElementById('total-diaries');
        const publicElement = document.getElementById('public-diaries');
        const activeElement = document.getElementById('active-users');
        const commentsElement = document.getElementById('total-comments');
        
        if (totalElement) totalElement.textContent = totalDiaries;
        if (publicElement) publicElement.textContent = publicDiaries;
        if (activeElement) activeElement.textContent = activeUsers;
        if (commentsElement) commentsElement.textContent = '0'; // 暂时设为0
      }

      // 钱包连接功能
      async function connectWallet() {
        if (window.solana && window.solana.isPhantom) {
          try {
            // 显示加载状态
            setWalletLoadingState(true);
            
            const resp = await window.solana.connect();
            currentWallet = resp.publicKey.toString();
            
            // 连接钱包后立即初始化Solana网络连接
            console.log('正在初始化Solana网络连接...');
            const networkConnected = await initializeConnection();
            if (networkConnected) {
              console.log('Solana网络连接成功');
            } else {
              console.warn('Solana网络连接失败，上链功能可能不可用');
            }
            
            updateWalletUI(true);
            updatePrivatePageUI();
            loadDiaries();
            return true;
          } catch (error) {
            console.error('钱包连接失败:', error);
            return false;
          } finally {
            // 隐藏加载状态
            setWalletLoadingState(false);
          }
        } else {
          alert('请安装 Phantom 钱包');
          return false;
        }
      }

      // 设置钱包加载状态
      function setWalletLoadingState(loading) {
        const walletBtn = document.getElementById('wallet-btn');
        const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
        const walletText = document.getElementById('wallet-text');
        const mobileWalletText = document.getElementById('mobile-wallet-text');
        
        if (loading) {
          walletBtn.classList.add('loading');
          mobileWalletBtn.classList.add('loading');
          walletText.textContent = '连接中...';
          mobileWalletText.textContent = '连接中...';
        } else {
          walletBtn.classList.remove('loading');
          mobileWalletBtn.classList.remove('loading');
          if (!currentWallet) {
            walletText.textContent = '连接钱包';
            mobileWalletText.textContent = '连接钱包';
          }
        }
      }

    // 页面切换功能
    document.addEventListener('DOMContentLoaded', function() {
      // 获取所有页面链接和页面容器
      const pageLinks = document.querySelectorAll('.page-link, .nav-link, .mobile-nav-link');
      const pageContainers = document.querySelectorAll('.page-container');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      
      // 自动检测钱包连接
      async function checkWalletConnection() {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect({ onlyIfTrusted: true });
            currentWallet = resp.publicKey.toString();
            
            // 自动连接时也初始化Solana网络
            console.log('自动检测到钱包，初始化Solana网络连接...');
            const networkConnected = await initializeConnection();
            if (networkConnected) {
              console.log('Solana网络连接成功');
            }
            
            updateWalletUI(true);
            updatePrivatePageUI();
            loadDiaries();
            
            // 加载用户资料
            loadUserProfile(currentWallet).then(profile => {
              console.log('自动检测钱包连接后加载用户资料结果:', profile);
              if (profile) {
                console.log('用户资料加载成功，用户名:', profile.username);
              }
            });
            
            // 设置断开连接功能
            setupDisconnectWallet();
          } catch (error) {
            // 用户未授权，保持未连接状态
          }
        }
      }

      // 钱包连接事件
      document.getElementById('wallet-btn').addEventListener('click', connectWallet);
      document.getElementById('mobile-wallet-btn').addEventListener('click', connectWallet);
      document.getElementById('private-connect-wallet').addEventListener('click', connectWallet);
      
      // 页面加载时自动检测钱包
      checkWalletConnection();
      
      // 添加键盘快捷键
      document.addEventListener('keydown', (e) => {
        // ESC键断开钱包连接
        if (e.key === 'Escape' && currentWallet) {
          e.preventDefault();
          disconnectWallet();
        }
      });
      
      // 移动端菜单切换
      mobileMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
      });

      // 自定义单选按钮交互
      function setupCustomRadioButtons() {
        const radioButtons = document.querySelectorAll('input[name="privacy"]');
        const radioLabels = document.querySelectorAll('input[name="privacy"] + .custom-radio');
        const radioTexts = document.querySelectorAll('input[name="privacy"] + .custom-radio + span');

        radioButtons.forEach((radio, index) => {
          radio.addEventListener('change', function() {
            // 重置所有按钮状态
            radioLabels.forEach((label, i) => {
              label.classList.remove('checked');
              radioTexts[i].classList.remove('font-semibold', 'text-primary');
            });

            // 设置当前选中按钮状态
            if (this.checked) {
              radioLabels[index].classList.add('checked');
              radioTexts[index].classList.add('font-semibold', 'text-primary');
            }
          });

          // 初始化状态
          if (radio.checked) {
            radioLabels[index].classList.add('checked');
            radioTexts[index].classList.add('font-semibold', 'text-primary');
          }
        });
      }

      // 初始化自定义单选按钮
      setupCustomRadioButtons();

      // 初始化标签选择器
      function setupTagSelector() {
        const tagItems = document.querySelectorAll('.tag-item');
        
        tagItems.forEach(tagItem => {
          const checkbox = tagItem.querySelector('input[type="checkbox"]');
          
          // 点击标签时切换选中状态
          tagItem.addEventListener('click', function(e) {
            e.preventDefault();
            checkbox.checked = !checkbox.checked;
            updateTagVisualState(tagItem, checkbox.checked);
          });
          
          // 初始化状态
          updateTagVisualState(tagItem, checkbox.checked);
        });
      }

      // 更新标签视觉状态
      function updateTagVisualState(tagItem, isChecked) {
        if (isChecked) {
          tagItem.classList.add('checked');
        } else {
          tagItem.classList.remove('checked');
        }
      }

      // 初始化标签选择器
      setupTagSelector();
      
      // 初始化点赞按钮事件监听
      setupDiaryCardLikeButtons();

      // 初始化个人资料功能
      setupProfileFeatures();
      
      // 页面切换函数
      function switchPage(pageId) {
        // 隐藏所有页面
        pageContainers.forEach(container => {
          container.classList.remove('active');
        });
        
        // 显示目标页面
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
          
          // 滚动到顶部
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          
          // 特殊页面逻辑
          if (pageId === 'private') {
            updatePrivatePageUI();
          }
        }
        
        // 更新导航激活状态
        document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
          link.classList.remove('nav-active');
          if (link.getAttribute('data-page') === pageId) {
            link.classList.add('nav-active');
          }
        });
        
        // 关闭移动端菜单
        mobileMenu.classList.add('hidden');
      }
      
      // 为所有页面链接添加点击事件
      pageLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const pageId = this.getAttribute('data-page');
          if (pageId) {
            switchPage(pageId);
          }
        });
      });
      
      // 日记内容字数统计
      const diaryContent = document.getElementById('diary-content');
      const charCount = document.getElementById('char-count');
      
      if (diaryContent && charCount) {
        diaryContent.addEventListener('input', function() {
          const count = this.value.length;
          charCount.textContent = `${count} 个字`;
        });
      }
      
      // 清空内容按钮
      const clearContentBtn = document.getElementById('clear-content');
      if (clearContentBtn && diaryContent) {
        clearContentBtn.addEventListener('click', function() {
          diaryContent.value = '';
          charCount.textContent = '0 个字';
        });
      }
      
      // 上链选项变化时更新按钮文本
      const enableBlockchainToggle = document.getElementById('enable-blockchain');
      const publishText = document.getElementById('publish-text');
      
      if (enableBlockchainToggle && publishText) {
        function updatePublishButtonText() {
          if (enableBlockchainToggle.checked) {
            publishText.textContent = '发布并上链';
          } else {
            publishText.textContent = '发布日记';
          }
        }
        
        enableBlockchainToggle.addEventListener('change', updatePublishButtonText);
        updatePublishButtonText(); // 初始化
      }

      // 检查钱包余额
      async function checkWalletBalance(walletPublicKey) {
        try {
          // 确保连接已初始化
          if (!connection) {
            const connected = await initializeConnection();
            if (!connected) {
              throw new Error('无法连接到Solana网络');
            }
          }
          
          const publicKey = new solanaWeb3.PublicKey(walletPublicKey);
          const balance = await connection.getBalance(publicKey);
          // 返回SOL余额（lamports转SOL）
          return balance / solanaWeb3.LAMPORTS_PER_SOL;
        } catch (error) {
          console.error('获取钱包余额失败:', error);
          // 如果是网络错误，尝试重新连接
          if (error.message.includes('403') || error.message.includes('fetch')) {
            console.log('尝试重新连接...');
            const reconnected = await initializeConnection();
            if (reconnected) {
              try {
                const publicKey = new solanaWeb3.PublicKey(walletPublicKey);
                const balance = await connection.getBalance(publicKey);
                return balance / solanaWeb3.LAMPORTS_PER_SOL;
              } catch (retryError) {
                console.error('重试获取余额失败:', retryError);
              }
            }
          }
          return 0;
        }
      }

      // 创建Solana上链交易（使用Memo程序）
      async function createSolanaTransaction(diaryData, walletPublicKey) {
        try {
          // 确保连接已初始化
          if (!connection) {
            const connected = await initializeConnection();
            if (!connected) {
              throw new Error('无法连接到Solana网络');
            }
          }

          // 创建日记内容
          const title = diaryData.title || '';
          const content = diaryData.content || '';
          const message = title ? `[${title}] ${content}` : content;
          
          // 编码消息
          const encodedMessage = new TextEncoder().encode(message);
          
          // 检查长度限制
          if (encodedMessage.length > 566) {
            throw new Error(`日记内容过长，无法上链（最大566字节，当前${encodedMessage.length}字节）`);
          }
          
          // 创建memo指令
          const memoProgramId = new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr');
          const fromPubkey = new solanaWeb3.PublicKey(walletPublicKey);
          
          const memoInstruction = new solanaWeb3.TransactionInstruction({
            keys: [{ pubkey: fromPubkey, isSigner: true, isWritable: false }],
            programId: memoProgramId,
            data: encodedMessage
          });
          
          // 获取最新的blockhash
          const { blockhash } = await connection.getLatestBlockhash();
          
          // 创建交易
          const transaction = new solanaWeb3.Transaction();
          transaction.recentBlockhash = blockhash;
          transaction.feePayer = fromPubkey;
          transaction.add(memoInstruction);
          
          return transaction;
        } catch (error) {
          console.error('创建Solana交易失败:', error);
          throw error;
        }
      }

      // 日记发布功能
      async function publishDiary(diaryData) {
        if (!currentWallet) {
          showWalletWarning();
          return false;
        }

        const publishBtn = document.getElementById('publish-btn');
        const publishText = document.getElementById('publish-text');
        const publishSpinner = document.getElementById('publish-spinner');
        
        // 禁用按钮并显示加载状态
        publishBtn.disabled = true;
        publishText.textContent = '创建交易中...';
        publishSpinner.classList.remove('hidden');
        
        let txid = null;
        
                          // 检查是否要尝试上链
        const enableBlockchain = document.getElementById('enable-blockchain').checked;
        
        try {
          // 第一步：如果启用了上链，尝试创建Solana交易并上链
          if (enableBlockchain && currentWallet) {
            try {
              publishText.textContent = '检查钱包余额...';
              
              // 检查余额
              const balance = await checkWalletBalance(currentWallet);
              const minBalance = 0.0005; // 至少需要0.0005 SOL用于交易费用（Memo程序成本更低）
              
              if (balance < minBalance) {
                throw new Error(`钱包余额不足。当前余额: ${balance.toFixed(6)} SOL，至少需要 ${minBalance} SOL`);
              }
              
              publishText.textContent = '正在上链...';
              
              // 创建交易
              const transaction = await createSolanaTransaction(diaryData, currentWallet);
              
              // 签名并发送交易到Solana主网
              const signed = await window.solana.signTransaction(transaction);
              const signature = await connection.sendRawTransaction(signed.serialize());
              txid = signature;
              
              publishText.textContent = '确认交易中...';
              
              // 等待交易确认
              await connection.confirmTransaction(signature, 'confirmed');
              
              console.log('Solana交易成功:', signature);
              const shortSig = signature.slice(0, 4) + '...' + signature.slice(-6);
              console.log(`✅ 日记已上链，交易ID: ${shortSig}`);
              publishText.textContent = '保存到数据库...';
              
            } catch (solanaError) {
              console.error('Solana上链失败:', solanaError);
              // 即使Solana上链失败，也继续保存到Firebase，但不包含txid
              publishText.textContent = '上链失败，仅保存到数据库...';
              
              // 显示具体错误信息
              if (solanaError.message.includes('日记内容过长')) {
                console.warn('内容过长，建议缩短日记内容');
              } else if (solanaError.message.includes('余额不足')) {
                console.warn('钱包余额不足，请充值后重试');
              }
            }
          } else {
            publishText.textContent = '保存到数据库...';
          }
          
          // 第二步：保存到Firebase数据库
          const entry = {
            title: diaryData.title,
            content: diaryData.content,
            tags: diaryData.tags,
            public: diaryData.privacy === 'public',
            wallet: currentWallet,
            timestamp: Date.now(),
            txid: txid // 如果上链成功则包含交易ID
          };
          
          // 保存到Firebase
          const diaryRef = ref(db, 'diaryEntries');
          const result = await push(diaryRef, entry);
          
          // 重置表单
          document.getElementById('diary-form').reset();
          document.getElementById('char-count').textContent = '0 个字';
          
          // 显示成功消息
          showSuccessModal(txid);
          
          // 重新加载数据
          setTimeout(() => {
            loadDiaries();
          }, 1000);
          
          return true;
        } catch (error) {
          console.error('发布失败:', error);
          alert('发布失败：' + error.message);
          return false;
        } finally {
          // 恢复按钮状态
          publishBtn.disabled = false;
          const enableBlockchain = document.getElementById('enable-blockchain').checked;
          publishText.textContent = enableBlockchain ? '发布并上链' : '发布日记';
          publishSpinner.classList.add('hidden');
        }
      }

      // 显示钱包警告
      function showWalletWarning() {
        const walletWarning = document.getElementById('wallet-warning');
        if (walletWarning) {
          walletWarning.classList.remove('hidden');
          setTimeout(() => {
            walletWarning.classList.add('hidden');
          }, 5000);
        }
      }
          
          // 显示成功弹窗
      function showSuccessModal(txid = null) {
        const successModal = document.getElementById('success-modal');
        if (successModal) {
          // 更新弹窗内容
          const modalContent = successModal.querySelector('.text-center');
          if (txid) {
            modalContent.innerHTML = `
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-check text-2xl text-green-500"></i>
              </div>
              <h3 class="text-xl font-bold text-neutral-800 mb-2">发布成功！</h3>
              <p class="text-neutral-600 mb-4">你的日记已经成功发布到Solana区块链！</p>
              <div class="bg-neutral-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-neutral-600 mb-2">交易ID:</p>
                <p class="text-xs text-neutral-800 font-mono break-all">${txid}</p>
                <div class="flex gap-2 mt-2">
                  <a href="https://solscan.io/tx/${txid}" target="_blank" class="inline-block text-primary hover:text-primary/80 text-sm">
                    <i class="fa fa-external-link mr-1"></i>Solscan
                  </a>
                  <a href="https://explorer.solana.com/tx/${txid}?cluster=mainnet-beta" target="_blank" class="inline-block text-primary hover:text-primary/80 text-sm">
                    <i class="fa fa-external-link mr-1"></i>Solana Explorer
                  </a>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row gap-3">
                <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                  查看我的日记
                </button>
                <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
                  返回首页
                </button>
              </div>
            `;
          } else {
            modalContent.innerHTML = `
              <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-exclamation-triangle text-2xl text-amber-500"></i>
              </div>
              <h3 class="text-xl font-bold text-neutral-800 mb-2">部分成功</h3>
              <p class="text-neutral-600 mb-6">日记已保存，但区块链上链失败。你可以稍后重试上链。</p>
              <div class="flex flex-col sm:flex-row gap-3">
                <button id="view-diary" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                  查看我的日记
                </button>
                <button id="close-modal" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
                  返回首页
                </button>
              </div>
            `;
          }
          
          successModal.classList.remove('hidden');
          setTimeout(() => {
            successModal.classList.add('opacity-100');
            successModal.querySelector('div').classList.remove('scale-95');
            successModal.querySelector('div').classList.add('scale-100');
          }, 10);
        }
      }

      // 日记发布表单提交
      const diaryForm = document.getElementById('diary-form');
      const successModal = document.getElementById('success-modal');
      const closeModalBtn = document.getElementById('close-modal');
      const viewDiaryBtn = document.getElementById('view-diary');
      
      if (diaryForm) {
        diaryForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // 获取表单数据
          const formData = new FormData(this);
          const title = document.getElementById('diary-title').value;
          const content = document.getElementById('diary-content').value;
          const privacy = formData.get('privacy');
          const tags = Array.from(formData.getAll('tags'));
          
          if (!title.trim() || !content.trim()) {
            alert('请填写标题和内容');
            return;
          }
          
          const diaryData = {
            title: title.trim(),
            content: content.trim(),
            privacy,
            tags
          };
          
          if (typeof publishDiary === 'function') {
            await publishDiary(diaryData);
          } else {
            console.error('publishDiary function is not defined');
            alert('系统错误，请刷新页面重试');
          }
        });
      }
        
      // 使用事件委托处理成功弹窗按钮
      document.addEventListener('click', function(e) {
        if (e.target.id === 'close-modal') {
          const successModal = document.getElementById('success-modal');
          if (successModal) {
            successModal.classList.remove('opacity-100');
            successModal.querySelector('div').classList.remove('scale-100');
            successModal.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
              successModal.classList.add('hidden');
              switchPage('home');
            }, 300);
          }
        }
        
        if (e.target.id === 'view-diary') {
          const successModal = document.getElementById('success-modal');
          if (successModal) {
            successModal.classList.remove('opacity-100');
            successModal.querySelector('div').classList.remove('scale-100');
            successModal.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
              successModal.classList.add('hidden');
              switchPage('public');
            }, 300);
          }
        }
      });

      // 初始化应用
      function initApp() {
        try {
          loadDiaries();
          updateStats();
          
          // 验证关键函数是否已定义
          if (typeof publishDiary !== 'function') {
            console.error('publishDiary function is not available');
          }
          if (typeof connectWallet !== 'function') {
            console.error('connectWallet function is not available');
          }
          if (typeof showDiaryModal !== 'function') {
            console.error('showDiaryModal function is not available');
          }
        } catch (error) {
          console.error('初始化应用失败:', error);
        }
      }

      // 页面加载完成后初始化
      initApp();
      
      // 在DOMContentLoaded内部暴露函数到全局
      window.publishDiary = publishDiary;
      window.connectWallet = connectWallet;
      window.toggleLike = toggleLike;
      window.showProfileModal = showProfileModal;
      window.viewUserProfile = viewUserProfile;
      window.hideUserProfileViewModal = hideUserProfileViewModal;
      window.setupViewCopyWallet = setupViewCopyWallet;
      window.disconnectWallet = disconnectWallet;
      window.showWalletWarning = showWalletWarning;
      window.loadDiaries = loadDiaries;
      
      // 将函数暴露到全局作用域以便调试
      window.blockchainDiary = {
        connectWallet,
        loadDiaries,
        publishDiary,
        toggleLike,
        showDiaryModal,
        currentWallet: () => currentWallet,
        allDiaries: () => allDiaries
      };
      
      console.log('全局函数已暴露');
    });

    // 显示日记详情弹窗
    window.showDiaryModal = function(diary) {
      // 创建弹窗HTML
      const modalHtml = `
        <div id="diary-detail-modal" class="diary-modal fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div class="diary-modal-content rounded-xl shadow-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div class="p-8">
              <!-- 头部信息 -->
              <div class="flex justify-between items-start mb-6">
                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white font-bold mr-4 shadow-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" onclick="viewUserProfile('${diary.wallet}')">
                    ${(() => {
                      const userAvatar = getUserAvatar(diary.wallet);
                      const displayName = getUserDisplayName(diary.wallet);
                      return userAvatar 
                        ? `<img src="${userAvatar}" alt="头像" class="w-full h-full object-cover">`
                        : displayName.charAt(0).toUpperCase();
                    })()}
                  </div>
                  <div>
                    <h4 class="font-semibold text-neutral-800 text-lg cursor-pointer hover:text-primary transition-colors" onclick="viewUserProfile('${diary.wallet}')">${getUserDisplayName(diary.wallet)}</h4>
                    <p class="text-sm text-neutral-500 flex items-center">
                      <i class="fa fa-clock-o mr-1"></i>
                      ${formatDate(diary.timestamp)}
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  ${diary.txid ? `
                    <a href="https://solscan.io/tx/${diary.txid}" target="_blank" class="flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200 transition-all shadow-sm">
                      <i class="fa fa-link mr-2"></i>
                      已上链
                    </a>
                  ` : ''}
                  <button id="close-diary-modal" class="w-10 h-10 flex items-center justify-center rounded-full bg-neutral-100 text-neutral-600 hover:bg-neutral-200 hover:text-neutral-800 transition-all">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
              </div>
              
                              <!-- 标题和点赞区域 -->
                <div class="flex justify-between items-start mb-6">
                  <h1 class="diary-title text-3xl font-bold">${escapeHtml(diary.title || '无标题')}</h1>
                  <div class="flex items-center space-x-4">
                    <button class="modal-like-btn flex items-center px-4 py-2 rounded-lg border border-neutral-300 hover:border-red-300 hover:bg-red-50 transition-all" data-diary-id="${diary.id}" data-liked="${diary.likedBy && diary.likedBy[currentWallet] ? 'true' : 'false'}">
                      <i class="fa ${diary.likedBy && diary.likedBy[currentWallet] ? 'fa-heart text-red-500' : 'fa-heart-o text-neutral-500'} mr-2"></i>
                      <span class="modal-like-count-${diary.id} font-medium">${diary.likedBy ? Object.keys(diary.likedBy).length : 0}</span>
                    </button>
                  </div>
                </div>
              
              <!-- 标签 -->
              ${diary.tags && diary.tags.length > 0 ? `
                <div class="flex flex-wrap gap-3 mb-8">
                  ${diary.tags.map(tag => {
                    const tagColors = {
                      '生活': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                      '旅行': 'bg-blue-100 text-blue-800 border-blue-200',
                      '感悟': 'bg-purple-100 text-purple-800 border-purple-200',
                      '读书': 'bg-green-100 text-green-800 border-green-200',
                      '工作': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                      '美食': 'bg-red-100 text-red-800 border-red-200'
                    };
                    const colorClass = tagColors[tag] || 'bg-gray-100 text-gray-800 border-gray-200';
                    return `<span class="px-4 py-2 ${colorClass} rounded-full text-sm font-medium border">${tag}</span>`;
                  }).join('')}
                </div>
              ` : ''}
              
              <!-- 内容 -->
              <div class="diary-content mb-8 bg-white rounded-lg p-6 border border-neutral-200 shadow-sm">
                <p class="text-neutral-700 leading-relaxed whitespace-pre-line text-lg">${escapeHtml(diary.content || '')}</p>
              </div>
              
              <!-- 区块链信息 -->
              ${diary.txid ? `
                <div class="blockchain-info p-6">
                  <div class="flex items-center mb-3">
                    <i class="fa fa-link text-blue-500 mr-2"></i>
                    <h3 class="font-semibold text-blue-800">区块链交易信息</h3>
                  </div>
                  <p class="text-sm text-blue-700 font-mono break-all mb-3 bg-blue-50 p-3 rounded-lg">${diary.txid}</p>
                  <div class="flex gap-3">
                    <a href="https://solscan.io/tx/${diary.txid}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-sm font-medium">
                      <i class="fa fa-external-link mr-2"></i>
                      在 Solscan 查看
                    </a>
                    <a href="https://explorer.solana.com/tx/${diary.txid}?cluster=mainnet-beta" target="_blank" class="inline-flex items-center px-4 py-2 bg-neutral-500 text-white rounded-lg hover:bg-neutral-600 transition-all text-sm font-medium">
                      <i class="fa fa-external-link mr-2"></i>
                      在 Solana Explorer 查看
                    </a>
                  </div>
                </div>
              ` : `
                <div class="blockchain-info error p-6">
                  <div class="flex items-center">
                    <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>
                    <p class="text-red-700 font-medium">
                      此日记尚未上链或上链失败
                    </p>
                  </div>
                </div>
              `}

              <!-- 聊天留言区域 -->
              <div class="chat-section mt-8">
                <!-- 聊天头部 -->
                <div class="chat-header">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-neutral-800 flex items-center">
                      <i class="fa fa-comments text-primary mr-2"></i>
                      留言讨论
                    </h3>
                    <span class="text-sm text-neutral-500" id="comment-count">0 条留言</span>
                  </div>
                </div>
                
                <!-- 聊天消息区域 -->
                <div class="chat-messages">
                  <div class="comments-container bg-neutral-50 rounded-lg p-4 h-full overflow-y-auto" id="comments-list-${diary.id}">
                    <div class="text-center text-neutral-500 py-8">
                      <i class="fa fa-comment-o text-2xl mb-2"></i>
                      <p>暂无留言，成为第一个留言的人吧！</p>
                    </div>
                  </div>
                </div>
                
                <!-- 聊天输入区域 -->
                <div class="chat-input-area">
                  ${currentWallet ? `
                    <div class="flex gap-3">
                      <div class="flex-1">
                        <textarea 
                          id="comment-input-${diary.id}" 
                          placeholder="写下你的想法..." 
                          class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"
                          rows="2"
                        ></textarea>
                      </div>
                      <button 
                        id="send-comment-${diary.id}" 
                        class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all font-medium flex items-center"
                        disabled
                      >
                        <i class="fa fa-paper-plane mr-2"></i>
                        发送
                      </button>
                    </div>
                  ` : `
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 text-center">
                      <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                      <span class="text-amber-700">请先连接钱包以参与留言讨论</span>
                    </div>
                  `}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // 添加到页面
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // 添加关闭事件
      const modal = document.getElementById('diary-detail-modal');
      const closeBtn = document.getElementById('close-diary-modal');
      
      function closeModal() {
        // 清理评论监听器
        if (commentListeners[diary.id]) {
          commentListeners[diary.id]();
          delete commentListeners[diary.id];
        }
        
        modal.style.animation = 'modalFadeOut 0.2s ease-in forwards';
        setTimeout(() => {
          modal.remove();
          // 恢复页面滚动
          restorePageScroll();
        }, 200);
      }
      
      closeBtn.addEventListener('click', closeModal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // 键盘快捷键
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
      
      // 阻止滚动穿透
      disablePageScroll();

      // 初始化评论功能
      initializeComments(diary.id);
      
      // 初始化点赞功能
      initializeLikeButtons(diary.id);
    }

    // 评论功能
    let commentListeners = {};
    let originalBodyOverflow = '';

    // 滚动状态管理
    function disablePageScroll() {
      originalBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      console.log('页面滚动已禁用，原始状态:', originalBodyOverflow);
    }

    function restorePageScroll() {
      document.body.style.overflow = originalBodyOverflow || '';
      console.log('页面滚动已恢复:', document.body.style.overflow);
    }

    // 用户资料管理
    async function loadUserProfile(walletAddress) {
            // 添加实时监听器
      if (walletAddress === currentWallet && !window.profileListener) {
        console.log('设置用户资料实时监听器');
        const profileRef = ref(db, `userProfiles/${walletAddress}`);
        window.profileListener = onValue(profileRef, (snapshot) => {
          const profile = snapshot.val();
          console.log('实时监听器检测到用户资料变化:', profile);
          if (profile) {
            userProfiles[walletAddress] = profile;
            currentUserProfile = profile;
          }
        });
      }
      
      try {
        console.log('开始加载用户资料:', walletAddress);
        const profileRef = ref(db, `userProfiles/${walletAddress}`);
        const snapshot = await get(profileRef);
        const profile = snapshot.val();
        
        console.log('从Firebase获取到的用户资料:', profile);
        
        if (profile) {
          userProfiles[walletAddress] = profile;
          if (walletAddress === currentWallet) {
            currentUserProfile = profile;
            console.log('设置当前用户资料:', profile);
          }
          return profile;
        }
        console.log('用户资料不存在');
        return null;
      } catch (error) {
        console.error('加载用户资料失败:', error);
        return null;
      }
    }

    async function saveUserProfile(profileData) {
      if (!currentWallet) {
        alert('请先连接钱包');
        return false;
      }

      try {
        console.log('开始保存用户资料:', currentWallet, profileData);
        
        const profileRef = ref(db, `userProfiles/${currentWallet}`);
        const saveData = {
          ...profileData,
          wallet: currentWallet,
          updatedAt: Date.now()
        };
        
        console.log('保存到Firebase的数据:', saveData);
        
        await update(profileRef, saveData);
        console.log('Firebase更新成功');

        // 更新缓存
        userProfiles[currentWallet] = profileData;
        currentUserProfile = profileData;

        // 记录用户已经设置过个人资料
        localStorage.setItem(`profile_prompted_${currentWallet}`, 'true');

        console.log('用户资料保存成功，缓存已更新');
        return true;
      } catch (error) {
        console.error('保存用户资料失败:', error);
        alert('保存失败，请稍后重试');
        return false;
      }
    }

    function getUserDisplayName(walletAddress) {
      const profile = userProfiles[walletAddress];
      if (profile && profile.username) {
        return profile.username;
      }
      return walletAddress ? walletAddress.slice(0, 4) + '...' + walletAddress.slice(-4) : '匿名';
    }

    function getUserAvatar(walletAddress) {
      const profile = userProfiles[walletAddress];
      if (profile && profile.avatar) {
        return profile.avatar;
      }
      return null;
    }

    function getUserBio(walletAddress) {
      const profile = userProfiles[walletAddress];
      return profile ? profile.bio || '' : '';
    }

    // 个人资料弹窗管理
    function showProfileModal(isFirstTime = false) {
      if (!currentWallet) {
        alert('请先连接钱包');
        return;
      }

      const modal = document.getElementById('profile-modal');
      const usernameInput = document.getElementById('profile-username');
      const bioInput = document.getElementById('profile-bio');
      const walletAddressSpan = document.getElementById('profile-wallet-address');
      const avatarPreview = document.getElementById('avatar-preview');

      // 显示钱包地址
      walletAddressSpan.textContent = currentWallet;

      // 加载当前用户资料
      if (currentUserProfile) {
        console.log('显示弹窗时使用缓存的用户资料:', currentUserProfile);
        usernameInput.value = currentUserProfile.username || '';
        bioInput.value = currentUserProfile.bio || '';
        
        // 显示头像
        if (currentUserProfile.avatar) {
          avatarPreview.innerHTML = `<img src="${currentUserProfile.avatar}" alt="头像">`;
          avatarPreview.classList.add('has-image');
        } else {
          avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
          avatarPreview.classList.remove('has-image');
        }
      } else {
        console.log('显示弹窗时没有缓存的用户资料，尝试从Firebase加载...');
        // 尝试从Firebase重新加载用户资料
        loadUserProfile(currentWallet).then(profile => {
          if (profile) {
            console.log('从Firebase加载到用户资料:', profile);
            usernameInput.value = profile.username || '';
            bioInput.value = profile.bio || '';
            
            // 显示头像
            if (profile.avatar) {
              avatarPreview.innerHTML = `<img src="${profile.avatar}" alt="头像">`;
              avatarPreview.classList.add('has-image');
            } else {
              avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
              avatarPreview.classList.remove('has-image');
            }
          } else {
            console.log('Firebase中也没有用户资料');
            usernameInput.value = '';
            bioInput.value = '';
            avatarPreview.innerHTML = '<i class="fa fa-user"></i>';
            avatarPreview.classList.remove('has-image');
          }
        });
      }

      // 更新字数统计
      updateBioCharCount();

      // 显示弹窗
      modal.classList.remove('hidden');
      disablePageScroll();

      // 如果是首次设置，显示欢迎提示
      if (isFirstTime) {
        const modalTitle = modal.querySelector('.bg-gradient-to-r h2');
        if (modalTitle) {
          modalTitle.textContent = '欢迎！请设置您的个人资料';
        }
        
        // 添加首次设置的提示信息
        const form = document.getElementById('profile-form');
        if (form && !form.querySelector('.first-time-tip')) {
          const tip = document.createElement('div');
          tip.className = 'first-time-tip bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4';
          tip.innerHTML = `
            <div class="flex items-start">
              <i class="fa fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
              <div>
                <p class="text-blue-800 text-sm font-medium mb-1">欢迎使用链上日记时光！</p>
                <p class="text-blue-700 text-sm">设置个人资料后，您的用户名和头像将显示在日记和评论中，让其他用户更好地认识您。</p>
              </div>
            </div>
          `;
          form.insertBefore(tip, form.firstChild);
        }
      }
    }

    function hideProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.add('hidden');
      restorePageScroll();
      
      // 恢复弹窗标题
      const modalTitle = modal.querySelector('.bg-gradient-to-r h2');
      if (modalTitle) {
        modalTitle.textContent = '个人资料设置';
      }
      
      // 移除首次设置提示
      const firstTimeTip = modal.querySelector('.first-time-tip');
      if (firstTimeTip) {
        firstTimeTip.remove();
      }
    }

    function updateBioCharCount() {
      const bioInput = document.getElementById('profile-bio');
      const charCount = document.getElementById('bio-char-count');
      if (bioInput && charCount) {
        const count = bioInput.value.length;
        charCount.textContent = `${count}/200`;
      }
    }

    // 头像上传处理
    function setupAvatarUpload() {
      const avatarPreview = document.getElementById('avatar-preview');
      const avatarUpload = document.getElementById('avatar-upload');
      const uploadBtn = document.getElementById('upload-avatar-btn');

      // 点击头像或上传按钮触发文件选择
      [avatarPreview, uploadBtn].forEach(element => {
        if (element) {
          element.addEventListener('click', () => {
            avatarUpload.click();
          });
        }
      });

      // 文件选择处理
      if (avatarUpload) {
        avatarUpload.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB限制
              alert('图片大小不能超过5MB');
              return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
              avatarPreview.innerHTML = `<img src="${e.target.result}" alt="头像">`;
              avatarPreview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    // 复制钱包地址
    function setupCopyWallet() {
      const copyBtn = document.getElementById('copy-wallet-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          if (currentWallet) {
            navigator.clipboard.writeText(currentWallet).then(() => {
              // 显示复制成功提示
              const originalText = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fa fa-check"></i>';
              copyBtn.classList.add('text-green-500');
              
              setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('text-green-500');
              }, 2000);
            });
          }
        });
      }
    }



    // 断开钱包连接
    async function disconnectWallet() {
      try {
        // 断开Phantom钱包连接
        if (window.solana && window.solana.disconnect) {
          await window.solana.disconnect();
        }
        
        // 清除当前钱包状态
        currentWallet = '';
        currentUserProfile = null;
        
        // 清除用户资料缓存（可选，保留其他用户的资料）
        // userProfiles = {};
        
        // 更新UI状态
        updateWalletUI(false);
        
        // 更新私人页面UI
        updatePrivatePageUI();
        
        // 清除评论监听器
        clearCommentListeners();
        
        // 清除用户资料监听器
        if (window.profileListener) {
          window.profileListener();
          window.profileListener = null;
        }
        
        console.log('钱包已断开连接');
        
        // 显示断开连接成功提示
        showDisconnectSuccessMessage();
        
      } catch (error) {
        console.error('断开钱包连接失败:', error);
        alert('断开连接失败，请稍后重试');
      }
    }

    // 设置断开连接功能
    function setupDisconnectWallet() {
      const walletBtn = document.getElementById('wallet-btn');
      const mobileWalletBtn = document.getElementById('mobile-wallet-btn');
      
      // 为桌面端钱包按钮添加右键菜单
      if (walletBtn) {
        walletBtn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showDisconnectMenu(e, walletBtn);
        });
        
        // 添加长按提示
        walletBtn.title = '右键点击断开连接';
      }
      
      // 为移动端钱包按钮添加长按功能
      if (mobileWalletBtn) {
        let longPressTimer;
        let isLongPress = false;
        
        mobileWalletBtn.addEventListener('touchstart', (e) => {
          longPressTimer = setTimeout(() => {
            isLongPress = true;
            showDisconnectMenu(e, mobileWalletBtn);
          }, 800);
        });
        
        mobileWalletBtn.addEventListener('touchend', () => {
          clearTimeout(longPressTimer);
          setTimeout(() => {
            isLongPress = false;
          }, 100);
        });
        
        mobileWalletBtn.addEventListener('touchmove', () => {
          clearTimeout(longPressTimer);
        });
        
        // 添加长按提示
        mobileWalletBtn.title = '长按断开连接';
      }
    }

    // 显示断开连接菜单
    function showDisconnectMenu(event, button) {
      // 移除已存在的菜单
      const existingMenu = document.getElementById('disconnect-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      // 创建断开连接菜单
      const menu = document.createElement('div');
      menu.id = 'disconnect-menu';
      menu.className = 'fixed z-50 bg-white rounded-lg shadow-lg border border-neutral-200 py-2 min-w-[160px]';
      menu.innerHTML = `
        <button class="w-full px-4 py-2 text-left text-red-600 hover:bg-red-50 transition-colors flex items-center">
          <i class="fa fa-sign-out mr-2"></i>
          断开连接
        </button>
      `;
      
      // 添加断开连接事件
      const disconnectBtn = menu.querySelector('button');
      disconnectBtn.addEventListener('click', () => {
        disconnectWallet();
        menu.remove();
      });
      
      // 定位菜单
      const rect = button.getBoundingClientRect();
      menu.style.left = `${rect.left}px`;
      menu.style.top = `${rect.bottom + 5}px`;
      
      // 添加到页面
      document.body.appendChild(menu);
      
      // 点击外部关闭菜单
      const closeMenu = (e) => {
        if (!menu.contains(e.target) && !button.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      };
      
      // 延迟添加事件监听，避免立即触发
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
      }, 100);
    }

    // 显示断开连接成功消息
    function showDisconnectSuccessMessage() {
      // 创建成功提示
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full';
      message.innerHTML = `
        <div class="flex items-center">
          <i class="fa fa-check-circle mr-2"></i>
          <span>钱包已断开连接</span>
        </div>
      `;
      
      document.body.appendChild(message);
      
      // 显示动画
      setTimeout(() => {
        message.classList.remove('translate-x-full');
      }, 100);
      
      // 自动隐藏
      setTimeout(() => {
        message.classList.add('translate-x-full');
        setTimeout(() => {
          message.remove();
        }, 300);
      }, 3000);
    }

    // 清除评论监听器
    function clearCommentListeners() {
      if (window.commentListeners) {
        Object.values(window.commentListeners).forEach(unsubscribe => {
          if (typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
        window.commentListeners = {};
      }
    }

    // 初始化个人资料功能
    function setupProfileFeatures() {
      // 个人资料按钮点击事件
      const profileBtn = document.getElementById('profile-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', () => showProfileModal(false)); // 传递false表示非首次设置
      }
      
      // 手机端个人资料按钮点击事件
      const mobileProfileBtn = document.getElementById('mobile-profile-btn');
      if (mobileProfileBtn) {
        mobileProfileBtn.addEventListener('click', () => {
          showProfileModal(false);
          // 关闭手机端菜单
          const mobileMenu = document.getElementById('mobile-menu');
          if (mobileMenu) {
            mobileMenu.classList.add('hidden');
          }
        });
      }

      // 关闭个人资料弹窗
      const closeProfileModal = document.getElementById('close-profile-modal');
      const cancelProfileBtn = document.getElementById('cancel-profile-btn');
      if (closeProfileModal) {
        closeProfileModal.addEventListener('click', hideProfileModal);
      }
      if (cancelProfileBtn) {
        cancelProfileBtn.addEventListener('click', hideProfileModal);
      }

      // 点击弹窗外部关闭
      const profileModal = document.getElementById('profile-modal');
      if (profileModal) {
        profileModal.addEventListener('click', (e) => {
          if (e.target === profileModal) {
            hideProfileModal();
          }
        });
      }

      // 关闭用户资料查看弹窗
      const closeUserProfileViewModal = document.getElementById('close-user-profile-view-modal');
      const closeUserProfileViewBtn = document.getElementById('close-user-profile-view-btn');
      if (closeUserProfileViewModal) {
        closeUserProfileViewModal.addEventListener('click', hideUserProfileViewModal);
      }
      if (closeUserProfileViewBtn) {
        closeUserProfileViewBtn.addEventListener('click', hideUserProfileViewModal);
      }

      // 点击用户资料查看弹窗外部关闭
      const userProfileViewModal = document.getElementById('user-profile-view-modal');
      if (userProfileViewModal) {
        userProfileViewModal.addEventListener('click', (e) => {
          if (e.target === userProfileViewModal) {
            hideUserProfileViewModal();
          }
        });
      }

      // 个人简介字数统计
      const bioInput = document.getElementById('profile-bio');
      if (bioInput) {
        bioInput.addEventListener('input', updateBioCharCount);
      }

      // 头像上传
      setupAvatarUpload();

      // 复制钱包地址
      setupCopyWallet();

      // 个人资料表单提交
      const profileForm = document.getElementById('profile-form');
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('profile-username').value.trim();
          const bio = document.getElementById('profile-bio').value.trim();
          const avatarPreview = document.getElementById('avatar-preview');
          
          if (!username) {
            alert('请输入用户名');
            return;
          }

          // 获取头像数据
          let avatar = null;
          const avatarImg = avatarPreview.querySelector('img');
          if (avatarImg) {
            avatar = avatarImg.src;
          }

          const profileData = {
            username,
            bio,
            avatar
          };

          const success = await saveUserProfile(profileData);
          if (success) {
            hideProfileModal();
            alert('个人资料保存成功！');
            
            // 重新渲染日记和评论以显示新的用户名和头像
            renderPublicDiaries();
            renderFeaturedDiaries();
            if (currentWallet) {
              loadPrivateDiaries();
            }
          }
        });
      }
    }

    // 初始化评论功能
    function initializeComments(diaryId) {
      // 加载现有评论
      loadComments(diaryId);
      
      // 设置评论输入监听
      setupCommentInput(diaryId);
      
      // 监听新评论
      listenToComments(diaryId);
      
      // 防止聊天区域滚动事件冒泡
      const commentsContainer = document.getElementById(`comments-list-${diaryId}`);
      if (commentsContainer) {
        commentsContainer.addEventListener('wheel', (e) => {
          e.stopPropagation();
        });
        
        commentsContainer.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        });
      }
    }

    // 加载评论
    async function loadComments(diaryId) {
      const commentsList = document.getElementById(`comments-list-${diaryId}`);
      const commentCount = document.getElementById('comment-count');
      
      if (!commentsList) return;
      
      try {
        // 显示加载状态
        commentsList.innerHTML = `
          <div class="comment-loading">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            加载评论中...
          </div>
        `;
        
        // 从Firebase获取评论
        const commentsRef = ref(db, `comments/${diaryId}`);
        const snapshot = await get(commentsRef);
        const comments = snapshot.val() || {};
        
        // 渲染评论
        renderComments(diaryId, comments);
        
        // 更新评论数量
        const commentCountNum = Object.keys(comments).length;
        if (commentCount) {
          commentCount.textContent = `${commentCountNum} 条留言`;
        }
      } catch (error) {
        console.error('加载评论失败:', error);
        commentsList.innerHTML = `
          <div class="text-center text-red-500 py-8">
            <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
            <p>加载评论失败，请稍后重试</p>
          </div>
        `;
      }
    }

    // 渲染评论列表
    function renderComments(diaryId, comments) {
      const commentsList = document.getElementById(`comments-list-${diaryId}`);
      const commentCount = document.getElementById('comment-count');
      
      if (!commentsList) return;
      
      const commentEntries = Object.entries(comments);
      
      if (commentEntries.length === 0) {
        commentsList.innerHTML = `
          <div class="text-center text-neutral-500 py-8">
            <i class="fa fa-comment-o text-2xl mb-2"></i>
            <p>暂无留言，成为第一个留言的人吧！</p>
          </div>
        `;
        if (commentCount) commentCount.textContent = '0 条留言';
        return;
      }
      
      // 按时间排序
      const sortedComments = commentEntries
        .map(([id, comment]) => ({ id, ...comment }))
        .sort((a, b) => a.timestamp - b.timestamp);
      
      const commentsHtml = sortedComments.map(comment => {
        const userAvatar = getUserAvatar(comment.authorWallet);
        const avatarHtml = userAvatar 
          ? `<img src="${userAvatar}" alt="头像" class="w-full h-full object-cover rounded-full">`
          : comment.author.charAt(0).toUpperCase();
        
        return `
          <div class="comment-item">
            <div class="comment-header">
              <div class="comment-author">
                <div class="comment-avatar cursor-pointer hover:opacity-80 transition-opacity" onclick="viewUserProfile('${comment.authorWallet}')">
                  ${avatarHtml}
                </div>
                <div class="comment-meta">
                  <div class="comment-author-name cursor-pointer hover:text-primary transition-colors" onclick="viewUserProfile('${comment.authorWallet}')">${comment.author}</div>
                  <div class="comment-time">${formatDate(comment.timestamp)}</div>
                </div>
              </div>
            </div>
            <div class="comment-content">${escapeHtml(comment.content)}</div>
          </div>
        `;
      }).join('');
      
      commentsList.innerHTML = commentsHtml;
      
      // 更新评论数量
      if (commentCount) {
        commentCount.textContent = `${commentEntries.length} 条留言`;
      }
      
      // 滚动到底部
      setTimeout(() => {
        commentsList.scrollTop = commentsList.scrollHeight;
      }, 100);
    }

    // 设置评论输入监听
    function setupCommentInput(diaryId) {
      const commentInput = document.getElementById(`comment-input-${diaryId}`);
      const sendButton = document.getElementById(`send-comment-${diaryId}`);
      
      if (!commentInput || !sendButton) return;
      
      // 输入监听
      commentInput.addEventListener('input', function() {
        const hasContent = this.value.trim().length > 0;
        sendButton.disabled = !hasContent;
      });
      
      // 发送按钮点击
      sendButton.addEventListener('click', () => {
        sendComment(diaryId);
      });
      
      // 回车发送
      commentInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendButton.disabled) {
            sendComment(diaryId);
          }
        }
      });
    }

    // 发送评论
    async function sendComment(diaryId) {
      const commentInput = document.getElementById(`comment-input-${diaryId}`);
      const sendButton = document.getElementById(`send-comment-${diaryId}`);
      
      if (!commentInput || !sendButton || !currentWallet) return;
      
      const content = commentInput.value.trim();
      if (!content) return;
      
      try {
        // 禁用输入
        commentInput.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>发送中...';
        
        // 创建评论数据
        const comment = {
          content: content,
          author: getUserDisplayName(currentWallet),
          authorWallet: currentWallet,
          timestamp: Date.now()
        };
        
        // 保存到Firebase
        const commentsRef = ref(db, `comments/${diaryId}`);
        await push(commentsRef, comment);
        
        // 清空输入框
        commentInput.value = '';
        commentInput.disabled = false;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送';
        
        // 聚焦输入框
        commentInput.focus();
        
      } catch (error) {
        console.error('发送评论失败:', error);
        alert('发送评论失败，请稍后重试');
        
        // 恢复输入状态
        commentInput.disabled = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送';
      }
    }

    // 监听评论变化
    function listenToComments(diaryId) {
      // 移除之前的监听器
      if (commentListeners[diaryId]) {
        commentListeners[diaryId]();
        delete commentListeners[diaryId];
      }
      
      // 设置新的监听器
      const commentsRef = ref(db, `comments/${diaryId}`);
      const unsubscribe = onValue(commentsRef, (snapshot) => {
        const comments = snapshot.val() || {};
        renderComments(diaryId, comments);
        
        // 更新日记卡片上的评论数量
        updateDiaryCardCommentCount(diaryId, Object.keys(comments).length);
      });
      
      commentListeners[diaryId] = unsubscribe;
    }

    // 更新日记卡片上的评论数量
    function updateDiaryCardCommentCount(diaryId, count) {
      const commentCountElement = document.querySelector(`.comment-count-${diaryId}`);
      if (commentCountElement) {
        commentCountElement.textContent = count;
      }
    }

    // 加载所有日记的评论数量
    async function loadAllCommentCounts(diaries) {
      for (const diary of diaries) {
        try {
          const commentsRef = ref(db, `comments/${diary.id}`);
          const snapshot = await get(commentsRef);
          const comments = snapshot.val() || {};
          const count = Object.keys(comments).length;
          updateDiaryCardCommentCount(diary.id, count);
        } catch (error) {
          console.error(`加载日记 ${diary.id} 的评论数量失败:`, error);
          updateDiaryCardCommentCount(diary.id, 0);
        }
      }
    }

    // 点赞功能
    async function toggleLike(diaryId) {
      if (!currentWallet) {
        alert('请先连接钱包');
        return;
      }

      try {
        const diaryRef = ref(db, `diaryEntries/${diaryId}`);
        const snapshot = await get(diaryRef);
        const diary = snapshot.val();
        
        if (!diary) {
          console.error('日记不存在');
          return;
        }

        // 初始化likedBy对象
        if (!diary.likedBy) {
          diary.likedBy = {};
        }

        const isLiked = diary.likedBy[currentWallet];
        
        if (isLiked) {
          // 取消点赞
          delete diary.likedBy[currentWallet];
        } else {
          // 添加点赞
          diary.likedBy[currentWallet] = Date.now();
        }

        // 更新数据库
        await update(ref(db, `diaryEntries/${diaryId}`), {
          likedBy: diary.likedBy
        });

        // 更新UI
        updateLikeUI(diaryId, diary.likedBy);
        
        // 重新排序日记列表
        await reorderDiariesByLikes(diaryId);

      } catch (error) {
        console.error('点赞操作失败:', error);
        alert('点赞失败，请稍后重试');
      }
    }

    // 更新点赞UI
    function updateLikeUI(diaryId, likedBy) {
      const likeCount = likedBy ? Object.keys(likedBy).length : 0;
      const isLiked = likedBy && likedBy[currentWallet];

      // 更新日记卡片上的点赞按钮
      const likeBtn = document.querySelector(`.like-btn[data-diary-id="${diaryId}"]`);
      if (likeBtn) {
        const icon = likeBtn.querySelector('i');
        const countSpan = likeBtn.querySelector(`.like-count-${diaryId}`);
        
        icon.className = `fa ${isLiked ? 'fa-heart text-red-500' : 'fa-heart-o'} mr-1`;
        if (countSpan) countSpan.textContent = likeCount;
        
        likeBtn.setAttribute('data-liked', isLiked.toString());
        likeBtn.classList.toggle('liked', isLiked);
      }

      // 更新弹窗中的点赞按钮
      const modalLikeBtn = document.querySelector(`.modal-like-btn[data-diary-id="${diaryId}"]`);
      if (modalLikeBtn) {
        const icon = modalLikeBtn.querySelector('i');
        const countSpan = modalLikeBtn.querySelector(`.modal-like-count-${diaryId}`);
        
        icon.className = `fa ${isLiked ? 'fa-heart text-red-500' : 'fa-heart-o text-neutral-500'} mr-2`;
        if (countSpan) countSpan.textContent = likeCount;
        
        modalLikeBtn.setAttribute('data-liked', isLiked.toString());
        modalLikeBtn.classList.toggle('liked', isLiked);
      }
    }

    // 根据点赞数重新排序日记
    async function reorderDiariesByLikes(diaryId) {
      try {
        // 更新当前日记的点赞数
        const currentDiary = allDiaries.find(d => d.id === diaryId);
        if (currentDiary) {
          currentDiary.likeCount = currentDiary.likedBy ? Object.keys(currentDiary.likedBy).length : 0;
        }

        // 重新排序allDiaries数组
        allDiaries.sort((a, b) => {
          // 首先按点赞数降序排序
          if (b.likeCount !== a.likeCount) {
            return b.likeCount - a.likeCount;
          }
          // 点赞数相同时按时间倒序排序
          return b.timestamp - a.timestamp;
        });
        
        // 重新渲染公共日记
        renderPublicDiaries();
        
        // 重新渲染精选日记
        renderFeaturedDiaries();
        
      } catch (error) {
        console.error('重新排序日记失败:', error);
      }
    }

    // 初始化点赞按钮
    function initializeLikeButtons(diaryId) {
      // 为弹窗中的点赞按钮添加事件监听
      const modalLikeBtn = document.querySelector(`.modal-like-btn[data-diary-id="${diaryId}"]`);
      if (modalLikeBtn) {
        modalLikeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleLike(diaryId);
        });
      }
    }

    // 为日记卡片添加点赞事件监听
    function setupDiaryCardLikeButtons() {
      document.addEventListener('click', (e) => {
        if (e.target.closest('.like-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const likeBtn = e.target.closest('.like-btn');
          const diaryId = likeBtn.getAttribute('data-diary-id');
          if (diaryId) {
            toggleLike(diaryId);
          }
        }
        
        // 精选日记卡片点击事件
        if (e.target.closest('.featured-diary-card')) {
          e.preventDefault();
          e.stopPropagation();
          const featuredCard = e.target.closest('.featured-diary-card');
          const diaryId = featuredCard.getAttribute('data-diary-id');
          if (diaryId) {
            const diary = allDiaries.find(d => d.id === diaryId);
            if (diary) {
              showDiaryModal(diary);
            }
          }
        }
      });
    }

    // 精选日记功能
    function renderFeaturedDiaries() {
      const container = document.getElementById('featured-diaries-grid');
      if (!container) return;

      // 获取点赞数最高的3个公开日记
      const publicDiaries = allDiaries.filter(d => d.public !== false);
      const topDiaries = publicDiaries
        .sort((a, b) => {
          const aLikes = a.likedBy ? Object.keys(a.likedBy).length : 0;
          const bLikes = b.likedBy ? Object.keys(b.likedBy).length : 0;
          return bLikes - aLikes;
        })
        .slice(0, 3);

      if (topDiaries.length === 0) {
        container.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
            <i class="fa fa-book-o text-neutral-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-medium text-neutral-600 mb-2">暂无精选日记</h3>
            <p class="text-neutral-500">等待社区成员分享精彩内容</p>
          </div>
        `;
        return;
      }

      const featuredHtml = topDiaries.map((diary, index) => {
        const rank = index + 1;
        const likeCount = diary.likedBy ? Object.keys(diary.likedBy).length : 0;
        const preview = diary.content.length > 100 ? diary.content.substring(0, 100) + '...' : diary.content;
        const author = getUserDisplayName(diary.wallet);
        
        return `
          <div class="featured-diary-card rank-${rank}" data-diary-id="${diary.id}">
            <div class="featured-rank-badge rank-${rank}">
              ${rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉'}
            </div>
            
            <div class="featured-diary-author">
              <div class="featured-diary-avatar cursor-pointer hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">
                ${(() => {
                  const userAvatar = getUserAvatar(diary.wallet);
                  return userAvatar 
                    ? `<img src="${userAvatar}" alt="头像" class="w-full h-full object-cover rounded-full">`
                    : author.charAt(0).toUpperCase();
                })()}
              </div>
              <div class="featured-diary-author-info">
                <div class="featured-diary-author-name cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); viewUserProfile('${diary.wallet}')">${author}</div>
                <div class="featured-diary-time">${formatDate(diary.timestamp)}</div>
              </div>
            </div>
            
            <h3 class="featured-diary-title">${escapeHtml(diary.title || '无标题')}</h3>
            <p class="featured-diary-content">${escapeHtml(preview)}</p>
            
            <div class="featured-diary-meta">
              <div class="featured-diary-stats">
                <div class="featured-diary-stat likes">
                  <i class="fa fa-heart"></i>
                  <span>${likeCount}</span>
                </div>
                <div class="featured-diary-stat comments">
                  <i class="fa fa-comment"></i>
                  <span class="comment-count-${diary.id}">0</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = featuredHtml;
      
      // 加载评论数量
      loadFeaturedCommentCounts(topDiaries);
    }

    // 加载精选日记的评论数量
    async function loadFeaturedCommentCounts(diaries) {
      for (const diary of diaries) {
        try {
          const commentsRef = ref(db, `comments/${diary.id}`);
          const snapshot = await get(commentsRef);
          const comments = snapshot.val() || {};
          const count = Object.keys(comments).length;
          
          const commentCountElement = document.querySelector(`#featured-diaries-grid .comment-count-${diary.id}`);
          if (commentCountElement) {
            commentCountElement.textContent = count;
          }
        } catch (error) {
          console.error(`加载精选日记 ${diary.id} 的评论数量失败:`, error);
        }
      }
    }

    // 工具函数
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }


    
    // 调试函数
    window.debugUserProfiles = function() {
      console.log('=== 用户资料调试信息 ===');
      console.log('当前钱包地址:', currentWallet);
      console.log('当前用户资料:', currentUserProfile);
      console.log('所有用户资料缓存:', userProfiles);
      console.log('localStorage中的提示状态:', Object.keys(localStorage).filter(key => key.startsWith('profile_prompted_')));
      
      if (currentWallet) {
        console.log('检查Firebase中的用户资料...');
        loadUserProfile(currentWallet).then(profile => {
          console.log('Firebase中的用户资料:', profile);
        });
      }
    };
  </script>
</body>
</html>
    
